=======
title: Msc Thesis: The long-term impact of reef design on herbivorous fish biomass and mean size
author: Jorn de Gelder
date: 19/2/2026
---

# if on MSI laptop (Jorn)
setwd("C:/Users/Jorn de Gelder/Documents/Thesis R")

# Setup
```{r setup}
rm(list=ls()) # Clear workspace
knitr::opts_knit$set(root.dir = '/tmp') #Set directory at current directory for all subsequent chunks
options(scipen = 99) # Have all numbers in non-scientific notation

library(readxl) # Join data frames (vlookup)
library(cowplot) # Combine plots
library(patchwork)
library(data.table)
library(ggthemes) # pretty plots
library(flextable) # Layout word table
library(tidyverse) # Beta regression
library(vegan) # Export Excel
library(gridExtra)
library(emmeans) # Select text from string
library(lme4)
library(lmerTest) # GLS
library(officer) # Move table into word
library(gridGraphics) # Combine base and ggplots
library(tidyxl) # Read in coloured cells Excel
library(openxlsx)
library(car) # glm model validation
library(viridis) # Convert data from wide to long
library(writexl) # Export Excel
library(janitor) # Excel functions
library(arrow) # Write & read Parquet
library(ggpubr) # for checking normality
library(ggeffects) # for visualization
library(ggpattern)
library(ggrepel)
library(glmmTMB) #negative binomial
library(DHARMa) #for checking NB & CMP GLMM
library(robustlmm)
library(multcomp) # for CLD
library(multcompView) # for CLD
library(purrr) # for centroid calc
library(devEMF) # for saving plots
library(pairwiseAdonis) # for nMDS pairwise comparison
```

# Load RAW data (Only need to run after new raw data input: Takes about 30 mins)
```{r data load, warning= FALSE}

# ---- DATA 2017-2022 ----
## Load
### 2017-2018
fishRAW.2018 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2017-2018.xlsm", sheet = 3, skip = 6))
fish.2018 <- fishRAW.2018[!is.na(fishRAW.2018$Species),] # Remove irrelevant row
fish.2018 <- dplyr::select(fish.2018, -c(1, 3:11)) # Remove irrelevant columns
fish.2018$Species <- sub("\\.", "", fish.2018$Species) # Remove points from species names

### 2019
fishRAW.2019 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2019.xlsm", sheet = 3, skip = 6))
fish.2019 <- fishRAW.2019[!is.na(fishRAW.2019$Species),] # Remove irrelevant row
fish.2019 <- dplyr::select(fish.2019, -c(1, 3:11)) # Remove irrelevant columns
fish.2019$Species <- sub("\\.", "", fish.2019$Species) # Remove points from species names

### 2020
fishRAW.2020 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2020.xlsm", sheet = 3, skip = 6))
fish.2020 <- fishRAW.2020[!is.na(fishRAW.2020$Species),] # Remove irrelevant row
fish.2020 <- dplyr::select(fish.2020, -c(1, 3:11)) # Remove irrelevant columns
fish.2020$Species <- sub("\\.", "", fish.2020$Species) # Remove points from species names

### 2021-2022
fishRAW.2021 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2021-2022.xlsm", sheet = 3, skip = 6))
fish.2021 <- fishRAW.2021[!is.na(fishRAW.2021$Species),] # Remove irrelevant row
fish.2021 <- dplyr::select(fish.2021, -c(1, 3:11)) # Remove irrelevant columns
fish.2021$Species <- sub("\\.", "", fish.2021$Species) # Remove points from species names

## Merge all years
fish.2017_2022 <- left_join(fish.2018, fish.2019, by = "Species")
fish.2017_2022 <- left_join(fish.2017_2022, fish.2020, by = "Species")
fish.2017_2022 <- left_join(fish.2017_2022, fish.2021, by = "Species")

## Get rid of the columns not needed (pre-calculated biomasses)
fish.2017_2022 <- fish.2017_2022[, -grep(pattern= 'g_', colnames(fish.2017_2022))]
fish.2017_2022 <- fish.2017_2022[, -grep(pattern='kgha', colnames(fish.2017_2022))]
fish.2017_2022 <- fish.2017_2022[, -grep(pattern='TOT', colnames(fish.2017_2022))]

## Net NAs to 0 
fish.2017_2022[is.na(fish.2017_2022)] <- 0

## Set column names (NB: order of surveys won't match original Excel numbering anymore: start numbering at oldest survey years)
surveys.tot <- (ncol(fish.2017_2022) - 1)/13
colname <- c("Species", paste0(rep(c("1_", "2_", "3_", "4_", "5_", "6_", "7_", "8_", "9_", "10_", "11_", "12_", "Coloured_"),
                                     surveys.tot), rep(1:surveys.tot, each = 13)))
colnames(fish.2017_2022) <- colname

## Here try to sum all 10_ and 11_ and 12_, and add a column with the sum for later
for (i in 1:surveys.tot)
  {
  cols <- paste0(c("10_", "11_", "12_"), i)
  fish.2017_2022[[paste0("11num_", i)]] <- rowSums(fish.2017_2022[, cols])
  
  # Weighted mean column, safely handling sum == 0
  fish.2017_2022[[paste0("11size_", i)]] <- ifelse(
    fish.2017_2022[[paste0("11num_", i)]] == 0,
    0,
    (fish.2017_2022[[paste0("10_", i)]] * 75 +
     fish.2017_2022[[paste0("11_", i)]] * 125 +
     fish.2017_2022[[paste0("12_", i)]] * 175) /
      fish.2017_2022[[paste0("11num_", i)]]
  )
  
  # Reorder columns to place 11num_i and 11size_i after 12_i
  col_order <- names(fish.2017_2022)
  idx_12 <- which(col_order == paste0("12_", i))
  col_order <- append(col_order, c(paste0("11num_", i), paste0("11size_", i)), after = idx_12)
  col_order <- col_order[!duplicated(col_order)]
  fish.2017_2022 <- fish.2017_2022[, col_order]
}

## Go to long format
fish.2017_2022 <- setDT(fish.2017_2022)
fish.2017_2022 <- melt(fish.2017_2022, id.vars = 'Species', variable.name = 'SurveyNo', 
            measure.vars = patterns('^1_', '^2_', '^3_', '^4_', '^5_', '^6_',
                                    '^7_', '^8_', '^9_', '^10_', '^11_', '^12_','^11num_','^11size_', '^Coloured_'),
            value.name = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5',
                           '25', '35', '45', '75', '125', '175','65', 'SizeClass_11', 'Coloured'))
fish.2017_2022$Coloured[fish.2017_2022$Coloured == 0] <- 12 # Set non-coloured value (12) for missing data (new species)
fish.2017_2022$SurveyNo <- as.numeric(fish.2017_2022$SurveyNo)

# Get Size class from wide to long
fish.2017_2022 <- reshape2::melt(fish.2017_2022, id.vars = c('SurveyNo', 'Species', 'Coloured', 'SizeClass_11'), 
          measure.vars = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5', '25', '35', '45', '75', '125', '175','65'),
          variable.name = 'SizeClass', value.name = 'Abundance')

### Update taxonomy for re-named species
fish.2017_2022$Species <- ifelse(fish.2017_2022$Species == "Carangoides ferdau", "Ferdauia ferdau",
                 ifelse(fish.2017_2022$Species == "Carangoides fulvoguttatus", "Turrum fulvoguttatum",       
                 ifelse(fish.2017_2022$Species == "Carangoides orthogrammus", "Ferdauia orthogrammus",       
                 ifelse(fish.2017_2022$Species == "Cetoscarus bicolor", "Cetoscarus ocellatus",       
                 ifelse(fish.2017_2022$Species == "Chromis dimidiata", "Pycnochromis fieldi",       
                 ifelse(fish.2017_2022$Species == "Chromis lepidolepis", "Azurina lepidolepis",       
                 ifelse(fish.2017_2022$Species == "Chromis nigrura", "Pycnochromis nigrurus",       
                 ifelse(fish.2017_2022$Species == "Chromis xutha", "Pycnochromis agilis",       
                 ifelse(fish.2017_2022$Species == "Dascyllus aruanus", "Dascyllus abudafur",       
                 ifelse(fish.2017_2022$Species == "Heteropriacanthus cruentatus", "Heteropriacanthus carolinus",       
                 ifelse(fish.2017_2022$Species == "Neotrygon kuhlii", "Neotrygon indica",       
                 ifelse(fish.2017_2022$Species == "Plectroglyphidodon lacrymatus", "Stegastes lacrymatus",       
                 ifelse(fish.2017_2022$Species == "Pseudanthias evansi", "Mirolabrichthys evansi",       
                 ifelse(fish.2017_2022$Species == "Ulua mentalis", "Atropis mentalis",
                 ifelse(fish.2017_2022$Species == "Unknown parrotfish", "Scarus sp",
                 ifelse(fish.2017_2022$Species == "Pomacentrus aquilus", "Chrysiptera sp", 
                 ifelse(fish.2017_2022$Species == "Pomacentrus philippinus", "Neopomacentrus cyanomos", 
                 ifelse(fish.2017_2022$Species == "Pempheris nesogallica", "Pempheris sp", 
                 ifelse(fish.2017_2022$Species == "Upeneus tragula", "Upeneus heemstra",                         
                        fish.2017_2022$Species)))))))))))))))))))
fish.2017_2022 <- subset(fish.2017_2022, Species != "NEW SPECIES")

# Pomacentrus aquilus & phillipinus as well as Pempheris nesogallica are special cases, because they have to get merged with an already existing entry, being probably misidentified earlier. First we determine whether to add up the counts, based on if and when they were observed.
# Target species
target_species <- c("Chrysiptera sp", "Neopomacentrus cyanomos", "Pempheris sp")

fish.2017_2022 <- fish.2017_2022 %>%
  # Step 1: calculate sum11 and sum12 for each species per SurveyNo
  group_by(SurveyNo, Species) %>%
  mutate(
    sum11 = if_else(Species %in% target_species,
                    sum(Abundance[Coloured == 11], na.rm = TRUE),
                    NA_real_),
    sum12 = if_else(Species %in% target_species,
                    sum(Abundance[Coloured == 12], na.rm = TRUE),
                    NA_real_)
  ) %>%
  ungroup() %>%
  
  # Step 2: filter rows according to the same rules as before
  filter(
    !(Species %in% target_species & (
        (sum11 > 0 & sum12 > 0 & Coloured == 11) |
        (sum11 > 0 & sum12 == 0 & Coloured == 12) |
        (sum11 == 0 & sum12 > 0 & Coloured == 11) |
        (sum11 == 0 & sum12 == 0 & Coloured == 11)
      ))
  ) %>%
  dplyr::select(-sum11, -sum12) %>%
  
  # Step 3: combine abundances for duplicate SizeClass rows within target species
  group_by(SurveyNo, Species, SizeClass) %>%
  mutate(
    Abundance = if_else(Species %in% target_species, sum(Abundance, na.rm = TRUE), Abundance)
  ) %>%
  filter(!(Species %in% target_species & duplicated(SizeClass))) %>%
  ungroup()

# ==== Meta data 2017-2022 ====
## Load
meta.2018 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2017-2018.xlsm", sheet = "Data")) # 2018
meta.2019 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2019.xlsm", sheet = "Data")) # 2019 
meta.2020 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2020.xlsm", sheet = "Data")) # 2020
meta.2021 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2021-2022.xlsm", sheet = "Data")) # 2021 
meta.2021 <- meta.2021[!is.na(meta.2021$Date),] # Remove empty rows

## Merge years
meta.2017_2022 <- rbind(meta.2018, meta.2019, meta.2020, meta.2021)

## Clean up
meta.2017_2022$SurveyNo <- as.numeric(seq(1, surveys.tot, by = 1))
meta.2017_2022 <- meta.2017_2022[,c("SurveyNo", "Date", "Location", "Transect", "Observer", "Radius", "Area", "Comments")] # Select columns

## Add meta data to main dataframe
fish.2017_2022 <- merge(fish.2017_2022, meta.2017_2022, all.x=T, by='SurveyNo')

# ==== Species information ====
## Load and clean
specieslist <- as.data.frame(read_excel("Raw data/SpeciesList_2025-11.xlsx", sheet = "SpeciesList"))
specieslist$Species <- sub("\\.", "", specieslist$Species) # Remove points from species names
specieslist <- dplyr::select(specieslist, c("Species", "Diet", "DietH", "a", "b"))

## Add species data to main dataframe
fish.2017_2022 <- merge(fish.2017_2022, specieslist, all.x=T, by='Species')

# ==== Calculate biomass ====
# Make all rows numeric for biomass calculations & remove duplicates for Sizeclass 11
fish.2017_2022$SizeClass <- as.numeric(as.character(fish.2017_2022$SizeClass))
fish.2017_2022$SizeClass_11 <- ifelse(fish.2017_2022$SizeClass == 65, fish.2017_2022$SizeClass_11, 0)

# Select all rows where SizeClass is 65 (Class 11-proxy)
temp_df <- fish.2017_2022[fish.2017_2022$SizeClass %in% c("65"), ]

# Remove these rows from the original dataframe
fish.2017_2022 <- fish.2017_2022[!fish.2017_2022$SizeClass %in% c("65"), ]

## Calculate biomass using the length-weight formula W = a * L^b, multiply per abundance and standardize to kg/ha
fish.2017_2022$Biomass_kgha <- ((((fish.2017_2022$a * (fish.2017_2022$SizeClass ^ fish.2017_2022$b)) * fish.2017_2022$Abundance)/ fish.2017_2022$Area)/1000)* 10000

## Standardize abundance
fish.2017_2022$Abundance_m2 <- fish.2017_2022$Abundance/fish.2017_2022$Area

# Standardize abundance for the temporary file with sizeclass 11
temp_df$Abundance_m2 <-temp_df$Abundance/temp_df$Area

# Calculate biomass for sizeclass 11
biomass_sum <- fish.2017_2022 %>%
  filter(SizeClass %in% c(75, 125, 175)) %>%
  group_by(SurveyNo, Species) %>%
  summarise(total_biomass = sum(Biomass_kgha, na.rm = TRUE), .groups = "drop")

# Join biomass_sum to temp_df by SurveyNo and Species
temp_df <- temp_df %>%
  left_join(biomass_sum, by = c("SurveyNo", "Species"))

# Rename the summed column to Biomass_kgha
temp_df <- temp_df %>%
  rename(Biomass_kgha = total_biomass)

#Add the temporary dataframe back to the original dataframe
fish.2017_2022 <- bind_rows(fish.2017_2022, temp_df)
rm(temp_df)

# Considering there is no class 10 in the old system, we use the removable class 75 to become 55.
fish.2017_2022$SizeClass[fish.2017_2022$SizeClass == "75"] <- "55"
fish.2017_2022$Abundance[fish.2017_2022$SizeClass == "55"] <- 0
fish.2017_2022$Abundance_m2[fish.2017_2022$SizeClass == "55"] <- 0
fish.2017_2022$Biomass_kgha[fish.2017_2022$SizeClass == "55"] <- 0
fish.2017_2022$SizeClass_11[fish.2017_2022$SizeClass == "55"] <- 0

# Remove rows where SizeClass is 125, or 175 (75 has been used to make missing 55 (Class 10) row)
fish.2017_2022 <- fish.2017_2022 %>%
  filter(!SizeClass %in% c("125", "175"))

## Cleanup
fish.2017_2022 <- dplyr::select(fish.2017_2022, - c("a", "b"))

# ---- DATA 2023-2025 ----
# ---2023-2024---
# Get raw data and formats
fishRaw.2023 <- xlsx_cells("Raw data/Fish surveys_DATABASE_2023-2024_0.xlsx") # Includes all sheets and styles
fish.2023 <- subset(fishRaw.2023, sheet == "INPUT Sheet") # Data including both Non & Instantaneous observations)
fish.2023format <- xlsx_formats("Raw data/Fish surveys_DATABASE_2023-2024_0.xlsx") # Formats of all sheets

# Identify non-instantaneous data
## Identify coloured cells
Fish.2023_ColouredCells <- fish.2023 %>% 
  filter(local_format_id %in% which(!is.na(fish.2023format$local$fill$patternFill$fgColor$rgb))) %>%
  dplyr::select(address, row, col, data_type)
## Label them 12 (instantaneous) or 11 (non-instantaneous)
fish.2023$Coloured <- ifelse(fish.2023$address %in% Fish.2023_ColouredCells$address, 11, 12)

## Tidy data
fish.2023 <- subset(fish.2023, row > 2) # Remove first two rows row (survey number & size classes)
fish.2023 <- dplyr::select(fish.2023, c("row", "col", "character", "numeric", "Coloured")) # Select relevant columns
Fish.2023_speciesList <- na.omit(fish.2023$character) # Save species list for later use
fish.2023 <- dplyr::select(fish.2023, -c("character")) # Remove species column
fish.2023 <- subset(fish.2023, col > 1) # Remove species column values
fish.2023$row <- fish.2023$row - 2 # Renumber rows to start at 1
fish.2023$col <- fish.2023$col - 1 # Renumber columns to start at 1

# To wide format
fish.2023 <- as.data.frame(fish.2023) # Go from tibble back to dataframe
fish.2023 <- reshape(fish.2023, idvar = c("row"), timevar = "col", direction = "wide") # To wide format (takes 2 mins)

# Set column names
fish.2023_surveys.tot <- (ncol(fish.2023) - 1)/24
fish.2023_colname <- c("Species", paste0(rep(c("c1_", "Coloured_c1_", "c2_", "Coloured_c2_", "c3_", "Coloured_c3_", "c4_", "Coloured_c4_", "c5_", "Coloured_c5_", "c6_", "Coloured_c6_", "c7_", "Coloured_c7_", "c8_", "Coloured_c8_", "c9_", "Coloured_c9_", "c10_", "Coloured_c10_", "c11num_", "Coloured_c11num_", "c11size_", "Coloured_c11size_"), fish.2023_surveys.tot), rep(1:fish.2023_surveys.tot, each = 24)))
colnames(fish.2023) <- fish.2023_colname

# To long format
fish.2023 <- setDT(fish.2023)
fish.2023 <- melt(fish.2023, 
            id.vars = 'Species', variable.name = 'SurveyNo', 
            measure.vars = patterns('^c1_', "Coloured_c1_", '^c2_', "Coloured_c2_", '^c3_', "Coloured_c3_", '^c4_', "Coloured_c4_", '^c5_', "Coloured_c5_", '^c6_', "Coloured_c6_", '^c7_', "Coloured_c7_", '^c8_', "Coloured_c8_", '^c9_', "Coloured_c9_", '^c10_', "Coloured_c10_", '^c11num_', "Coloured_c11num_", '^c11size_', "Coloured_c11size_"),
            value.name = c('1.25', 'Coloured_1.25', '3.75', 'Coloured_3.75', '6.25', 'Coloured_6.25', '8.75', 'Coloured_8.75', '12.5', 'Coloured_12.5', '17.5',  'Coloured_17.5', '25', 'Coloured_25', '35', 'Coloured_35', '45', 'Coloured_45', '55', 'Coloured_55',  '65',  'Coloured_65', 'SizeClass_11',  'Coloured_SizeClass_11'))

# Check & summarize if any of the size classes had a coloured cell
fish.2023$Coloured <- ifelse(fish.2023$Coloured_1.25 + fish.2023$Coloured_3.75 + fish.2023$Coloured_6.25 + fish.2023$Coloured_8.75 + fish.2023$Coloured_12.5 + fish.2023$Coloured_17.5 + fish.2023$Coloured_25 + fish.2023$Coloured_35 + fish.2023$Coloured_45 + fish.2023$Coloured_55 + fish.2023$Coloured_65 + fish.2023$Coloured_SizeClass_11 == 144, 12, 11)
fish.2023 <- dplyr::select(fish.2023, -c("Coloured_1.25", "Coloured_3.75", "Coloured_6.25", "Coloured_8.75", "Coloured_12.5", "Coloured_17.5", "Coloured_25", "Coloured_35", "Coloured_45", "Coloured_55", "Coloured_65", "Coloured_SizeClass_11"))

# Get Size class from wide to long
fish.2023 <- reshape2::melt(fish.2023, id.vars = c('SurveyNo', 'Species', 'Coloured', 'SizeClass_11'), 
          measure.vars = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5', '25', '35', '45', '55', '65'),
          variable.name = 'SizeClass', value.name = 'Abundance')

#Remove duplicates in SizeClass 65 (Class 11-proxy)
fish.2023$SizeClass_11 <- ifelse(fish.2023$SizeClass == 65, fish.2023$SizeClass_11, 0)

# ==== Add meta data ====
## Re-add species names in data frame
fish.2023$Species <- Fish.2023_speciesList # Added based on original order (!)
fish.2023$Species <- sub("\\.", "", fish.2023$Species) # Remove points from species names

### Update taxonomy for re-named or previously misidentified species
fish.2023$Species <-   ifelse(fish.2023$Species == "Pycnochromis dimidiatus", "Pycnochromis fieldi",
                       ifelse(fish.2023$Species == "Upeneus tragula", "Upeneus heemstra",
                              fish.2023$Species))

## Species metadata
fish.2023 <- merge(fish.2023, specieslist, all.x=T, by='Species') # Combine data and specieslist data frames
fish.2023$SizeClass <- as.numeric(paste(fish.2023$SizeClass)) # Set a numeric Length

## Add survey info
meta.2023 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2023-2024_0.xlsx", sheet = "Data")) 
meta.2023 <- meta.2023[!is.na(meta.2023$Date),] # Remove empty rows
colnames(meta.2023)[1] <- "SurveyNo" 
meta.2023 <- meta.2023[,c("SurveyNo", "Date", "Location", "Transect", "Observer", "Radius", "Area", "Comments")] # Select relevant columns
fish.2023 <- merge(fish.2023, meta.2023, all.x=T, by='SurveyNo')

# ==== Calculate biomass ====
## Size class 65 serves as a proxy for the largest class, the actual size is taken from the SizeClass_11 variable
fish.2023$Biomass_kgha <- ifelse(
  fish.2023$SizeClass == 65,
  ((((fish.2023$a * (fish.2023$SizeClass_11 ^ fish.2023$b)) *
      fish.2023$Abundance) / fish.2023$Area) / 1000) * 10000,
  ((((fish.2023$a * (fish.2023$SizeClass ^ fish.2023$b)) *
      fish.2023$Abundance) / fish.2023$Area) / 1000) * 10000
)

## Standardize abundance
fish.2023$Abundance_m2 <- fish.2023$Abundance/fish.2023$Area

## Cleanup
fish.2023 <- dplyr::select(fish.2023, - c("a", "b"))
fish.2023 <- fish.2023 %>% drop_na(Abundance_m2) # Drop empty rows for surveys not yet done

# ---2024-2025---
# Change empty cells into zeros (needed to correctly read in the data in consecutive steps)
## Read observation block only (starting from row 3, column 2)
input_file <- "Raw data/Fish surveys_DATABASE_2024-2025 (2025-05).xlsx"   # your original, styled file
raw_obs <- read_excel(input_file, sheet = "INPUT Sheet", col_names = FALSE) # Takes ~2 mins
obs_block <- raw_obs[-c(1, 2), -1, drop = FALSE]  # remove first two rows and first column
obs_block <- as.data.frame(obs_block, stringsAsFactors = FALSE)

# Step 2: Clean observation block (convert to numeric, replace blanks with 0)
obs_block[] <- lapply(obs_block, function(col) {
  col[col == ""] <- NA
  suppressWarnings(as.numeric(replace(col, is.na(col), 0)))
})

# Step 3: Load the workbook with formatting intact
wb <- loadWorkbook(input_file) # Takes a few minutes

# Step 4: Write cleaned values into the same cells (preserving formatting)
writeData(
  wb, 
  sheet = "INPUT Sheet", 
  x = obs_block, 
  startRow = 3, 
  startCol = 2, 
  colNames = FALSE
)

## Step 5: Save updated file
saveWorkbook(wb, "Raw data/Fish surveys_DATABASE_2024-2025 (2025-05)_0.xlsx", overwrite = TRUE)

# Get raw data and formats
fishRaw.2024 <- xlsx_cells("Raw data/Fish surveys_DATABASE_2024-2025 (2025-05)_0.xlsx") # Includes all sheets and styles
fish.2024 <- subset(fishRaw.2024, sheet == "INPUT Sheet") # Data including both Non & Instantaneous observations)
fish.2024format <- xlsx_formats("Raw data/Fish surveys_DATABASE_2024-2025 (2025-05)_0.xlsx") # Formats of all sheets

# Identify non-instantaneous data
## Identify coloured cells
Fish.2024_ColouredCells <- fish.2024 %>% 
  filter(local_format_id %in% which(!is.na(fish.2024format$local$fill$patternFill$fgColor$rgb))) %>%
  dplyr::select(address, row, col, data_type)
## Label them 12 (instantaneous) or 11 (non-instantaneous)
fish.2024$Coloured <- ifelse(fish.2024$address %in% Fish.2024_ColouredCells$address, 11, 12)

## Tidy data
fish.2024 <- subset(fish.2024, row > 2) # Remove first two rows row (survey number & size classes)
fish.2024 <- dplyr::select(fish.2024, c("row", "col", "character", "numeric", "Coloured")) # Select relevant columns
Fish.2024_speciesList <- na.omit(fish.2024$character) # Save species list for later use
fish.2024 <- dplyr::select(fish.2024, -c("character")) # Remove species column
fish.2024 <- subset(fish.2024, col > 1) # Remove species column values
fish.2024$row <- fish.2024$row - 2 # Renumber rows to start at 1
fish.2024$col <- fish.2024$col - 1 # Renumber columns to start at 1

# To wide format
fish.2024 <- as.data.frame(fish.2024) # Go from tibble back to dataframe
fish.2024 <- reshape(fish.2024, idvar = c("row"), timevar = "col", direction = "wide") # To wide format (takes 2 mins)

# Set column names
fish.2024_surveys.tot <- (ncol(fish.2024) - 1)/24
fish.2024_colname <- c("Species", paste0(rep(c("c1_", "Coloured_c1_", "c2_", "Coloured_c2_", "c3_", "Coloured_c3_", "c4_", "Coloured_c4_", "c5_", "Coloured_c5_", "c6_", "Coloured_c6_", "c7_", "Coloured_c7_", "c8_", "Coloured_c8_", "c9_", "Coloured_c9_", "c10_", "Coloured_c10_", "c11num_", "Coloured_c11num_", "c11size_", "Coloured_c11size_"), fish.2024_surveys.tot), rep(1:fish.2024_surveys.tot, each = 24)))
colnames(fish.2024) <- fish.2024_colname

# To long format
fish.2024 <- setDT(fish.2024)
fish.2024 <- melt(fish.2024, 
            id.vars = 'Species', variable.name = 'SurveyNo', 
            measure.vars = patterns('^c1_', "Coloured_c1_", '^c2_', "Coloured_c2_", '^c3_', "Coloured_c3_", '^c4_', "Coloured_c4_", '^c5_', "Coloured_c5_", '^c6_', "Coloured_c6_", '^c7_', "Coloured_c7_", '^c8_', "Coloured_c8_", '^c9_', "Coloured_c9_", '^c10_', "Coloured_c10_", '^c11num_', "Coloured_c11num_", '^c11size_', "Coloured_c11size_"),
            value.name = c('1.25', 'Coloured_1.25', '3.75', 'Coloured_3.75', '6.25', 'Coloured_6.25', '8.75', 'Coloured_8.75', '12.5', 'Coloured_12.5', '17.5',  'Coloured_17.5', '25', 'Coloured_25', '35', 'Coloured_35', '45', 'Coloured_45', '55', 'Coloured_55',  '65',  'Coloured_65', 'SizeClass_11',  'Coloured_SizeClass_11'))

# Check & summarize if any of the size classes had a coloured cell
fish.2024$Coloured <- ifelse(fish.2024$Coloured_1.25 + fish.2024$Coloured_3.75 + fish.2024$Coloured_6.25 + fish.2024$Coloured_8.75 + fish.2024$Coloured_12.5 + fish.2024$Coloured_17.5 + fish.2024$Coloured_25 + fish.2024$Coloured_35 + fish.2024$Coloured_45 + fish.2024$Coloured_55 + fish.2024$Coloured_65 + fish.2024$Coloured_SizeClass_11 == 144, 12, 11)
fish.2024 <- dplyr::select(fish.2024, -c("Coloured_1.25", "Coloured_3.75", "Coloured_6.25", "Coloured_8.75", "Coloured_12.5", "Coloured_17.5", "Coloured_25", "Coloured_35", "Coloured_45", "Coloured_55", "Coloured_65", "Coloured_SizeClass_11"))

# Get Size class from wide to long
fish.2024 <- reshape2::melt(fish.2024, id.vars = c('SurveyNo', 'Species', 'Coloured', 'SizeClass_11'), 
          measure.vars = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5', '25', '35', '45', '55', '65'),
          variable.name = 'SizeClass', value.name = 'Abundance')

#Remove duplicates in SizeClass 65 (Class 11-proxy)
fish.2024$SizeClass_11 <- ifelse(fish.2024$SizeClass == 65, fish.2024$SizeClass_11, 0)

# ==== Add meta data ====
## Re-add species names in data frame
fish.2024$Species <- Fish.2024_speciesList # Added based on original order (!)
fish.2024$Species <- sub("\\.", "", fish.2024$Species) # Remove points from species names

### Update taxonomy for re-named or previously misidentified species
fish.2024$Species <-   ifelse(fish.2024$Species == "Pycnochromis dimidiatus", "Pycnochromis fieldi",
                       ifelse(fish.2024$Species == "Upeneus tragula", "Upeneus heemstra",
                              fish.2024$Species))

## Species metadata
fish.2024 <- merge(fish.2024, specieslist, all.x=T, by='Species') # Combine data and specieslist data frames
fish.2024$SizeClass <- as.numeric(paste(fish.2024$SizeClass)) # Set a numeric Length

## Add survey info
meta.2024 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2024-2025 (2025-05)_0.xlsx", sheet = "Data")) 
meta.2024 <- meta.2024[!is.na(meta.2024$Date),] # Remove empty rows
colnames(meta.2024)[1] <- "SurveyNo" 
meta.2024 <- meta.2024[,c("SurveyNo", "Date", "Location", "Transect", "Observer", "Radius", "Area", "Comments")] # Select relevant columns
fish.2024 <- merge(fish.2024, meta.2024, all.x=T, by='SurveyNo')

# ==== Calculate biomass ====
## Size class 65 serves as a proxy for the largest class, the actual size is taken from the SizeClass_11 variable
fish.2024$Biomass_kgha <- ifelse(
  fish.2024$SizeClass == 65,
  ((((fish.2024$a * (fish.2024$SizeClass_11 ^ fish.2024$b)) *
      fish.2024$Abundance) / fish.2024$Area) / 1000) * 10000,
  ((((fish.2024$a * (fish.2024$SizeClass ^ fish.2024$b)) *
      fish.2024$Abundance) / fish.2024$Area) / 1000) * 10000
)

## Standardize abundance
fish.2024$Abundance_m2 <- fish.2024$Abundance/fish.2024$Area

## Cleanup
fish.2024 <- dplyr::select(fish.2024, - c("a", "b"))
fish.2024 <- fish.2024 %>% drop_na(Abundance_m2) # Drop empty rows for surveys not yet done

# ---2025-2026---

# Change empty cells into zeros (needed to correctly read in the data in consecutive steps)
## Read observation block only (starting from row 3, column 2)
input_file <- "Raw data/Fish surveys_DATABASE_2025-2026.xlsx"   # your original, styled file
raw_obs <- read_excel(input_file, sheet = "INPUT Sheet", col_names = FALSE) # Takes ~2 mins
obs_block <- raw_obs[-c(1, 2), -1, drop = FALSE]  # remove first two rows and first column
obs_block <- as.data.frame(obs_block, stringsAsFactors = FALSE)

# Step 2: Clean observation block (convert to numeric, replace blanks with 0)
obs_block[] <- lapply(obs_block, function(col) {
  col[col == ""] <- NA
  suppressWarnings(as.numeric(replace(col, is.na(col), 0)))
})

# Step 3: Load the workbook with formatting intact
wb <- loadWorkbook(input_file)

# Step 4: Write cleaned values into the same cells (preserving formatting)
writeData(
  wb, 
  sheet = "INPUT Sheet", 
  x = obs_block, 
  startRow = 3, 
  startCol = 2, 
  colNames = FALSE
)

## Step 5: Save updated file
saveWorkbook(wb, "Raw data/Fish surveys_DATABASE_2025-2026_0.xlsx", overwrite = TRUE)

# Get raw data and formats
fishRaw.2025 <- xlsx_cells("Raw data/Fish surveys_DATABASE_2025-2026_0.xlsx") # Includes all sheets and styles
fish.2025 <- subset(fishRaw.2025, sheet == "INPUT Sheet") # Data including both Non & Instantaneous observations)
fish.2025format <- xlsx_formats("Raw data/Fish surveys_DATABASE_2025-2026_0.xlsx") # Formats of all sheets

# Identify non-instantaneous data
## Identify coloured cells
Fish.2025_ColouredCells <- fish.2025 %>% 
  filter(local_format_id %in% which(!is.na(fish.2025format$local$fill$patternFill$fgColor$rgb))) %>%
  dplyr::select(address, row, col, data_type)
## Label them 12 (instantaneous) or 11 (non-instantaneous)
fish.2025$Coloured <- ifelse(fish.2025$address %in% Fish.2025_ColouredCells$address, 11, 12)

## Tidy data
fish.2025 <- subset(fish.2025, row > 2) # Remove first two rows row (survey number & size classes)
fish.2025 <- dplyr::select(fish.2025, c("row", "col", "character", "numeric", "Coloured")) # Select relevant columns
Fish.2025_speciesList <- na.omit(fish.2025$character) # Save species list for later use
fish.2025 <- dplyr::select(fish.2025, -c("character")) # Remove species column
fish.2025 <- subset(fish.2025, col > 1) # Remove species column values
fish.2025$row <- fish.2025$row - 2 # Renumber rows to start at 1
fish.2025$col <- fish.2025$col - 1 # Renumber columns to start at 1

# To wide format
fish.2025 <- as.data.frame(fish.2025) # Go from tibble back to dataframe
fish.2025 <- reshape(fish.2025, idvar = c("row"), timevar = "col", direction = "wide") # To wide format (takes 2 mins)

# Set column names
fish.2025_surveys.tot <- (ncol(fish.2025) - 1)/24
fish.2025_colname <- c("Species", paste0(rep(c("c1_", "Coloured_c1_", "c2_", "Coloured_c2_", "c3_", "Coloured_c3_", "c4_", "Coloured_c4_", "c5_", "Coloured_c5_", "c6_", "Coloured_c6_", "c7_", "Coloured_c7_", "c8_", "Coloured_c8_", "c9_", "Coloured_c9_", "c10_", "Coloured_c10_", "c11num_", "Coloured_c11num_", "c11size_", "Coloured_c11size_"), fish.2025_surveys.tot), rep(1:fish.2025_surveys.tot, each = 24)))
colnames(fish.2025) <- fish.2025_colname

# To long format
fish.2025 <- setDT(fish.2025)
fish.2025 <- melt(fish.2025, 
            id.vars = 'Species', variable.name = 'SurveyNo', 
            measure.vars = patterns('^c1_', "Coloured_c1_", '^c2_', "Coloured_c2_", '^c3_', "Coloured_c3_", '^c4_', "Coloured_c4_", '^c5_', "Coloured_c5_", '^c6_', "Coloured_c6_", '^c7_', "Coloured_c7_", '^c8_', "Coloured_c8_", '^c9_', "Coloured_c9_", '^c10_', "Coloured_c10_", '^c11num_', "Coloured_c11num_", '^c11size_', "Coloured_c11size_"),
            value.name = c('1.25', 'Coloured_1.25', '3.75', 'Coloured_3.75', '6.25', 'Coloured_6.25', '8.75', 'Coloured_8.75', '12.5', 'Coloured_12.5', '17.5',  'Coloured_17.5', '25', 'Coloured_25', '35', 'Coloured_35', '45', 'Coloured_45', '55', 'Coloured_55',  '65',  'Coloured_65', 'SizeClass_11',  'Coloured_SizeClass_11'))

# Check & summarize if any of the size classes had a coloured cell
fish.2025$Coloured <- ifelse(fish.2025$Coloured_1.25 + fish.2025$Coloured_3.75 + fish.2025$Coloured_6.25 + fish.2025$Coloured_8.75 + fish.2025$Coloured_12.5 + fish.2025$Coloured_17.5 + fish.2025$Coloured_25 + fish.2025$Coloured_35 + fish.2025$Coloured_45 + fish.2025$Coloured_55 + fish.2025$Coloured_65 + fish.2025$Coloured_SizeClass_11 == 144, 12, 11)
fish.2025 <- dplyr::select(fish.2025, -c("Coloured_1.25", "Coloured_3.75", "Coloured_6.25", "Coloured_8.75", "Coloured_12.5", "Coloured_17.5", "Coloured_25", "Coloured_35", "Coloured_45", "Coloured_55", "Coloured_65", "Coloured_SizeClass_11"))

# Get Size class from wide to long
fish.2025 <- reshape2::melt(fish.2025, id.vars = c('SurveyNo', 'Species', 'Coloured', 'SizeClass_11'), 
          measure.vars = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5', '25', '35', '45', '55', '65'),
          variable.name = 'SizeClass', value.name = 'Abundance')

#Remove duplicates in SizeClass 65 (Class 11-proxy)
fish.2025$SizeClass_11 <- ifelse(fish.2025$SizeClass == 65, fish.2025$SizeClass_11, 0)

# ==== Add meta data ====
## Re-add species names in data frame
fish.2025$Species <- Fish.2025_speciesList # Added based on original order (!)
fish.2025$Species <- sub("\\.", "", fish.2025$Species) # Remove points from species names

### Update taxonomy for re-named or previously misidentified species
fish.2025$Species <-   ifelse(fish.2025$Species == "Pycnochromis dimidiatus", "Pycnochromis fieldi",
                       ifelse(fish.2025$Species == "Upeneus tragula", "Upeneus heemstra",
                              fish.2025$Species))

## Species metadata
fish.2025 <- merge(fish.2025, specieslist, all.x=T, by='Species') # Combine data and specieslist data frames
fish.2025$SizeClass <- as.numeric(paste(fish.2025$SizeClass)) # Set a numeric Length

## Add survey info
meta.2025 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2025-2026_0.xlsx", sheet = "Data")) 
meta.2025 <- meta.2025[!is.na(meta.2025$Date),] # Remove empty rows
colnames(meta.2025)[1] <- "SurveyNo" 
meta.2025 <- meta.2025[,c("SurveyNo", "Date", "Location", "Transect", "Observer", "Radius", "Area", "Comments")] # Select relevant columns
fish.2025 <- merge(fish.2025, meta.2025, all.x=T, by='SurveyNo')

# ==== Calculate biomass ====
## Size class 65 serves as a proxy for the largest class, the actual size is taken from the SizeClass_11 variable
fish.2025$Biomass_kgha <- ifelse(
  fish.2025$SizeClass == 65,
  ((((fish.2025$a * (fish.2025$SizeClass_11 ^ fish.2025$b)) *
      fish.2025$Abundance) / fish.2025$Area) / 1000) * 10000,
  ((((fish.2025$a * (fish.2025$SizeClass ^ fish.2025$b)) *
      fish.2025$Abundance) / fish.2025$Area) / 1000) * 10000
)

## Standardize abundance
fish.2025$Abundance_m2 <- fish.2025$Abundance/fish.2025$Area

## Cleanup
fish.2025 <- dplyr::select(fish.2025, - c("a", "b"))
fish.2025 <- fish.2025 %>% drop_na(Abundance_m2) # Drop empty rows for surveys not yet done

# ---- MERGE DATASETS ----
## Make column order match
### 2017-2022
fish.2017_2022 <- dplyr::select(fish.2017_2022, c("SurveyNo", "Species", "SizeClass_11", "SizeClass", "Abundance", "Abundance_m2", "Biomass_kgha",  "Coloured", "Diet", "DietH", "Date", "Location", "Transect", "Radius", "Area", "Observer", "Comments")) 

### 2023
fish.2023 <- dplyr::select(fish.2023, c("SurveyNo", "Species", "SizeClass_11", "SizeClass", "Abundance", "Abundance_m2", "Biomass_kgha",  "Coloured", "Diet", "DietH", "Date", "Location", "Transect","Radius", "Area", "Observer", "Comments")) 
## Update survey numbers to be continuous
fish.2023$SurveyNo <- as.numeric(fish.2023$SurveyNo)
SurveyNo2023 <- max(fish.2023$SurveyNo)
fish.2023$SurveyNo <- fish.2023$SurveyNo + surveys.tot
surveys.tot <- surveys.tot + SurveyNo2023

### 2024
fish.2024 <- dplyr::select(fish.2024, c("SurveyNo", "Species", "SizeClass_11", "SizeClass", "Abundance", "Abundance_m2", "Biomass_kgha",  "Coloured", "Diet", "DietH", "Date", "Location", "Transect","Radius", "Area", "Observer", "Comments"))
## Update survey numbers to be continuous
fish.2024$SurveyNo <- as.numeric(fish.2024$SurveyNo)
SurveyNo2024 <- max(fish.2024$SurveyNo)
fish.2024$SurveyNo <- fish.2024$SurveyNo + surveys.tot
surveys.tot <- surveys.tot + SurveyNo2024

### 2025
fish.2025 <- dplyr::select(fish.2025, c("SurveyNo", "Species", "SizeClass_11", "SizeClass", "Abundance", "Abundance_m2", "Biomass_kgha",  "Coloured", "Diet", "DietH", "Date", "Location", "Transect","Radius", "Area", "Observer", "Comments"))
## Update survey numbers to be continuous
fish.2025$SurveyNo <- as.numeric(fish.2025$SurveyNo)
SurveyNo2025 <- max(fish.2025$SurveyNo)
fish.2025$SurveyNo <- fish.2025$SurveyNo + surveys.tot
surveys.tot <- surveys.tot + SurveyNo2025

## Merge
fish <- rbind(fish.2017_2022, fish.2023, fish.2024, fish.2025)

# Match species
## Remove cryptic fish and unknown line
fish <- fish[!(fish$Species=='Atherinomorus sp' | fish$Species=='Ablabys binotatus' | fish$Species=='Amblyeleotris sp' |
        fish$Species=='Antennarius sp' | fish$Species=='Exallias brevis' | fish$Species=='Gymnomuraena zebra' |
        fish$Species=='Gymnothorax griseus' | fish$Species=='Gymnothorax javanicus' | fish$Species=='Gymnothorax meleagris' |
        fish$Species=='Gymnothorax sp' | fish$Species=='Inimicus filamentosus' | fish$Species=='Myrichthys colubrinus' |
        fish$Species=='Myrichthys maculosus' | fish$Species=='Paracirrhites arcatus' | fish$Species=='Paracirrhites forsteri' |
        fish$Species=='Parapercis hexophtalma' | fish$Species=='Parapercis sp' | fish$Species=='Scorpaenopsis sp' |
        fish$Species=='Scuticaria tigrina' | fish$Species=='Synodus sp' | fish$Species=='Trachyrhamphus bicoarctatus' |
        fish$Species=='Unknown blenny' | fish$Species=='Valenciennea helsdingenii' | fish$Species=='Valenciennea strigata' | 
        fish$Species=='Tylosurus crocodilus' |  fish$Species=='Plectropomus laevis' | fish$Species=='Unknown'),]

## Fill in missing species on both sides
### Set apart metadata first
meta.all <- dplyr::select(fish, c("SurveyNo", "Date", "Location", "Transect", "Radius", "Area", "Observer", "Comments"))
meta.all <- meta.all[!duplicated(meta.all[,c('SurveyNo')]),]
### Reduce dataframe to values only
fish <- dplyr::select(fish, -c("Diet", "DietH", "Date", "Location", "Transect", "Radius", "Area", "Observer", "Comments"))

### Fill in missing species with 0 values, or 12 in the case of Coloured
fish <- fish %>% complete(SurveyNo, Species, SizeClass)

fish$Abundance[is.na(fish$Abundance)] <- 0
fish$Abundance_m2[is.na(fish$Abundance_m2)] <- 0
fish$Biomass_kgha[is.na(fish$Biomass_kgha)] <- 0
fish$Coloured <- ifelse(fish$Coloured == -1, 12, fish$Coloured)

### Re-add meta surveys
fish <- left_join(fish, meta.all, by = "SurveyNo")
### Fill in Diet for newly added species
specieslist <- dplyr::select(specieslist, c("Species", "Diet", "DietH"))
fish <- left_join(fish, specieslist, by = "Species")

## Add transect info
transectinfo <- as.data.frame(read_excel("Raw data/Measurements timeline.xlsx", sheet = "Overview (yearly)"))
colnames(transectinfo)[1] <- "Transect"
transectinfo <- dplyr::select(transectinfo, c("Transect", "Type", "Site", "GPS", "Depth.MLLW", "Reef.dist_m", "AR.dist_m", "Date.created", "Area_m2"))
fish$Transect <- tolower(fish$Transect)
transectinfo$Transect <- tolower(transectinfo$Transect)

fish <- left_join(fish, transectinfo, by = "Transect")

## Replace the 65-proxy by the actual size of the largest class, which varies between species / survey. 
# If there is no fish in the largest class, keep 65 as a proxy.
fish <- fish %>%
  mutate(SizeClass = ifelse(SizeClass == 65 & Abundance > 0, SizeClass_11, SizeClass)) %>%
  dplyr::select(-SizeClass_11)

# Rename SizeClass to Size, considering it is not a class system now
fish <- fish %>% rename(Size = SizeClass)

#Make Size numeric to allow ordering to size
fish$Size <- as.numeric(fish$Size)

# Cleanup
fish <- fish %>% distinct()
fish$Type <- ifelse(fish$Transect == "na", "Reference", fish$Type)
fish$Site <- ifelse(fish$Transect == "na", fish$Location, 
             ifelse(is.na(fish$Site), fish$Location, fish$Site))
fish$Type <- ifelse(is.na(fish$Type), "Other", fish$Type)
colnames(fish)[which(names(fish) == "Type")] <- "Treatment"
fish$Patch.type <- ifelse(grepl("cma-l-", fish$Transect), "AR (L)",
                   ifelse(grepl("cma-xl-", fish$Transect), "AR (XL)",
                   ifelse(grepl("cma-xs-", fish$Transect), "AR (XS)",
                   ifelse(grepl("-bru-", fish$Transect), "BRU",
                   ifelse(grepl("-cage-", fish$Transect), "CAGE",       
                   ifelse(grepl("-cake-", fish$Transect), "CAKE",       
                   ifelse(grepl("-comp-", fish$Transect), "COMP",
                   ifelse(grepl("m-", fish$Transect), "MOSES (- coral)",       
                   ifelse(grepl("m+", fish$Transect), "MOSES (+ coral)",       
                   ifelse(grepl("m-c", fish$Transect), "MOSES (control)",  
                   ifelse(grepl("m-p", fish$Transect), "MOSES (pins)",       
                   ifelse(grepl("r-l-", fish$Transect), "Reference (L)",
                   ifelse(grepl("r-xl-", fish$Transect), "Reference (XL)",
                   ifelse(grepl("r-xs-", fish$Transect), "Reference (XS)",
                   ifelse(grepl("(?<!\\()f-r-", fish$Transect, perl=TRUE), "Control",
                   ifelse(grepl("(?<!\\()nt-r-", fish$Transect, perl=TRUE), "Control",
                   ifelse(grepl("\\(f-r-",fish$Transect),"Reference",
                   ifelse(grepl("\\(nt-r-",fish$Transect),"Reference",
                                "na"))))))))))))))))))    

fish$Date.created <- excel_numeric_to_date(as.numeric(fish$Date.created))
fish$Year.created <- year(fish$Date.created)
fish$Year <- year(fish$Date)

## Re-order dataframe
fish <- dplyr::select(fish, "SurveyNo", "Site", "Treatment", "Patch.type", "Transect", "Year.created", "Date.created", "GPS",
                            "Depth.MLLW", "Reef.dist_m", "AR.dist_m", "Area_m2","Radius", "Area","Observer", "Comments", "Year", "Date",
                            "Species", "Diet", "DietH", "Size", "Abundance", "Abundance_m2", "Biomass_kgha", "Coloured")

## Remove NAs before aggregating
fish <- fish %>%
  mutate_if(is.character, ~replace_na(., "na")) 
fish <- fish %>%
  mutate_if(is.numeric, ~replace_na(., -1)) 
fish <- dplyr::select(fish, -c("Date.created"))

## Write clean parquet file
write_parquet(fish, "Fish_All years.parquet")

## Clean environment
rm(fish, fish.2017_2022, fish.2018, fish.2019, fish.2020, fish.2021, fishRAW.2018, fishRAW.2019, fishRAW.2020, fishRAW.2021, meta.all,
   meta.2018, meta.2019, meta.2020, meta.2021, meta.2017_2022, specieslist, transectinfo, colname, 
   fish.2023, Fish.2023_ColouredCells, fish.2023format, fishRaw.2023, meta.2023, fish.2023_colname, fish.2023_surveys.tot, Fish.2023_speciesList, SurveyNo2023, 
   fish.2024, Fish.2024_ColouredCells, fish.2024format, fishRaw.2024, meta.2024, fish.2024_colname, fish.2024_surveys.tot, Fish.2024_speciesList,
   SurveyNo2024, 
   fish.2025, Fish.2025_ColouredCells, fish.2025format, fishRaw.2025, meta.2025, fish.2025_colname, fish.2025_surveys.tot, Fish.2025_speciesList,
   SurveyNo2025,
   surveys.tot, obs_block, raw_obs,  input_file, wb, fish_sizeclass, co, biomass_sum, col_order, cols, i, idx_12, target_species)

```

# Filtering RAW output to relevant information (adjust based on research interest)
```{r}
# Load data sets
fish <- read_parquet("Fish_All years.parquet")

# Remove irrelevant columns
fish <- fish %>%
  dplyr::select(-GPS, -Year.created, -Area_m2, -Diet)

# Select relevant surveys. The surveys from end of 2024 and start of 2025 (done on only the reference patches of both reefs) are excluded as they are right inbetween the surveys of 2023 and the new ones in 2025. I do not wish to have an inbetween yeargroup, as I am comparing three sets of complete surveys (all 60 reefs surveyed)
fish <- fish[fish$Patch.type %in% c("CAGE", "CAKE","BRU","COMP","Control","Reference") & fish$Year >= 2021 &
    !(fish$Date >= as.Date("2024-10-01") & fish$Date < as.Date("2025-02-01")),]

## Observers with less than 5 surveys conducted are omitted, as they are introducing unnecessary observer bias while contributing little to data
fish <- fish[!(fish$Observer %in% c("Cindy","Mercy Zawadi","Mercy", "Paula Hernandez")),]

# Add a YearGroup variable, to compare between 2021, 2023 and 2025
fish$YearGroup <- ifelse(fish$Year %in% c(2021, 2022), "2021–2022",
                   ifelse(fish$Year %in% c(2023, 2024), "2023–2024",
                   ifelse(fish$Year == 2025, "2025", NA)))
fish <- fish %>% relocate(YearGroup, .after = Year)

# Set data types
fishtofactors <- c('SurveyNo', 'Site', 'Treatment', 'Patch.type', 'Transect', 'Observer', 'Year', 'YearGroup','Species', 'DietH', 'Size') 
fish[fishtofactors] <- lapply(fish[fishtofactors], factor)
rm(fishtofactors)
fish$AR.dist_m    <- as.numeric(trimws(fish$AR.dist_m))
fish$Reef.dist_m  <- as.numeric(trimws(fish$Reef.dist_m))

# Remove unused factors-
fish <- droplevels(fish)

# Exclude /practise surveys
fish <- fish[!grepl("exclude|wrong|exclude", fish$Comments, ignore.case = TRUE), ]

# Now we add some variables useful for modelling later on
## Combined variable for taking intra-survey Observer differences into account in the model
fish$TransectDate <- paste(fish$Transect, fish$Date, sep="_")

## Replace NA's in distances with 0's, these are excluded using :Treatment later. If we keep them NA, the entire row is excluded.
fish$Reefdistance <- fish$Reef.dist_m %>% replace(is.na(.), 0)
fish$ARdistance <- fish$AR.dist_m %>% replace(is.na(.), 0)

# Now we write a clean survey file for modelling
write_parquet(fish, "Fish_Clean.parquet")

# Get total list of relevant surveys
surveylist <- as.data.frame(unique(fish$SurveyNo))
names(surveylist) <- "SurveyNo"
surveylist <- surveylist %>% arrange(SurveyNo)

# Check average radius in last couple years, taking out duplicate surveys
fish_unique <- fish[!duplicated(fish[c("Transect", "Date")]), ]
aggregate(Radius ~ YearGroup, data = fish_unique,
          FUN = function(x) round(mean(x), 2))

```

# Load in data (once the above chunk is set to your taste, you only have to run this chunk when starting up again)
```{r}
fish <- read_parquet("Fish_Clean.parquet")
```
# Abundance
```{r}
# ---- DATA PREP ----
# Remove rows with non-herbivorous fish, and non-instantaneous observations
Abundance <- fish[fish$DietH != "Other" & fish$Coloured == 12,]
Abundance <- droplevels(Abundance)

all_combos <- expand_grid(
  SurveyNo = unique(Abundance$SurveyNo),
  DietH = unique(Abundance$DietH))

# Sum abundances per guild
## First store metadata
survey_meta <- Abundance %>%
  dplyr::select(SurveyNo, Transect, Depth.MLLW, Reefdistance, ARdistance, Reef.dist_m, AR.dist_m, YearGroup, TransectDate, Patch.type, Treatment, Observer) %>%
  distinct()

## Sum abundance per guild
Abundance <- Abundance %>%
  group_by(SurveyNo, DietH) %>%
  summarise(GuildAbundance_m2 = sum(Abundance_m2),
            .groups = "drop") %>%
  right_join(all_combos, by = c("SurveyNo", "DietH")) 

## Bring back metadata lost in group_by
Abundance <- Abundance %>%
  left_join(survey_meta, by = "SurveyNo")
rm(survey_meta, all_combos)
```
## Pre-model plots
```{r}
# Add the different guilds together per survey
Abundance_combined <- Abundance %>%
  group_by(SurveyNo, Depth.MLLW, Treatment, Reef.dist_m, AR.dist_m) %>%
  summarise (Abundance_m2 = sum(GuildAbundance_m2))

# Correlation between reef depth and abundance
par(mar = c(5, 5, 4, 2) + 0.1)  # Increase left margin (second value)
plot(Abundance_combined$Depth.MLLW, Abundance_combined$Abundance_m2, xlab = "Depth", ylab = expression(Fish ~ abundance ~ (m^-2)), main = "Herbivore abundance vs Depth (covariate)")
abline(lm(Abundance_m2 ~ Depth.MLLW, data = Abundance_combined))
sum_lm <- summary (lm(Abundance_m2 ~ Depth.MLLW, data = Abundance_combined))
coef_lm <- sum_lm$coefficients
text(x = 7,
     y = 1,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 3 decimals
                     round(coef_lm[2,4],3),
                     "\ny = ",
                     #Round slope coefficient to 3 decimals
                     round(coef_lm[2,1],3),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

# Correlation between distance from natural reef and abundance
Abundance_noREF <- Abundance_combined[Abundance_combined$Treatment != "Reference",] 
par(mar = c(5, 5, 4, 2) + 0.1)  # Increase left margin (second value)
plot(Abundance_noREF$Reef.dist_m, Abundance_noREF$Abundance_m2, xlab = "Reef distance", ylab = expression(Fish ~ abundance ~ (m^-2)), ylim = c(0,0.3), main = "Herbivore abundance vs distance from natural reef (covariate)")
abline(lm(Abundance_m2 ~ Reef.dist_m, data = Abundance_noREF))
sum_lm <- summary (lm(Abundance_m2 ~ Reef.dist_m, data = Abundance_noREF))
coef_lm <- sum_lm$coefficients
text(x = 23,
     y = 0.20,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 3 decimals
                     round(coef_lm[2,4],3),
                     "\ny = ",
                     #Round slope coefficient to 3 decimals
                     round(coef_lm[2,1],3),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

# Correlation between distance from another AR and species Abundance
Abundance_ARonly <- Abundance_combined[Abundance_combined$Treatment == "AR",] 
par(mar = c(5, 5, 4, 2) + 0.1)  # Increase left margin (second value)
plot(Abundance_ARonly$AR.dist_m, Abundance_ARonly$Abundance_m2, xlab = "AR distance", ylab = expression(Fish ~ abundance ~ (m^-2)), ylim = c(0,0.2), main = "Herbivore abundance vs distance from another artifical reef (covariate)")
abline(lm(Abundance_m2 ~ AR.dist_m, data = Abundance_ARonly))
sum_lm <- summary (lm(Abundance_m2 ~ AR.dist_m, data = Abundance_ARonly))
coef_lm <- sum_lm$coefficients
text(x = 23,
     y = 0.15,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 3 decimals
                     round(coef_lm[2,4],3),
                     "\ny = ",
                     #Round slope coefficient to 3 decimals
                     round(coef_lm[2,1],3),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

rm(sum_lm)

# Conclusion: only Depth has a significant and considerable effect as a covariate, omit reef and AR distances here

```
## Statistical models
```{r}
# Version 1: Log-link to test Reef.dist and AR dist significance among AR
AmodelNB1 <- glmmTMB(GuildAbundance_m2 ~ Depth.MLLW + Reef.dist_m + AR.dist_m + YearGroup * Patch.type + DietH + (1 | Transect) + (1 | TransectDate:Observer), data = Abundance, family = tweedie(link="log"))

# Version 6: Distances omitted; they are insignificant and the effect size is too small to be interesting
AmodelNB6 <- glmmTMB(GuildAbundance_m2 ~ Depth.MLLW + YearGroup * Patch.type + DietH + (1 | Transect) + (1 | TransectDate:Observer), data = Abundance, family = tweedie(link="log"), dispformula = ~ DietH)

# Version 7
AmodelNB7 <- glmmTMB(GuildAbundance_m2 ~ Depth.MLLW + YearGroup * Patch.type + YearGroup * DietH + (1 | Transect) + (1 | TransectDate:Observer), data = Abundance, family = tweedie(link="log"), dispformula = ~ DietH)

# Look at model
Anova(AmodelNB1) # ARdist is significant, REEFdist isn't
summary(AmodelNB1)$coefficients$cond # ARdist explains very little, thus is excluded
Anova(AmodelNB6) # YearGroup, Patch.type and DietH are all significant. Interaction is also significant.
Anova(AmodelNB7) # YearGroup:DietH & YearGroup:Patch.type are significant. Also consider standalone YearGroup plot.

# Normality, heteroscedasticity with DHARMa
Asim_resNB6 <- simulateResiduals(fittedModel = AmodelNB6, re.form = NULL)
Asim_resNB7 <- simulateResiduals(fittedModel = AmodelNB7, re.form = NULL)

# plot(Asim_resNB6)
plot(Asim_resNB7)
```
## Plots and post-hoc
```{r}
vc <- as.data.frame(VarCorr(AmodelNB7)$cond) # Variance random intercepts
sigma_re <- sqrt(sum(unlist(vc))) # Emmeans expects standard deviation

# 2. YearGroup:DietH interaction
emm_diet <- emmeans(AmodelNB7, ~ YearGroup * DietH, type = "response",
                    bias.adjust = TRUE,
                    sigma = sigma_re)
cld_diet <- cld(emm_diet, by = "DietH", Letters = letters,
                bias.adjust = TRUE,
                sigma = sigma_re)
emm_diet_df <- as.data.frame(cld_diet)
emm_diet_df$.group <- trimws(emm_diet_df$.group)

# 3. YearGroup:Patch.type interaction
emm_patch <- emmeans(AmodelNB7, ~ YearGroup * Patch.type, type = "response",
                    bias.adjust = TRUE,
                    sigma = sigma_re)
cld_patch <- cld(emm_patch, by = "Patch.type", Letters = letters,
                 bias.adjust = TRUE,
                 sigma = sigma_re)
emm_patch_df <- as.data.frame(cld_patch)
emm_patch_df$.group <- trimws(emm_patch_df$.group)

# Count observations for each combination (for N values in figure description in paper)
n_values <- Abundance %>%
  group_by(YearGroup, Patch.type) %>%
  summarise(N = n_distinct(SurveyNo), .groups = 'drop')
print(n_values)

# Plot 2: Yeargroup x DietH interaction
Aplot2 <- ggplot(emm_diet_df, aes(x = DietH, y = response, colour = YearGroup, shape = YearGroup, group = YearGroup)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                position = position_dodge(width = 0.5),
                width = 0.2) +
  geom_text(aes(label = .group, y = asymp.UCL),
            position = position_dodge(width = 0.5),
            vjust = -0.5,
            size = 5,
            show.legend = FALSE) +
  labs(x = "Herbivore guild", y = expression(Abundance ~ (m^-2)),
       title = "Herbivore fish abundance over time, by guild") +
  guides(shape = guide_legend(title = "Year"), colour = guide_legend(title = "Year")) +
  theme_minimal(base_size = 12) +
  theme_bw()

# Plot 3: Yeargroup x Patch.type interaction
Aplot3 <- ggplot(emm_patch_df, aes(x = Patch.type, y = response, colour = YearGroup, shape = YearGroup, group = YearGroup)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                position = position_dodge(width = 0.5),
                width = 0.2) +
  geom_text(aes(label = .group, y = asymp.UCL),
            position = position_dodge(width = 0.5),
            vjust = -0.5,
            size = 4.5,
            show.legend = FALSE) +
  labs(x = "Reef design", y = expression(Abundance ~ (m^-2)),
       title = "Herbivore fish abundance over time, by reef design") +
  guides(shape = guide_legend(title = "Year"), colour = guide_legend(title = "Year")) +
  theme_minimal(base_size = 12) +
  theme_bw()

# Post-hoc
print("=== Plot 2: YearGroup comparisons within each Guild ===")
posthoc_diet_within <- pairs(emm_diet, by = "DietH", adjust = "sidak",
                             bias.adjust = TRUE,
                             sigma = sigma_re)
# print(posthoc_diet_within)
posthoc_diet_within_df <- as.data.frame(posthoc_diet_within)
posthoc_diet_within_sig <- posthoc_diet_within_df[posthoc_diet_within_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_diet_within_sig)

print("=== Plot 2: Guild comparisons within each YearGroup ===")
posthoc_diet_between <- pairs(emm_diet, by = "YearGroup", adjust = "sidak",
                             bias.adjust = TRUE,
                             sigma = sigma_re)
# print(posthoc_diet_between)
posthoc_diet_between_df <- as.data.frame(posthoc_diet_between)
posthoc_diet_between_sig <- posthoc_diet_between_df[posthoc_diet_between_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_diet_between_sig)

print("=== Plot 3: YearGroup comparisons within each Patch type ===")
posthoc_patch_within <- pairs(emm_patch, by = "Patch.type", adjust = "sidak",
                             bias.adjust = TRUE,
                             sigma = sigma_re)
# print(posthoc_patch_within)
posthoc_patch_within_df <- as.data.frame(posthoc_patch_within)
posthoc_patch_within_sig <- posthoc_patch_within_df[posthoc_patch_within_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_patch_within_sig)

print("=== Plot 3: Patch type comparisons within each YearGroup ===")
posthoc_patch_between <- pairs(emm_patch, by = "YearGroup", adjust = "sidak",
                             bias.adjust = TRUE,
                             sigma = sigma_re)
# print(posthoc_patch_between)
posthoc_patch_between_df <- as.data.frame(posthoc_patch_between)
posthoc_patch_between_sig <- posthoc_patch_between_df[posthoc_patch_between_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_patch_between_sig)

# Display plots
print(Aplot2)
print(Aplot3)
```
# Mean size
```{r}
# ---- DATA PREP ----
# Remove rows with no abundance (as those would lower mean sizes), or non-herbivorous fish and non-instantaneous observations
Meansize <- fish[fish$Abundance != 0 & fish$DietH != "Other" & fish$Coloured == 12,]

## First store metadata
survey_meta <- Meansize %>%
  dplyr::select(SurveyNo, Transect, Depth.MLLW, Reefdistance, ARdistance, Reef.dist_m, AR.dist_m, YearGroup, TransectDate, Patch.type, Treatment, Observer) %>%
  distinct()

Meansize$Size <- as.numeric(as.character(Meansize$Size))

# Go from size classes to mean size
Meansize <- Meansize %>%
  group_by(SurveyNo, DietH) %>%
  summarise(GuildMeansize = sum(Size * Abundance) / sum(Abundance),
            .groups = "drop")

# Bring back the lost metadata 
Meansize <- Meansize %>%
  left_join(survey_meta, by = "SurveyNo")
rm(survey_meta)
```
## Pre-model plots
```{r}
# Add the different guilds together per survey
Meansize_combined <- Meansize %>%
  group_by(SurveyNo, Depth.MLLW, Treatment, Reef.dist_m, AR.dist_m) %>%
  summarise (Meansize = sum(GuildMeansize))

# Correlation between reef depth and mean size
plot(Meansize_combined$Depth.MLLW, Meansize_combined$Meansize, xlab = "Depth", ylab = "Mean size (cm)", main = "Mean size vs Depth (covariate)")
abline(lm(Meansize ~ Depth.MLLW, data = Meansize_combined))
sum_lm <- summary (lm(Meansize ~ Depth.MLLW, data = Meansize_combined))
coef_lm <- sum_lm$coefficients
text(x = 7,
     y = 40,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 2 decimals
                     round(coef_lm[2,4],2),
                     "\ny = ",
                     #Round slope coefficient to 2 decimals
                     round(coef_lm[2,1],1),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

# Correlation between distance from natural reef and mean fish size
Meansize_noREF <- Meansize_combined[Meansize_combined$Treatment != "Reference",] 
plot(Meansize_noREF$Reef.dist_m, Meansize_noREF$Meansize, xlab = "Reef distance", ylab = "Mean size (cm)", main = "Mean herbivore fish size vs distance from natural reef (covariate)")
abline(lm(Meansize ~ Reef.dist_m, data = Meansize_noREF))
sum_lm <- summary (lm(Meansize ~ Reef.dist_m, data = Meansize_noREF))
coef_lm <- sum_lm$coefficients
text(x = 23,
     y = 40,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 2 decimals
                     round(coef_lm[2,4],2),
                     "\ny = ",
                     #Round slope coefficient to 2 decimals
                     round(coef_lm[2,1],1),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

# Correlation between distance from another AR and mean fish size
Meansize_ARonly <- Meansize_combined[Meansize_combined$Treatment == "AR",] 
plot(Meansize_ARonly$AR.dist_m, Meansize_ARonly$Meansize, xlab = "AR distance", ylab = "Mean size (cm)", main = "Mean herbivore fish size vs distance from another artifical reef (covariate)")
abline(lm(Meansize ~ AR.dist_m, data = Meansize_ARonly))
sum_lm <- summary (lm(Meansize ~ AR.dist_m, data = Meansize_ARonly))
coef_lm <- sum_lm$coefficients
text(x = 25,
     y = 40,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 2 decimals
                     round(coef_lm[2,4],2),
                     "\ny = ",
                     #Round slope coefficient to 2 decimals
                     round(coef_lm[2,1],1),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)
```
## Statistical models
```{r}
# Version 5: Log-link, checking for significance of covariates. Couldn't use Reef.dist_m and AR_dist.m here due to convergence issues. Therefore, tested with proxies.
MSmodelLoglink3 <- glmmTMB(GuildMeansize ~ Depth.MLLW + Reefdistance + ARdistance + YearGroup * Patch.type + DietH + (1 | Transect) + (1| TransectDate:Observer), data = Meansize, family = tweedie(link="log"))

# Version 6: Log-link, only reef distance and without depth due to insignificance
MSmodelLoglink5 <- glmmTMB(GuildMeansize ~ YearGroup * Patch.type * DietH  + Reefdistance + (1 | Transect) + (1| TransectDate:Observer), data = Meansize, family = tweedie(link="log"))
 
# Version 7: v6 but with just a two-way interaction: YearGroup * DietH
MSmodelLoglink6 <- glmmTMB(GuildMeansize ~ YearGroup * DietH + YearGroup * Patch.type + Reefdistance + (1 | Transect) + (1| TransectDate:Observer), data = Meansize, family = tweedie(link="log"))

# Look at model
Anova(MSmodelLoglink3) # Depth & ARdistance are insignificant
summary(MSmodelLoglink3)$coefficients$cond # Reefdistance has a small effect, but proportionally comparable some DietH / Year effects > include
Anova(MSmodelLoglink5) # Here, three way-interaction is significant
Anova(MSmodelLoglink6) # # YearGroup:DietH is significant. Also consider standalone YearGroup plot.
 
# Normality & homoscedasticity for DHARMa
MSsim_resLoglink5 <- simulateResiduals(fittedModel = MSmodelLoglink5, re.form = NULL)
MSsim_resLoglink6 <- simulateResiduals(fittedModel = MSmodelLoglink6, re.form = NULL)

# plot residuals
plot(MSsim_resLoglink5)
plot(MSsim_resLoglink6)
```

## Plots and post-hoc
```{r}
vc <- as.data.frame(VarCorr(MSmodelLoglink6)$cond) # Variance random intercepts
sigma_re <- sqrt(sum(unlist(vc))) # Emmeans expects standard deviation

# Plot 2: Yeargroup x DietH interaction
emm2 <- emmeans(MSmodelLoglink6, ~ YearGroup * DietH, type = "response",
                bias.adjust = TRUE,
                sigma = sigma_re)
cld_results <- cld(emm2, by = "DietH", Letters = letters, adjust = "sidak",
                   bias.adjust = TRUE,
                   sigma = sigma_re)
emm2_df <- as.data.frame(cld_results)
emm2_df$.group <- trimws(emm2_df$.group)

# Count observations for each combination (for N values in figure description in paper)
n_values <- Meansize %>%
  group_by(YearGroup, DietH) %>%
  summarise(N = n_distinct(SurveyNo), .groups = 'drop')
print(n_values)

# Plot 3: Patch.type main effect
emm3 <- emmeans(MSmodelLoglink6, ~ Patch.type, type = "response",
                bias.adjust = TRUE,
                sigma = sigma_re)

cld3 <- cld(emm3, Letters = letters, adjust = "sidak",
            bias.adjust = TRUE,
            sigma = sigma_re)
emm3_df <- as.data.frame(cld3)
emm3_df$.group <- trimws(emm3_df$.group)

# Count observations for each combination (for N values in figure description in paper)
n_values <- Meansize %>%
  group_by(Patch.type) %>%
  summarise(N = n_distinct(SurveyNo), .groups = 'drop')
print(n_values)

# Plot 2: DietH x Year interaction
MSplot2 <- ggplot(emm2_df, aes(x = DietH, y = response, colour = YearGroup, shape = YearGroup, group = YearGroup)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                position = position_dodge(width = 0.5),
                width = 0.2) +
  geom_text(aes(label = .group, y = asymp.UCL),
            position = position_dodge(width = 0.5),
            vjust = -0.5,
            size = 5,
            show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = 0.1)) +
  labs(x = "Herbivore guild", y = "Mean size (cm)",
       title = "Mean herbivore fish size over time, by guild",
      subtitle = "Averaged over reef design (Year × Guild × Reef design interaction significant)") +
  guides(shape = guide_legend(title = "Year"), colour = guide_legend(title = "Year")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Plot 3: Patch type main effect
MSplot3 <- ggplot(emm3_df, aes(x = Patch.type, y = response)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2) +
  geom_point(size = 3) +
  # geom_text(aes(label = .group, y = asymp.UCL), vjust = -0.5, size = 4) +
  labs(x = "Reef design", y = "Mean size (cm)",
       title = "Mean herbivore fish size by reef design",
        subtitle = "Main effect (Year × Guild × Reef design interaction significant)") +
  theme_bw()

# Post-hoc
print("=== Plot 2: YearGroup comparisons within each Guild ===")
posthoc_diet_within <- pairs(emm2, by = "DietH", adjust = "sidak",
                             bias.adjust = TRUE,
                             sigma = sigma_re)
# print(posthoc_diet_within)
posthoc_diet_within_df <- as.data.frame(posthoc_diet_within)
posthoc_diet_within_sig <- posthoc_diet_within_df[posthoc_diet_within_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_diet_within_sig)

print("=== Plot 2: Guild comparisons within each YearGroup ===")
posthoc_diet_between <- pairs(emm2, by = "YearGroup", adjust = "sidak",
                              bias.adjust = TRUE,
                              sigma = sigma_re)
# print(posthoc_diet_between)
posthoc_diet_between_df <- as.data.frame(posthoc_diet_between)
posthoc_diet_between_sig <- posthoc_diet_between_df[posthoc_diet_between_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_diet_between_sig)

posthoc_patch <- pairs(emm3, adjust = "sidak",
                       bias.adjust = TRUE,
                       sigma = sigma_re)
print("=== Plot 3: Patch type comparisons ===")
# print(posthoc_patch) # <if you want to see all non-significant as well.
posthoc_patch_df <- as.data.frame(posthoc_patch)
posthoc_patch_sig <- posthoc_patch_df[posthoc_patch_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_patch_sig)

# Display plots
print(MSplot2)
print(MSplot3)
```
## Three-way
```{r}
vc <- as.data.frame(VarCorr(MSmodelLoglink5)$cond) # Variance random intercepts
sigma_re <- sqrt(sum(unlist(vc))) # Emmeans expects standard deviation

# Plot 5: YearGroup x Patch.type x DietH interaction
emm5 <- emmeans(MSmodelLoglink5, ~ DietH * Patch.type * YearGroup, type = "response",
                bias.adjust = TRUE,
                sigma = sigma_re)
emm5_df <- as.data.frame(emm5)

# Get the actual combinations that exist in your data
actual_combinations <- unique(Meansize[, c("DietH", "Patch.type", "YearGroup")])

# Filter emmeans results to only include observed combinations
emm5_df <- merge(emm5_df, actual_combinations, by = c("DietH", "Patch.type", "YearGroup"))

# Calculate cld for each combination of Patch.type and DietH that actually exists
cld_list5 <- list()
for (patch in unique(emm5_df$Patch.type)) {
  for (diet in unique(emm5_df$DietH[emm5_df$Patch.type == patch])) {
    # Check if this combination has data
    if (nrow(emm5_df[emm5_df$Patch.type == patch & emm5_df$DietH == diet, ]) > 0) {
      emm_subset <- emmeans(MSmodelLoglink5, ~ YearGroup, 
                            at = list(Patch.type = patch, DietH = diet), 
                            type = "response",
                            bias.adjust = TRUE,
                            sigma = sigma_re)
      cld_subset <- cld(emm_subset, Letters = letters, adjust = "sidak",
                bias.adjust = TRUE,
                sigma = sigma_re)
      df_subset <- as.data.frame(cld_subset)
      df_subset$Patch.type <- patch
      df_subset$DietH <- diet
      df_subset$.group <- trimws(df_subset$.group)
      
      # Filter to only YearGroups that exist for this combination
      df_subset <- df_subset %>%
        semi_join(actual_combinations, by = c("DietH", "Patch.type", "YearGroup"))
      
      cld_list5[[paste(patch, diet, sep = "_")]] <- df_subset
    }
  }
}
emm5_df <- do.call(rbind, cld_list5)

MSplot5 <- ggplot(emm5_df, aes(x = DietH, y = response,
                               colour = factor(YearGroup),
                             shape = factor(YearGroup), 
                             group = factor(YearGroup))) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_point(size = 3, position = position_dodge(width = 0.5)) +
  geom_text(aes(label = .group, y = asymp.UCL), 
            position = position_dodge(width = 0.5), 
            vjust = -0.5, size = 3, show.legend = FALSE) +
  facet_wrap(~ Patch.type, ncol = 1, scales = "free_y") +
  scale_y_continuous(limits = c(0, NA), expand = expansion(add = c(0, 10))) +
  labs(x = "Herbivore guild", y = "Mean size (cm)") +
  guides(shape = guide_legend(title = "Year"), colour = guide_legend(title = "Year")) +
  theme_bw() +
  theme(strip.text = element_text(face = "plain"),
        strip.background = element_blank(),
        legend.position = "top",
        legend.direction = "horizontal")

Y_contrasts <- contrast(emm5,
                        "pairwise",
                        by = c("DietH","Patch.type"), 
                        bias.adjust = TRUE,
                        sigma = sigma_re)
summary(Y_contrasts, infer = TRUE)
print(MSplot5)
```
# Biomass
```{r}
# ---- DATA PREP ----
# Remove rows with no abundance or non-herbivorous fish
Biomass <- fish[fish$DietH != "Other" & fish$Coloured == 12,]
Biomass <- droplevels(Biomass)

all_combos <- expand_grid(
  SurveyNo = unique(Biomass$SurveyNo),
  DietH = unique(Biomass$DietH))

# Go from abundance to species Biomass, and bringing back 0 values for groups without observations
## First store metadata
survey_meta <- Biomass %>%
  dplyr::select(SurveyNo, Transect, Depth.MLLW, Reefdistance, ARdistance, Reef.dist_m, AR.dist_m, YearGroup, TransectDate, Patch.type, Treatment, Observer) %>%
  distinct()

Biomass <- Biomass %>%
  group_by(SurveyNo, DietH) %>%
  summarise(GuildBiomass = sum(Biomass_kgha),
            .groups = "drop") 

# Bring back the lost metadata 
Biomass <- Biomass %>%
  left_join(survey_meta, by = "SurveyNo")
rm(survey_meta, all_combos)
```
## Pre-model plots
```{r}
# Add the different guilds together per survey
Biomass_combined <- Biomass %>%
  group_by(SurveyNo, Depth.MLLW, Treatment, Patch.type, YearGroup, Reef.dist_m, AR.dist_m) %>%
  summarise (Biomass = sum(GuildBiomass))

## Trying to bug-fix the low emmeans values: first figure out what average values are over the raw data
Biomass_Year <- aggregate(Biomass ~ YearGroup, data = Biomass_combined, FUN = mean)
Biomass_Treatment <- aggregate(Biomass ~ Treatment, data = Biomass_combined, FUN = mean)
Biomass_PatchType <- aggregate(Biomass ~ Patch.type, data = Biomass_combined, FUN = mean)
BiomassGrazers <- Biomass[Biomass$DietH == "Grazers",]
BiomassGrazers_Year <- aggregate(GuildBiomass ~ YearGroup, data = BiomassGrazers, FUN = mean) ## Last year shows much lower numbers than 2023-2024, while in emmeans the last year is higher.

## Getting rid of guilds to see if that resolves issue
Biomass_nonguilds <- Biomass %>%
  group_by(SurveyNo, Transect, Depth.MLLW, Reefdistance, ARdistance, Reef.dist_m, AR.dist_m, YearGroup, TransectDate, Patch.type, Treatment, Observer) %>%
  summarise (Biomass = sum(GuildBiomass))

# Correlation between reef depth and species richness
plot(Biomass_combined$Depth.MLLW, Biomass_combined$Biomass, xlab = "Depth", ylab = "Biomass (kg/ha)", ylim = c(0, 150), main = "Biomass vs Depth (covariate)")
abline(lm(Biomass ~ Depth.MLLW, data = Biomass_combined))
sum_lm <- summary (lm(Biomass ~ Depth.MLLW, data = Biomass_combined))
coef_lm <- sum_lm$coefficients
text(x = 7,
     y = 120,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 3 decimals
                     round(coef_lm[2,4],3),
                     "\ny = ",
                     #Round slope coefficient to 3 decimals
                     round(coef_lm[2,1],3),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

# Correlation between distance from natural reef and species Biomass
Biomass_noREF <- Biomass_combined[Biomass_combined$Treatment != "Reference",] 
plot(Biomass_noREF$Reef.dist_m, Biomass_noREF$Biomass, xlab = "Reef distance", ylab = "Biomass (kg/ha)", ylim = c(0, 100), main = "Biomass vs distance from natural reef (covariate)")
abline(lm(Biomass ~ Reef.dist_m, data = Biomass_noREF))
sum_lm <- summary (lm(Biomass ~ Reef.dist_m, data = Biomass_noREF))
coef_lm <- sum_lm$coefficients
text(x = 20,
     y = 70,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 2 decimals
                     round(coef_lm[2,4],2),
                     "\ny = ",
                     #Round slope coefficient to 2 decimals
                     round(coef_lm[2,1],1),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

# Correlation between distance from another AR and species Biomass
Biomass_ARonly <- Biomass_combined[Biomass_combined$Treatment == "AR",] 
plot(Biomass_ARonly$AR.dist_m, Biomass_ARonly$Biomass, xlab = "AR distance", ylab = "Biomass (kg/ha)", ylim = c(0, 150), main = "Biomass vs distance from another artifical reef (covariate)")
abline(lm(Biomass ~ AR.dist_m, data = Biomass_ARonly))
sum_lm <- summary (lm(Biomass ~ AR.dist_m, data = Biomass_ARonly))
coef_lm <- sum_lm$coefficients
text(x = 20,
     y = 120,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 2 decimals
                     round(coef_lm[2,4],2),
                     "\ny = ",
                     #Round slope coefficient to 2 decimals
                     round(coef_lm[2,1],1),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

rm(sum_lm)
```

## Statistical models
```{r}
# Version 3: log-link, first testing if Reef and AR distance without reference/control patches is significant
BmodelLoglink1 <- glmmTMB(GuildBiomass ~ Depth.MLLW + Reef.dist_m + AR.dist_m + YearGroup * Patch.type + DietH + (1 | Transect) + (1 | TransectDate:Observer), data = Biomass, family = tweedie(link="log"))

# Version 6: v3, taking only Reefdistance with proxies at reference
BmodelLoglink4 <- glmmTMB(GuildBiomass ~ Depth.MLLW + Reefdistance + YearGroup * Patch.type + DietH + (1 | Transect) + (1 | TransectDate:Observer), data = Biomass, dispformula = ~ DietH, family = tweedie(link="log"))

# Version 8: Two-way with YearGroup * DietH
BmodelLoglink6 <- glmmTMB(GuildBiomass ~ Depth.MLLW + YearGroup * DietH + Patch.type + (1 | Transect) + (1 | TransectDate:Observer), data = Biomass, family = tweedie(link="log"))

# Version 9: Two two-way with YearGroup * DietH & Yeargroup * Patch.type
BmodelLoglink7 <- glmmTMB(GuildBiomass ~ Depth.MLLW + YearGroup * DietH + YearGroup * Patch.type + (1 | Transect) + (1 | TransectDate:Observer), data = Biomass, family = tweedie(link="log"))

# Look at model
Anova(BmodelLoglink1) #<- Reef_distance is significant
summary(BmodelLoglink4)$coefficients$cond #<- Coefficient of Reefdistance is small, but has an influence: keeping
Anova(BmodelLoglink4) # Patch.type and DietH are significant, YearGroup and interaction aren't.
Anova(BmodelLoglink6) # Now DietH, Patch.type and the interaction YearGroup:DietH are significant.
Anova(BmodelLoglink7) # YearGroup:DietH is significant, YearGroup:Patch.type isn't.
 
# Normality & homoscedasticity for DHARMa
Bsim_resLoglink4 <- simulateResiduals(fittedModel = BmodelLoglink4, re.form = NULL)
Bsim_resLoglink6 <- simulateResiduals(fittedModel = BmodelLoglink6, re.form = NULL)
Bsim_resLoglink7 <- simulateResiduals(fittedModel = BmodelLoglink7, re.form = NULL)

# plot residuals
plot(Bsim_resLoglink4)
plot(Bsim_resLoglink6)
plot(Bsim_resLoglink7)
```
## Plots and post-hoc
```{r}
vc <- as.data.frame(VarCorr(BmodelLoglink7)$cond) # Variance random intercepts
sigma_re <- sqrt(sum(unlist(vc))) # Emmeans expects standard deviation

# 2. YearGroup:DietH interaction
emm_diet <- emmeans(BmodelLoglink7,~ YearGroup * DietH, type = "response",
                    bias.adjust = TRUE,
                    sigma = sigma_re)
cld_diet <- cld(emm_diet, by = "DietH", Letters = letters, 
                bias.adjust = TRUE,
                sigma = sigma_re)
emm_diet_df <- as.data.frame(cld_diet)
emm_diet_df$.group <- trimws(emm_diet_df$.group)

# 3. Patch.type main effect
emm_patch <- emmeans(BmodelLoglink7, ~ Patch.type, type = "response",
                     bias.adjust = TRUE,
                     sigma = sigma_re)
cld_patch <- cld(emm_patch, Letters = letters,
                 bias.adjust = TRUE,
                 sigma = sigma_re)
emm_patch_df <- as.data.frame(cld_patch)
emm_patch_df$.group <- trimws(emm_patch_df$.group)

# Plot 2: Yeargroup x DietH interaction
Bplot2 <- ggplot(emm_diet_df, aes(x = DietH, y = response, colour = YearGroup, shape = YearGroup, group = YearGroup)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                position = position_dodge(width = 0.5),
                width = 0.2) +
  geom_text(aes(label = .group, y = asymp.UCL),
            position = position_dodge(width = 0.5),
            vjust = -0.5,
            size = 5,
            show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = 0.1)) +
  labs(x = "Herbivore guild", y = expression(Biomass ~ (kg ~ ha^-1)),
       title = "Mean herbivore biomass over time, by guild") +
  guides(shape = guide_legend(title = "Year"), colour = guide_legend(title = "Year")) +
  theme_minimal(base_size = 12) +
  theme_bw()


# Plot 3: Patch.type main effect
Bplot3 <- ggplot(emm_patch_df, aes(x = Patch.type, y = response)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                position = position_dodge(width = 0.5),
                width = 0.2) +
  geom_text(aes(label = .group, y = asymp.UCL),
            position = position_dodge(width = 0.5),
            vjust = -0.5,
            size = 4.5,
            show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = 0.2)) +
  labs(x = "Reef design", y = expression(Biomass ~ (kg ~ ha^-1)) ,
       title = "Mean herbivore biomass by reef design") +
  theme_minimal(base_size = 12) +
  theme_bw()

# Post-hoc
print("=== Plot 2: YearGroup comparisons within each Guild ===")
posthoc_diet_within <- pairs(emm_diet, by = "DietH", adjust = "sidak",
                             bias.adjust = TRUE,
                             sigma = sigma_re)
# print(posthoc_diet_within)
posthoc_diet_within_df <- as.data.frame(posthoc_diet_within)
posthoc_diet_within_sig <- posthoc_diet_within_df[posthoc_diet_within_df$p.value < 0.05,]
print("Significant comparisons:")
print(posthoc_diet_within_sig)

print("=== Plot 2: Guild comparisons within each YearGroup ===")
posthoc_diet_between <- pairs(emm_diet, by = "YearGroup", adjust = "sidak",
                              bias.adjust = TRUE,
                              sigma = sigma_re)
# print(posthoc_diet_between)
posthoc_diet_between_df <- as.data.frame(posthoc_diet_between)
posthoc_diet_between_sig <- posthoc_diet_between_df[posthoc_diet_between_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_diet_between_sig)

print("=== Plot 3: Patch type comparisons ===")
posthoc_patch <- pairs(emm_patch, adjust = "sidak",
                       bias.adjust = TRUE,
                       sigma = sigma_re)
# print(posthoc_patch_between)
posthoc_patch_df <- as.data.frame(posthoc_patch)
posthoc_patch_sig <- posthoc_patch_df[posthoc_patch_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_patch_sig)

# Display plots
print(Bplot2)
print(Bplot3)
```
# Species richness
```{r}
# ---- DATA PREP ----
# Remove rows with non-herbivorous fish, and drop the "Other" level
Richness <- fish[fish$DietH != "Other",]
Richness <- droplevels(Richness)

all_combos <- expand_grid(
  SurveyNo = unique(Richness$SurveyNo),
  DietH = unique(Richness$DietH))

# Go from abundance to species richness, and bring back 0 values for groups without observations
## First store metadata
survey_meta <- Richness %>%
  dplyr::select(SurveyNo, Transect, Depth.MLLW, Reefdistance, ARdistance, Reef.dist_m, AR.dist_m, YearGroup, TransectDate, Patch.type, Treatment, Observer) %>%
  distinct()

## Count distinct herbivore species per herbivore guild per survey, and fill in 0 if there are none.
Richness <- Richness %>%
  group_by(SurveyNo, DietH) %>%
  summarise(GuildRichness = n_distinct(Species[Abundance > 0]),
            .groups = "drop") %>%
  right_join(all_combos, by = c("SurveyNo", "DietH")) 

## Bring back metadata lost in group_by
Richness <- Richness %>%
  left_join(survey_meta, by = "SurveyNo")
rm(survey_meta, all_combos)

```
## Pre-model plots
```{r}
# Add the different guilds together per survey
Richness_combined <- Richness %>%
  group_by(SurveyNo, Depth.MLLW, Treatment, Reef.dist_m, AR.dist_m) %>%
  summarise (Richness = sum(GuildRichness))

# Correlation between reef depth and species richness
plot(Richness_combined$Depth.MLLW, Richness_combined$Richness, xlab = "Depth", ylab = "Species richness", main = "Herbivore species richness vs Depth (covariate)")
abline(lm(Richness ~ Depth.MLLW, data = Richness_combined))
sum_lm <- summary (lm(Richness ~ Depth.MLLW, data = Richness_combined))
coef_lm <- sum_lm$coefficients
text(x = 7,
     y = 10,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 3 decimals
                     round(coef_lm[2,4],3),
                     "\ny = ",
                     #Round slope coefficient to 3 decimals
                     round(coef_lm[2,1],3),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

# Correlation between distance from natural reef and species richness
Richness_noREF <- Richness_combined[Richness_combined$Treatment != "Reference",] 
plot(Richness_noREF$Reef.dist_m, Richness_noREF$Richness, xlab = "Reef distance", ylab = "Species richness", main = "Herbivore species richness vs distance from natural reef (covariate)")
abline(lm(Richness ~ Reef.dist_m, data = Richness_noREF))
sum_lm <- summary (lm(Richness ~ Reef.dist_m, data = Richness_noREF))
coef_lm <- sum_lm$coefficients
text(x = 23,
     y = 8,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 3 decimals
                     round(coef_lm[2,4],3),
                     "\ny = ",
                     #Round slope coefficient to 3 decimals
                     round(coef_lm[2,1],3),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

# Correlation between distance from another AR and species richness
Richness_ARonly <- Richness_combined[Richness_combined$Treatment == "AR",] 
plot(Richness_ARonly$AR.dist_m, Richness_ARonly$Richness, xlab = "AR distance", ylab = "Species richness", main = "Herbivore species richness vs distance from another artifical reef (covariate)")
abline(lm(Richness ~ AR.dist_m, data = Richness_ARonly))
sum_lm <- summary (lm(Richness ~ AR.dist_m, data = Richness_ARonly))
coef_lm <- sum_lm$coefficients
text(x = 23,
     y = 8,
     labels = paste0("R^2 = ",
                     #Round r.squared to 2 decimals
                     round(sum_lm$r.squared,2),
                     "\np-value = ",
                     #Round p.value of slope to 3 decimals
                     round(coef_lm[2,4],3),
                     "\ny = ",
                     #Round slope coefficient to 3 decimals
                     round(coef_lm[2,1],3),
                     "x + ",
                     #Round intercept coefficient to 2 decimals
                     round(coef_lm[1,1],2)),
     pos = 4)

rm(sum_lm)

# Conclusion: only Depth has a significant and considerable effect as a covariate, omit reef and AR distances here

```
## Statistical models
```{r richness}
# Version 5: Conway-Maxwell Poisson, with distances including NA values (to test significance of distance effects)
RmodelCMP3 <- glmmTMB(GuildRichness ~ Depth.MLLW + YearGroup * Patch.type + Reef.dist_m +  AR.dist_m + DietH + (1 | Transect) + (1 | TransectDate:Observer), data=Richness, family=compois())

# Version 7: Conway-Maxwell Poisson, but without distances modeled.
RmodelCMP5 <- glmmTMB(GuildRichness ~ Depth.MLLW + YearGroup * Patch.type + DietH + (1 | Transect) + (1 | TransectDate:Observer), data=Richness, family=compois())

# Version 8: Conway-Maxwell Poisson, but without distances modeled.
RmodelCMP6 <- glmmTMB(GuildRichness ~ Depth.MLLW + YearGroup * DietH + Patch.type + (1 | Transect) + (1 | TransectDate:Observer), data=Richness, family=compois())

# Version 8: Conway-Maxwell Poisson, but without distances modeled.
RmodelCMP7 <- glmmTMB(GuildRichness ~ Depth.MLLW + YearGroup * DietH + YearGroup * Patch.type + (1 | Transect) + (1 | TransectDate:Observer), data=Richness, family=compois())

# Look at model
Anova(RmodelCMP3) # Reef_distance and AR_distance are insignificant
Anova(RmodelCMP5) # YearGroup, Patch.type and DietH are all significant, and the interaction as well
Anova(RmodelCMP6)
Anova(RmodelCMP7) # YearGroup:DietH & YearGroup:Patch.type are significant. Also consider standalone YearGroup plot.

# # Normality, heteroscedasticity with DHARMa
Rsim_resCMP5 <- simulateResiduals(fittedModel = RmodelCMP5, re.form = NULL)
Rsim_resCMP6 <- simulateResiduals(fittedModel = RmodelCMP6, re.form = NULL)
Rsim_resCMP7 <- simulateResiduals(fittedModel = RmodelCMP7, re.form = NULL)

# # plot residuals
plot(Rsim_resCMP5)
plot(Rsim_resCMP6)
plot(Rsim_resCMP7)
testResiduals(Rsim_resCMP5)

testZeroInflation(Rsim_resCMP5) # <- Not significant
testCategorical(Rsim_resCMP5, catPred = Richness$Depth.MLLW)
testCategorical(Rsim_resCMP5, catPred = Richness$YearGroup)
testCategorical(Rsim_resCMP5, catPred = Richness$Patch.type)
testCategorical(Rsim_resCMP5, catPred = Richness$DietH)
```

## Plots & post-hoc
```{r}
# 2. YearGroup:DietH interaction
emm_diet <- emmeans(RmodelCMP7, ~ YearGroup * DietH, type = "response")
cld_diet <- cld(emm_diet, by = "DietH", Letters = letters)
emm_diet_df <- as.data.frame(cld_diet)
emm_diet_df$.group <- trimws(emm_diet_df$.group)

# 3. YearGroup:Patch.type interaction
emm_patch <- emmeans(RmodelCMP7, ~ YearGroup * Patch.type, type = "response")
cld_patch <- cld(emm_patch, by = "Patch.type", Letters = letters)
emm_patch_df <- as.data.frame(cld_patch)
emm_patch_df$.group <- trimws(emm_patch_df$.group)

# Plot 2: Yeargroup x DietH interaction
Rplot2 <- ggplot(emm_diet_df, aes(x = DietH, y = response, colour = YearGroup, shape = YearGroup, group = YearGroup)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                position = position_dodge(width = 0.5),
                width = 0.2) +
  geom_text(aes(label = .group, y = asymp.UCL),
            position = position_dodge(width = 0.5),
            vjust = -0.5,
            size = 3,
            show.legend = FALSE) +
  labs(x = "Herbivore guild", y = "Species richness (S)") +
  guides(shape = guide_legend(title = "Year"), colour = guide_legend(title = "Year")) +
  theme_minimal(base_size = 12) +
  theme_bw()

# Plot 3: Yeargroup x patch.type interaction
Rplot3 <- ggplot(emm_patch_df, aes(x = Patch.type, y = response, colour = YearGroup, shape = YearGroup, group = YearGroup)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                position = position_dodge(width = 0.5),
                width = 0.2) +
  geom_text(aes(label = .group, y = asymp.UCL),
            position = position_dodge(width = 0.5),
            vjust = -0.5,
            size = 3,
            show.legend = FALSE) +
  labs(x = "Reef design", y = "Species richness (S)") +
  guides(shape = guide_legend(title = "Year"), colour = guide_legend(title = "Year")) +
  theme_minimal(base_size = 12) +
  theme_bw()

# # Post-hoc
print("=== Plot 2: YearGroup comparisons within each Guild ===")
posthoc_diet_within <- pairs(emm_diet, by = "DietH", adjust = "sidak")
# print(posthoc_diet_within)
posthoc_diet_within_df <- as.data.frame(posthoc_diet_within)
posthoc_diet_within_sig <- posthoc_diet_within_df[posthoc_diet_within_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_diet_within_sig)

print("=== Plot 2: Guild comparisons within each YearGroup ===")
posthoc_diet_between <- pairs(emm_diet, by = "YearGroup", adjust = "sidak")
# print(posthoc_diet_between)
posthoc_diet_between_df <- as.data.frame(posthoc_diet_between)
posthoc_diet_between_sig <- posthoc_diet_between_df[posthoc_diet_between_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_diet_between_sig)

print("=== Plot 3: YearGroup comparisons within each Patch type ===")
posthoc_patch_within <- pairs(emm_patch, by = "Patch.type", adjust = "sidak")
# print(posthoc_patch_within)
posthoc_patch_within_df <- as.data.frame(posthoc_patch_within)
posthoc_patch_within_sig <- posthoc_patch_within_df[posthoc_patch_within_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_patch_within_sig)

print("=== Plot 3: Patch type comparisons within each YearGroup ===")
posthoc_patch_between <- pairs(emm_patch, by = "YearGroup", adjust = "sidak")
# print(posthoc_patch_between)
posthoc_patch_between_df <- as.data.frame(posthoc_patch_between)
posthoc_patch_between_sig <- posthoc_patch_between_df[posthoc_patch_between_df$p.value < 0.05, ]
print("Significant comparisons:")
print(posthoc_patch_between_sig)

# Display plots
print(Rplot2)
print(Rplot3)
```
# Ordination plots (With YearGroups combined)
```{r}
# ---- DATA PREP, similar to Biomass ----
# Remove rows with non-herbivorous fish, and non-instantaneous observations
BiomassNMDS <- fish[fish$DietH != "Other" & fish$Coloured == 12,]

# Remove second/third observers on same survey to prevent pseudoreplication
## Make separate surveyNo list with observer and YearGroup
Surveys <- unique(fish[, c("SurveyNo", "Observer", "Transect", "YearGroup")])

## For surveys done with two people, only one is chosen (preferably the student, as they have done all)
Surveys <- Surveys %>%
  group_by(YearGroup, Transect) %>% 
  # choose the correct row per YearGroup + Transect
  filter(
    case_when(
      ## In 2021-2022, Jelle Rienstra did everything twice, so can use only him
      YearGroup == "2021–2022" ~ Observer == "Jelle Rienstra",
      ## In 2023-2024, if Anniek Leinenga did it > choose Anniek. If not > choose Ewout Knoester
      YearGroup == "2023–2024" ~ 
        if ("Anniek Leinenga" %in% Observer) {
          Observer == "Anniek Leinenga"
        } else {
          Observer == "Ewout Knoester"
        },
      ## In 2025, Jorn de Gelder did all of the surveys at least once, so can use only him
      YearGroup == "2025" ~ Observer == "Jorn de Gelder",
      TRUE ~ FALSE
    )
  ) %>%
  ungroup()

## Use only the selected surveys
BiomassNMDS <- BiomassNMDS %>%
  semi_join(Surveys, by = "SurveyNo")

# Getting rid of sizeclasses
## First store metadata
survey_meta <- BiomassNMDS %>%
  dplyr::select(SurveyNo, Transect, Depth.MLLW, Reef.dist_m, AR.dist_m, YearGroup, TransectDate, Patch.type, Treatment, Observer) %>%
  distinct()
metadata <- as.numeric(length(survey_meta))

## Sum biomass per species per survey
BiomassNMDS <- BiomassNMDS %>%
  group_by(SurveyNo, Species) %>%
  summarise(Biomass = sum(Biomass_kgha),
            .groups = "drop")

# Go to wide for Bray-Curtis dissimilarity
BiomassNMDS <- BiomassNMDS %>% pivot_wider( names_from = Species, values_from = Biomass)
BiomassNMDS[is.na(BiomassNMDS)] <- 0

# Remove surveys with no herbivorous fish & fish that have never been observed
empty_rows <- rowSums(BiomassNMDS[,-1]) == 0
empty_cols <- colSums(BiomassNMDS[,-1]) == 0
BiomassNMDS <- BiomassNMDS[ !empty_rows, ]
BiomassNMDS <- BiomassNMDS[ , c(TRUE, !empty_cols) ]

# Bring back metadata lost in group_by above
BiomassNMDS <- BiomassNMDS %>% left_join(survey_meta, by = "SurveyNo")
fishdata <- as.numeric(length(BiomassNMDS))
BiomassNMDS_data <- BiomassNMDS[2:(fishdata-metadata+1)]
rm(survey_meta)

BiomassNMDS_exclOUT <- BiomassNMDS[-c(147), ]
BiomassNMDS_data_exclOUT <- BiomassNMDS_data[-c(147), ]
```
## Statistical models
```{r}
# PERMANOVA
# Bray-Curtis distance
bray_dist <- vegdist(BiomassNMDS_data, method = "bray")

## Adonis
adonis_results <- adonis2(BiomassNMDS_data ~ Patch.type,
                          data = BiomassNMDS,
                          method = "bray",
                          permutations = 999)
print(adonis_results)

## Check homogeneity of dispersions
disp <- betadisper(bray_dist, BiomassNMDS$Patch.type)
disp_anova <- anova(disp)
print(disp_anova)

# PERMANOVA without outliers (sensitivity analysis)
# Bray-Curtis distance without outliers (sensitivity analysis)
bray_dist <- vegdist(BiomassNMDS_data_exclOUT, method = "bray")

## Adonis
adonis_results <- adonis2(BiomassNMDS_data_exclOUT ~ Patch.type,
                          data = BiomassNMDS_exclOUT,
                          method = "bray",
                          permutations = 999)
print(adonis_results)

## Check homogeneity of dispersions without outliers (sensitivity analysis)
disp <- betadisper(bray_dist, BiomassNMDS_exclOUT$Patch.type)
disp_anova <- anova(disp)
print(disp_anova)

## Post-hoc pairwise PERMANOVA for patch.type
pairwise_results <- pairwise.adonis(
  x = bray_dist,  
  factors = BiomassNMDS_exclOUT$Patch.type,
  p.adjust.m = "bonferroni")
print(pairwise_results)

## Post-hoc pairwise PERMANOVA for year group
pairwise_results <- pairwise.adonis(
  x = bray_dist,  
  factors = BiomassNMDS_exclOUT$YearGroup,
  p.adjust.m = "bonferroni")
print(pairwise_results)

# Make NMDS plot
nmds = metaMDS(BiomassNMDS_data_exclOUT, distance = "bray")
site.scores = as.data.frame(scores(nmds)$sites)
site.scores$Patch.type = BiomassNMDS_exclOUT$Patch.type
site.scores$YearGroup = BiomassNMDS_exclOUT$YearGroup
site.scores$SampleID <- rownames(site.scores)
species.scores <- as.data.frame(scores(nmds, display = "species"))
                        
## Get four samples with highest and lowest nMDS values:
coords <- as.data.frame(nmds$points)
outliers1High <- coords[order(coords$MDS1, decreasing = TRUE)[1:5], ]
outliers1Low <- coords[order(coords$MDS1, decreasing = FALSE)[1:5], ]
outliers2High <- coords[order(coords$MDS2, decreasing = TRUE)[1:7], ]
outliers2Low <- coords[order(coords$MDS2, decreasing = FALSE)[1:7], ]

## Make vectors for the guilds, but exclude the three outliers
### Make species:guild frame, to look up which species belongs to which guild
guild_lookup <- fish %>%
  dplyr::select(Species, DietH) %>%
  dplyr::filter(DietH != "Other") %>%
  dplyr::distinct() %>%
  dplyr::rename(Guild = DietH)

species.scores$Species <- rownames(species.scores)
species_guild <- merge(species.scores, guild_lookup, by = "Species")

# Calculate total biomass per species across all samples
species_biomass <- colSums(BiomassNMDS_data_exclOUT)  # Total biomass per species
species_biomass_df <- data.frame(
  Species = names(species_biomass),
  Biomass = species_biomass
)
species_scores_biomass <- merge(species.scores, species_biomass_df, by = "Species")

# Keep only top 10 species by total biomass
top10_species <- species_scores_biomass %>%
  arrange(desc(Biomass)) %>%
  slice_head(n = 10)

# Rescale font/point size by biomass within the top 10
top10_species$font_size <- scales::rescale(top10_species$Biomass, to = c(3, 5))

top10_species$NMDS1[top10_species$Species == "Hipposcarus harid"] <- 0.26
top10_species$NMDS2[top10_species$Species == "Hipposcarus harid"] <- 0.11
top10_species$Species[top10_species$Species == "Hipposcarus harid"] <- 
  "Hipposcarus harid (outlier)"

## Make guild-level biomass matrix
guild_biomass <- BiomassNMDS_data_exclOUT %>%
 t() %>%
 as.data.frame() %>%
 rownames_to_column("Species") %>%
 left_join(guild_lookup, by = "Species") %>%
 group_by(Guild) %>%
 summarise(across(-Species, sum)) %>%
 column_to_rownames("Guild") %>%
 t()  # transpose so rows = sites, cols = guilds

## Use envfit for the vectors
guild_envfit <- envfit(nmds, guild_biomass, permutations = 999)
print(guild_envfit)
vectors <- as.data.frame(scores(guild_envfit, display = "vectors"))
vectors$Guild <- rownames(vectors)
vectors_segments <- vectors %>%
 mutate(x = 0, y = 0, xend = NMDS1, yend = NMDS2)

pvals <- guild_envfit$vectors$pvals
vectors_segments$pval <- pvals
vectors_segments_sig <- subset(vectors_segments, pval < 0.05)

```

## Outlier plots for appendix
``` {r}
## Reef design
site.scores$highlight <- ifelse(site.scores$SampleID %in% c("175","170"), ## 
                                 as.character(site.scores$Patch.type), "Other")

outlierDesign <- ggplot(site.scores, aes(x = NMDS1, y = NMDS2)) +
  geom_point(size = 3, aes(colour = highlight, shape = highlight)) +
  geom_text(
    data = subset(site.scores, highlight != "Other"),
    aes(label = YearGroup),
    hjust = -0.3, size = 3.5, fontface = "bold"
  ) +
  theme(axis.text = element_text(size = 12, colour = "black"),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1.2)) +
  labs(x = "NMDS1", y = "NMDS2", colour = "Reef design", shape = "Reef design") +
  scale_colour_manual(values = c("BRU" = "#E69F00", "CAGE" = "#CC79A7", "COMP" = "#009E73", 
                                 "COMP" = "#F0E442", "Control" = "#0072B2", 
                                 "Reference" = "#000000", "Other" = "grey70")) +
  scale_shape_manual(values = c("BRU" = 16, "CAGE" = 17, "COMP" = 15, 
                                "Control" = 18, "Reference" = 8, "Other" = 19))

# ## YearGroup
# site.scores$highlight <- ifelse(site.scores$SampleID %in% c("175","170"),
#                                  as.character(site.scores$YearGroup), "Other")
# outlierYear <- ggplot(site.scores, aes(x = NMDS1, y = NMDS2)) +
#   geom_point(size = 3, aes(colour = highlight)) +
#   theme(axis.text = element_text(size = 12, colour = "black"),
#     axis.title = element_text(size = 14),
#     legend.text = element_text(size = 12),
#     legend.title = element_text(size = 14),
#     panel.background = element_blank(),
#     panel.border = element_rect(fill = NA, colour = "black", linewidth = 1.2)) +
#   labs(x = "NMDS1", y = "NMDS2", colour = "Year") +
#   scale_colour_manual(values = c(
#                       "2021–2022" = "#56B4E9",
#                       "2023–2024" = "#009E73",
#                       "2025"      = "#FF5733", 
#                       "Other" = "grey70"))

print(outlierDesign)
#print(outlierYear)
```
## Patch.type without dots
```{r}
# Start from full data and null out the outliers only for ellipse grouping
data_ell <- site.scores
data_ell$Patch.type[data_ell$SampleID %in% c("175","170")] <- NA  # mask them, don't drop

vectorfactor <- 0.3

# Build ellipse_df (unchanged)
ell <- ordiellipse(
  nmds,
  groups = data_ell$Patch.type,
  kind = "se",
  conf = 0.99,
  draw = "none"
)

ellipse_df <- do.call(rbind, lapply(names(ell), function(g) {
  df <- as.data.frame(
    vegan:::veganCovEllipse(ell[[g]]$cov, ell[[g]]$center, sqrt(qchisq(0.99, df = 2)))
  )
  colnames(df) <- c("NMDS1", "NMDS2")
  df$Patch.type <- g
  df
}))

wong_colors <- c(BRU = "#E69F00", CAGE = "#CC79A7", CAKE = "#009E73",
                 COMP = "#F0E442", Control = "#0072B2", Reference = "#000000")

main_plot <- ggplot() +
  geom_polygon_pattern(
    data = ellipse_df,
    aes(x = NMDS1, y = NMDS2, 
        fill = Patch.type, 
        colour = Patch.type,
        pattern = Patch.type,
        pattern_angle = Patch.type,
        pattern_spacing = Patch.type),
    alpha = 0.40,
    pattern_density = 0.3,
    pattern_fill = "white",
    pattern_colour = "grey30"
  ) +
  geom_segment(
    data = vectors_segments_sig,
    aes(x = x, y = y, xend = xend * vectorfactor, yend = yend * vectorfactor),
    arrow = arrow(length = unit(0.25, "cm")),
    colour = "red",
    inherit.aes = FALSE
  ) +
  geom_text(
    data = vectors_segments_sig,
    aes(x = xend * vectorfactor * 1.3, y = yend * vectorfactor * 1.3, label = Guild),
    colour = "red",
    hjust = 0.5,
    vjust = -0.5,
    inherit.aes = FALSE
  ) +
  geom_text_repel(
    data = top10_species,
    aes(x = NMDS1, y = NMDS2, label = Species),
    colour = "black",
    fontface = "plain",
    size = top10_species$font_size,
    inherit.aes = FALSE,
    show.legend = FALSE,
    max.overlaps = Inf,
    box.padding = 0.4,
    point.padding = NA,
    segment.colour = "grey50",
    segment.size = 0.3,
    bg.colour = "white",    
    bg.r = 0.15               
  ) +
  scale_colour_manual(values = wong_colors, name = "Reef design") +
  scale_fill_manual(values = wong_colors, name = "Reef design") +
  scale_pattern_manual(
    name = "Reef design",
    values = c(BRU = "stripe", CAGE = "stripe", CAKE = "stripe",
               COMP = "stripe", Control = "circle", Reference = "none")
  ) +
  scale_pattern_angle_manual(
    name = "Reef design",
    values = c(BRU = 45, CAGE = 90, CAKE = 135,
               COMP = 0, Control = 0, Reference = 0)
  ) +
  scale_pattern_spacing_manual(
    name = "Reef design",
    values = c(BRU = 0.02, CAGE = 0.02, CAKE = 0.03,
               COMP = 0.03, Control = 0.03, Reference = 0.05)
  ) +
  scale_size_identity() +
  theme(
    axis.text = element_text(size = 12, colour = "black"),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1.2)
  ) +
  labs(x = "NMDS1", y = "NMDS2")

main_plot
```
## YearGroup without dots
```{r}
data_ell <- site.scores
data_ell$YearGroup[data_ell$SampleID %in% c("175","170")] <- NA

ell <- ordiellipse(
  nmds,
  groups = data_ell$YearGroup,
  kind = "se",
  conf = 0.99,
  draw = "none"
)

vectorfactor <- 0.3

ellipse_df <- do.call(rbind, lapply(names(ell), function(g) {
  df <- as.data.frame(
    vegan:::veganCovEllipse(ell[[g]]$cov, ell[[g]]$center, sqrt(qchisq(0.99, df = 2)))
  )
  colnames(df) <- c("NMDS1", "NMDS2")
  df$YearGroup <- g
  df
}))

wong_colors_year <- c("2021–2022" = "#56B4E9",
                      "2023–2024" = "#009E73",
                      "2025"      = "#000000")

main_plot2 <- ggplot() +
  geom_polygon_pattern(
    data = ellipse_df,
    aes(x = NMDS1, y = NMDS2, 
        fill = YearGroup, 
        colour = YearGroup,
        pattern = YearGroup,
        pattern_angle = YearGroup,
        pattern_spacing = YearGroup),
    alpha = 0.40,
    pattern_density = 0.15,
    pattern_fill = "white",
    pattern_colour = "grey30",
    pattern_alpha = 0.6
  ) +
  geom_text_repel(
    data = top10_species,
    aes(x = NMDS1, y = NMDS2, label = Species),
    colour = "black",
    fontface = "plain",
    size = top10_species$font_size,
    inherit.aes = FALSE,
    show.legend = FALSE,
    max.overlaps = Inf,
    box.padding = 0.4,
    point.padding = NA,
    segment.colour = "grey50",
    segment.size = 0.3,
    bg.colour = "white",
    bg.r = 0.15
  ) +
  scale_colour_manual(values = wong_colors_year, name = "Year") +
  scale_fill_manual(values = wong_colors_year, name = "Year") +
  scale_pattern_manual(
    name = "Year",
    values = c("2021–2022" = "none", "2023–2024" = "stripe", "2025" = "stripe")
  ) +
  scale_pattern_angle_manual(
    name = "Year",
    values = c("2021–2022" = 0, "2023–2024" = 135, "2025" = 45)
  ) +
  scale_pattern_spacing_manual(
    name = "Year",
    values = c("2021–2022" = 0.02, "2023–2024" = 0.02, "2025" = 0.02)
  ) +
  guides(pattern_spacing = "none") +
  theme(
    axis.text = element_text(size = 12, colour = "black"),
    axis.title = element_text(size = 14),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    panel.background = element_blank(),
    panel.border = element_rect(fill = NA, colour = "black", linewidth = 1.2)
  ) +
  scale_x_continuous(limits = c(min(ellipse_df$NMDS1) - 0.05, NA)) +
  labs(x = "NMDS1", y = "NMDS2")

main_plot2
```
# Figure compilation
```{r compilation}
# Saving all ggplot plots
plots <- c("Rplot2", "Rplot3",
           "Aplot2", "Aplot3",
           "MSplot2", "MSplot3",
           "Bplot2", "Bplot3")

for(p in plots){
  # Get the actual plot object by name
  plot_obj <- get(p)
  
  # Save PNG
  ggsave(
    filename = file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/Noncombined_png", paste0(p, ".png")),
    plot     = plot_obj,
    width    = 7,
    height   = 5,
    dpi      = 600
  )
}

# Saving MSplot5
## Save PNG
ggsave(
    filename = file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/plots_png", paste0("MSplot5.png")),
    plot     = MSplot5,
    width    = 7,
    height   = 12,
    dpi      = 600
  )

## Tiff
ggsave(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/tiff", "MSplot5.tiff"),
      plot     = MSplot5,
      width    = 16,
      height   = 20,
       units = "cm", 
       dpi = 600,
       compression = "lzw")

# Saving nMDSplots (cowplot object) to same folders
## PNG
png(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/plots_png", "nMDSplot1.png"),
    width = 7, height = 5, units = "in", res = 600)
print(main_plot)
dev.off()

## Tiff
tiff(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/tiff", "nMDSplot1.tiff"),
     width = 8, height = 6, units = "in", res = 600, compression = "lzw")
print(main_plot)
dev.off()

## PNG
png(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/plots_png", "nMDSplot2.png"),
    width = 7, height = 5, units = "in", res = 600)
print(main_plot2)
dev.off()

## Tiff
tiff(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/tiff", "nMDSplot2.tiff"),
     width = 8, height = 6, units = "in", res = 600, compression = "lzw")
print(main_plot2)
dev.off()

## PNG
png(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/plots_png", "outlierplot.png"),
    width = 7, height = 5, units = "in", res = 600)
print(outlierDesign)
dev.off()

## Tiff
tiff(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/tiff", "outlierplot.tiff"),
     width = 8, height = 6, units = "in", res = 600, compression = "lzw")
print(outlierDesign)
dev.off()

## AMSB2 plots - no legends, remove titles, remove x-axis LABEL (but keep text) from top 3, add 10% y-expansion
Aplot2_notitle_nolegend <- Aplot2 + 
  labs(title = NULL, subtitle = NULL, x = NULL) + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 10, colour = "black", angle = 0, hjust = 0.5),
        axis.text.y = element_text(size = 10, colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15)))

MSplot2_notitle_nolegend <- MSplot2 + 
  labs(title = NULL, subtitle = NULL, x = NULL) + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 10, colour = "black", angle = 0, hjust = 0.5),
        axis.text.y = element_text(size = 10, colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15)))

Bplot2_notitle_nolegend <- Bplot2 + 
  labs(title = NULL, subtitle = NULL) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 10, colour = "black",angle = 0, hjust = 0.5),
        axis.text.y = element_text(size = 10, colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15)))

# AMSB3 plots - no legends, remove titles, remove x-axis LABEL (but keep text) from top 3, add 10% y-expansion
Aplot3_notitle_nolegend <- Aplot3 + 
  labs(title = NULL, subtitle = NULL, x = NULL) + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 10, colour = "black", angle = 0, hjust = 0.5),
        axis.text.y = element_text(size = 10, colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15)))

MSplot3_notitle_nolegend <- MSplot3 + 
  labs(title = NULL, subtitle = NULL, x = NULL) + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 10, colour = "black", angle = 0, hjust = 0.5),
        axis.text.y = element_text(size = 10, colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15)))

Bplot3_notitle_nolegend <- Bplot3 + 
  labs(title = NULL, subtitle = NULL) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 10, colour = "black", angle = 0, hjust = 0.5),
        axis.text.y = element_text(size = 10, colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15)))

# Richness combined plots - no legends, remove titles, remove x-axis LABEL (but keep text) from top 3, add 10% y-expansion
Rplot2_notitle_nolegend <- Rplot2 + 
  labs(title = NULL, subtitle = NULL) + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 10, colour = "black", angle = 0, hjust = 0.5),
        axis.text.y = element_text(size = 10, colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15)))

Rplot3_notitle_nolegend <- Rplot3 + 
  labs(title = NULL, subtitle = NULL) +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 10, colour = "black", angle = 0, hjust = 0.5),
        axis.text.y = element_text(size = 10, colour = "black")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15)))

# Extract legend from one of the plots (e.g., Rplot2_notitle)
legend_shared <- get_legend( Aplot2 + theme(legend.position = "top", 
          legend.direction = "horizontal",
          legend.spacing.x = unit(1, "cm")))

# Combine plots 2
AMSB2_plots <- plot_grid(Aplot2_notitle_nolegend, MSplot2_notitle_nolegend, Bplot2_notitle_nolegend, 
                  nrow = 3, 
                  align = "v", 
                  rel_heights = c(1, 1, 1.08),
                  labels = c("A", "B", "C"), 
                  label_size = 18,
                  label_x = 0.00,
                  label_y = 1.0)
AMSB2 <- plot_grid(legend_shared, AMSB2_plots,
                  nrow = 2, 
                  rel_heights = c(0.05, 1))  
print(AMSB2)

# Combine plots 3
AMSB3_plots <- plot_grid(Aplot3_notitle_nolegend, MSplot3_notitle_nolegend, Bplot3_notitle_nolegend, 
                  nrow = 3, 
                  align = "v", 
                  rel_heights = c(1, 1, 1.08),
                  labels = c("A", "B", "C"), 
                  label_size = 18,
                  label_x = 0.00,
                  label_y = 1.0)
AMSB3 <- plot_grid(legend_shared, AMSB3_plots,
                  nrow = 2, 
                  rel_heights = c(0.05, 1))  
print(AMSB3)

# Combine plots richness
R_plots <- plot_grid(Rplot2_notitle_nolegend, Rplot3_notitle_nolegend, 
                  nrow = 2, 
                  align = "v", 
                  rel_heights = c(1, 1),
                  labels = c("A", "B"), 
                  label_size = 18,
                  label_x = 0.00,
                  label_y = 1.0,
                  axis = "bt")
Rcomb <- plot_grid(legend_shared, R_plots,
                  nrow = 2, 
                  rel_heights = c(0.05, 1))  
print(Rcomb)

# Combine NMDS plots
# Extract panels without legends
plot1_panel <- main_plot + theme(legend.position = "none")
plot2_panel <- main_plot2 + theme(legend.position = "none")

# Extract legends
legend1 <- get_legend(main_plot)
legend2 <- get_legend(main_plot2)

# Create rows with plots and legends using different rel_widths
row1 <- plot_grid(plot1_panel, legend1, rel_widths = c(6, 1.5), nrow = 1)
row2 <- plot_grid(plot2_panel, legend2, rel_widths = c(6, 1.5), nrow = 1)

# Combine rows
NMDS_plots <- plot_grid(row1, row2,
                        nrow = 2,
                        align = "v",
                        axis = "lr",
                        labels = c("A", "B"),
                        label_size = 18,
                        label_x = 0.00,
                        label_y = 1.0)
print(NMDS_plots)

# Save them
ggsave(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/plots_png", "Combined_time_guild.png"), 
       AMSB2, width = 16, height = 20, units = "cm", dpi = 600)
ggsave(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/tiff", "Combined_time_guild.tiff"),
       AMSB2, 
       width = 16, 
       height = 20, 
       units = "cm", 
       dpi = 600,
       compression = "lzw")

ggsave(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/plots_png", "Combined_time_patch.png"), 
       AMSB3, width = 16, height = 20, units = "cm", dpi = 600)
ggsave(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/tiff", "Combined_time_patch.tiff"),
       AMSB3, 
       width = 16, 
       height = 20, 
       units = "cm", 
       dpi = 600,
       compression = "lzw")

ggsave(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/plots_png", "Combined_richness.png"), 
       Rcomb, width = 16, height = 10, units = "cm", dpi = 600)
ggsave(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/tiff", "Combined_richness.tiff"),
       Rcomb, 
       width = 16, 
       height = 20, 
       units = "cm", 
       dpi = 600,
       compression = "lzw")

ggsave(file.path("C:/Users/jornd/OneDrive - Wageningen University & Research/Thesis/Plots/tiff", "Combined_NMDS.tiff"),
       NMDS_plots, 
       width = 16, 
       height = 20, 
       units = "cm", 
       dpi = 600,
       compression = "lzw")
```

# Survey and species tables
``` {r}
## Survey table
surveylist <- fish %>% distinct(fish$SurveyNo, .keep_all = TRUE)
surveylist <- surveylist[c("SurveyNo", "Observer","Date", "YearGroup", "Transect")]
surveylist <- surveylist %>%
  group_by(YearGroup, Observer) %>%
  summarise(n_surveys = n(), .groups = 'drop')

## Species list
specieslist_sub <- as.data.frame(unique(fish$Species))
colnames(specieslist_sub) <- "Species"

specieslist_off <- as.data.frame(read_excel("Raw data/SpeciesList_2025-11.xlsx", sheet = "SpeciesList"))
specieslist_off$Species <- sub("\\.", "", specieslist_off$Species) # Remove points from species names
specieslist_off <- dplyr::select(specieslist_off, c("Family","Species", "Diet", "DietH"))
famspeciestmp <- left_join(specieslist_sub, specieslist_off)
famspeciestmp <- famspeciestmp[!grepl(" sp$", famspeciestmp$Species), ]

famspeciestmp <- famspeciestmp[order(famspeciestmp$Family),]
famspecies <- dplyr::select(famspeciestmp, c("Family","Species"))

## Herbivore species list
herbspecies <- famspeciestmp[!famspeciestmp$DietH %in% c("Other"), ]
colnames(herbspecies)[4] <- "Guild"
herbspecies <- herbspecies[order(herbspecies$Guild),]
herbspecies <- dplyr::select(herbspecies, c("Guild","Species"))

## Save to excel for Word tables
write.xlsx(famspecies, "C:/Users/Jorn de Gelder/OneDrive - Wageningen University & Research/Thesis/Content/Specieslist_report.xlsx")
write.xlsx(herbspecies,"C:/Users/Jorn de Gelder/OneDrive - Wageningen University & Research/Thesis/Content/Herbivorelist_report.xlsx")
```