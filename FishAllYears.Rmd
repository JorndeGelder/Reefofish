=======
title: Msc Thesis: The long-term impact of reef design on herbivorous fish biomass and mean size
author: Jorn de Gelder
date: 20/11/2025
>>>>>>> Stashed changes
output: html_document
---

#if on MSI laptop (Jorn)
setwd("C:/Users/Jorn de Gelder/Documents/Thesis R")

# Setup
```{r setup}
rm(list=ls()) # Clear workspace
knitr::opts_knit$set(root.dir = '/tmp') #Set directory at current directory for all subsequent chunks
options(scipen = 99) # Have all numbers in non-scientific notation

library(readxl) # Join data frames (vlookup)
library(cowplot) # Combine plots
library(data.table)
library(ggthemes) # pretty plots
library(flextable) # Layout word table
library(tidyverse) # Beta regression
library(vegan) # Export Excel
library(gridExtra)
library(emmeans) # Select text from string
library(lme4)
library(lmerTest) # GLS
library(officer) # Move table into word
library(gridGraphics) # Combine base and ggplots
library(tidyxl) # Read in coloured cells Excel
library(openxlsx)
library(car) # glm model validation
library(viridis) # Convert data from wide to long
library(pairwiseAdonis)
library(writexl) # Export Excel
library(janitor) # Excel functions
library(arrow) # Write & read Parquet
library(ggpubr) # for checking normality
library(influence.ME) # for checking influence and outliers

# Set colours for Treatments
#co <- c("#B0E54D", "#6FDCD9", "#F0C862", "#EC86BF", "#D04E08", "#0673B0", "#FF5733") # Added "#FF5733"

```

# Load RAW data (Only need to run after new raw data input: Takes about 30 mins)
```{r data load, warning= FALSE}

# ---- DATA 2017-2022 ----
## Load
### 2017-2018
fishRAW.2018 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2017-2018.xlsm", sheet = 3, skip = 6))
fish.2018 <- fishRAW.2018[!is.na(fishRAW.2018$Species),] # Remove irrelevant row
fish.2018 <- select(fish.2018, -c(1, 3:11)) # Remove irrelevant columns
fish.2018$Species <- sub("\\.", "", fish.2018$Species) # Remove points from species names

### 2019
fishRAW.2019 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2019.xlsm", sheet = 3, skip = 6))
fish.2019 <- fishRAW.2019[!is.na(fishRAW.2019$Species),] # Remove irrelevant row
fish.2019 <- select(fish.2019, -c(1, 3:11)) # Remove irrelevant columns
fish.2019$Species <- sub("\\.", "", fish.2019$Species) # Remove points from species names

### 2020
fishRAW.2020 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2020.xlsm", sheet = 3, skip = 6))
fish.2020 <- fishRAW.2020[!is.na(fishRAW.2020$Species),] # Remove irrelevant row
fish.2020 <- select(fish.2020, -c(1, 3:11)) # Remove irrelevant columns
fish.2020$Species <- sub("\\.", "", fish.2020$Species) # Remove points from species names

### 2021-2022
fishRAW.2021 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2021-2022.xlsm", sheet = 3, skip = 6))
fish.2021 <- fishRAW.2021[!is.na(fishRAW.2021$Species),] # Remove irrelevant row
fish.2021 <- select(fish.2021, -c(1, 3:11)) # Remove irrelevant columns
fish.2021$Species <- sub("\\.", "", fish.2021$Species) # Remove points from species names

## Merge all years
fish.2017_2022 <- left_join(fish.2018, fish.2019, by = "Species")
fish.2017_2022 <- left_join(fish.2017_2022, fish.2020, by = "Species")
fish.2017_2022 <- left_join(fish.2017_2022, fish.2021, by = "Species")

## Get rid of the columns not needed (pre-calculated biomasses)
fish.2017_2022 <- fish.2017_2022[, -grep(pattern= 'g_', colnames(fish.2017_2022))]
fish.2017_2022 <- fish.2017_2022[, -grep(pattern='kgha', colnames(fish.2017_2022))]
fish.2017_2022 <- fish.2017_2022[, -grep(pattern='TOT', colnames(fish.2017_2022))]

## Net NAs to 0 
fish.2017_2022[is.na(fish.2017_2022)] <- 0

## Set column names (NB: order of surveys won't match original Excel numbering anymore: start numbering at oldest survey years)
surveys.tot <- (ncol(fish.2017_2022) - 1)/13
colname <- c("Species", paste0(rep(c("1_", "2_", "3_", "4_", "5_", "6_", "7_", "8_", "9_", "10_", "11_", "12_", "Coloured_"),
                                     surveys.tot), rep(1:surveys.tot, each = 13)))
colnames(fish.2017_2022) <- colname

## Here try to sum all 10_ and 11_ and 12_, and add a column with the sum for later
for (i in 1:surveys.tot)
  {
  cols <- paste0(c("10_", "11_", "12_"), i)
  fish.2017_2022[[paste0("11num_", i)]] <- rowSums(fish.2017_2022[, cols])
  
  # Weighted mean column, safely handling sum == 0
  fish.2017_2022[[paste0("11size_", i)]] <- ifelse(
    fish.2017_2022[[paste0("11num_", i)]] == 0,
    0,
    (fish.2017_2022[[paste0("10_", i)]] * 75 +
     fish.2017_2022[[paste0("11_", i)]] * 125 +
     fish.2017_2022[[paste0("12_", i)]] * 175) /
      fish.2017_2022[[paste0("11num_", i)]]
  )
  
  # Reorder columns to place 11num_i and 11size_i after 12_i
  col_order <- names(fish.2017_2022)
  idx_12 <- which(col_order == paste0("12_", i))
  col_order <- append(col_order, c(paste0("11num_", i), paste0("11size_", i)), after = idx_12)
  col_order <- col_order[!duplicated(col_order)]
  fish.2017_2022 <- fish.2017_2022[, col_order]
}

## Go to long format
fish.2017_2022 <- setDT(fish.2017_2022)
fish.2017_2022 <- melt(fish.2017_2022, id.vars = 'Species', variable.name = 'SurveyNo', 
            measure.vars = patterns('^1_', '^2_', '^3_', '^4_', '^5_', '^6_',
                                    '^7_', '^8_', '^9_', '^10_', '^11_', '^12_','^11num_','^11size_', '^Coloured_'),
            value.name = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5',
                           '25', '35', '45', '75', '125', '175','65', 'SizeClass_11', 'Coloured'))
fish.2017_2022$Coloured[fish.2017_2022$Coloured == 0] <- 12 # Set non-coloured value (12) for missing data (new species)
fish.2017_2022$SurveyNo <- as.numeric(fish.2017_2022$SurveyNo)

# Get Size class from wide to long
fish.2017_2022 <- reshape2::melt(fish.2017_2022, id.vars = c('SurveyNo', 'Species', 'Coloured', 'SizeClass_11'), 
          measure.vars = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5', '25', '35', '45', '75', '125', '175','65'),
          variable.name = 'SizeClass', value.name = 'Abundance')

### Update taxonomy for re-named species
fish.2017_2022$Species <- ifelse(fish.2017_2022$Species == "Carangoides ferdau", "Ferdauia ferdau",
                 ifelse(fish.2017_2022$Species == "Carangoides fulvoguttatus", "Turrum fulvoguttatum",       
                 ifelse(fish.2017_2022$Species == "Carangoides orthogrammus", "Ferdauia orthogrammus",       
                 ifelse(fish.2017_2022$Species == "Cetoscarus bicolor", "Cetoscarus ocellatus",       
                 ifelse(fish.2017_2022$Species == "Chromis dimidiata", "Pycnochromis fieldi",       
                 ifelse(fish.2017_2022$Species == "Chromis lepidolepis", "Azurina lepidolepis",       
                 ifelse(fish.2017_2022$Species == "Chromis nigrura", "Pycnochromis nigrurus",       
                 ifelse(fish.2017_2022$Species == "Chromis xutha", "Pycnochromis agilis",       
                 ifelse(fish.2017_2022$Species == "Dascyllus aruanus", "Dascyllus abudafur",       
                 ifelse(fish.2017_2022$Species == "Heteropriacanthus cruentatus", "Heteropriacanthus carolinus",       
                 ifelse(fish.2017_2022$Species == "Neotrygon kuhlii", "Neotrygon indica",       
                 ifelse(fish.2017_2022$Species == "Plectroglyphidodon lacrymatus", "Stegastes lacrymatus",       
                 ifelse(fish.2017_2022$Species == "Pseudanthias evansi", "Mirolabrichthys evansi",       
                 ifelse(fish.2017_2022$Species == "Ulua mentalis", "Atropis mentalis",
                 ifelse(fish.2017_2022$Species == "Unknown parrotfish", "Scarus sp",
                 ifelse(fish.2017_2022$Species == "Pomacentrus aquilus", "Chrysiptera sp", 
                 ifelse(fish.2017_2022$Species == "Pomacentrus philippinus", "Neopomacentrus cyanomos", 
                 ifelse(fish.2017_2022$Species == "Pempheris nesogallica", "Pempheris sp", 
                 ifelse(fish.2017_2022$Species == "Upeneus tragula", "Upeneus heemstra",                         
                        fish.2017_2022$Species)))))))))))))))))))
fish.2017_2022 <- subset(fish.2017_2022, Species != "NEW SPECIES")

# Pomacentrus aquilus & phillipinus as well as Pempheris nesogallica are special cases, because they have to get merged with an already existing entry, being probably misidentified earlier. First we determine whether to add up the counts, based on if and when they were observed.
# Target species
target_species <- c("Chrysiptera sp", "Neopomacentrus cyanomos", "Pempheris sp")

fish.2017_2022 <- fish.2017_2022 %>%
  # Step 1: calculate sum11 and sum12 for each species per SurveyNo
  group_by(SurveyNo, Species) %>%
  mutate(
    sum11 = if_else(Species %in% target_species,
                    sum(Abundance[Coloured == 11], na.rm = TRUE),
                    NA_real_),
    sum12 = if_else(Species %in% target_species,
                    sum(Abundance[Coloured == 12], na.rm = TRUE),
                    NA_real_)
  ) %>%
  ungroup() %>%
  
  # Step 2: filter rows according to the same rules as before
  filter(
    !(Species %in% target_species & (
        (sum11 > 0 & sum12 > 0 & Coloured == 11) |
        (sum11 > 0 & sum12 == 0 & Coloured == 12) |
        (sum11 == 0 & sum12 > 0 & Coloured == 11) |
        (sum11 == 0 & sum12 == 0 & Coloured == 11)
      ))
  ) %>%
  select(-sum11, -sum12) %>%
  
  # Step 3: combine abundances for duplicate SizeClass rows within target species
  group_by(SurveyNo, Species, SizeClass) %>%
  mutate(
    Abundance = if_else(Species %in% target_species, sum(Abundance, na.rm = TRUE), Abundance)
  ) %>%
  filter(!(Species %in% target_species & duplicated(SizeClass))) %>%
  ungroup()

# ==== Meta data 2017-2022 ====
## Load
meta.2018 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2017-2018.xlsm", sheet = "Data")) # 2018
meta.2019 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2019.xlsm", sheet = "Data")) # 2019 
meta.2020 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2020.xlsm", sheet = "Data")) # 2020
meta.2021 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2021-2022.xlsm", sheet = "Data")) # 2021 
meta.2021 <- meta.2021[!is.na(meta.2021$Date),] # Remove empty rows

## Merge years
meta.2017_2022 <- rbind(meta.2018, meta.2019, meta.2020, meta.2021)

## Clean up
meta.2017_2022$SurveyNo <- as.numeric(seq(1, surveys.tot, by = 1))
meta.2017_2022 <- meta.2017_2022[,c("SurveyNo", "Date", "Location", "Transect", "Observer", "Radius", "Area", "Comments")] # Select columns

## Add meta data to main dataframe
fish.2017_2022 <- merge(fish.2017_2022, meta.2017_2022, all.x=T, by='SurveyNo')

# ==== Species information ====
## Load and clean
specieslist <- as.data.frame(read_excel("Raw data/SpeciesList_2025-11.xlsx", sheet = "SpeciesList"))
specieslist$Species <- sub("\\.", "", specieslist$Species) # Remove points from species names
specieslist <- select(specieslist, c("Species", "Diet", "DietH", "a", "b"))

## Add species data to main dataframe
fish.2017_2022 <- merge(fish.2017_2022, specieslist, all.x=T, by='Species')

# ==== Calculate biomass ====
# Make all rows numeric for biomass calculations & remove duplicates for Sizeclass 11
fish.2017_2022$SizeClass <- as.numeric(as.character(fish.2017_2022$SizeClass))
fish.2017_2022$SizeClass_11 <- ifelse(fish.2017_2022$SizeClass == 65, fish.2017_2022$SizeClass_11, 0)

# Select all rows where SizeClass is 65 (Class 11-proxy)
temp_df <- fish.2017_2022[fish.2017_2022$SizeClass %in% c("65"), ]

# Remove these rows from the original dataframe
fish.2017_2022 <- fish.2017_2022[!fish.2017_2022$SizeClass %in% c("65"), ]

## Calculate biomass using the length-weight formula W = a * L^b, multiply per abundance and standardize to kg/ha
fish.2017_2022$Biomass_kgha <- ((((fish.2017_2022$a * (fish.2017_2022$SizeClass ^ fish.2017_2022$b)) * fish.2017_2022$Abundance)/ fish.2017_2022$Area)/1000)* 10000

## Standardize abundance
fish.2017_2022$Abundance_m2 <- fish.2017_2022$Abundance/fish.2017_2022$Area

# Standardize abundance for the temporary file with sizeclass 11
temp_df$Abundance_m2 <-temp_df$Abundance/temp_df$Area

# Calculate biomass for sizeclass 11
biomass_sum <- fish.2017_2022 %>%
  filter(SizeClass %in% c(75, 125, 175)) %>%
  group_by(SurveyNo, Species) %>%
  summarise(total_biomass = sum(Biomass_kgha, na.rm = TRUE), .groups = "drop")

# Join biomass_sum to temp_df by SurveyNo and Species
temp_df <- temp_df %>%
  left_join(biomass_sum, by = c("SurveyNo", "Species"))

# Rename the summed column to Biomass_kgha
temp_df <- temp_df %>%
  rename(Biomass_kgha = total_biomass)

#Add the temporary dataframe back to the original dataframe
fish.2017_2022 <- bind_rows(fish.2017_2022, temp_df)
rm(temp_df)

# Considering there is no class 10 in the old system, we use the removable class 75 to become 55.
fish.2017_2022$SizeClass[fish.2017_2022$SizeClass == "75"] <- "55"
fish.2017_2022$Abundance[fish.2017_2022$SizeClass == "55"] <- 0
fish.2017_2022$Abundance_m2[fish.2017_2022$SizeClass == "55"] <- 0
fish.2017_2022$Biomass_kgha[fish.2017_2022$SizeClass == "55"] <- 0
fish.2017_2022$SizeClass_11[fish.2017_2022$SizeClass == "55"] <- 0

# Remove rows where SizeClass is 125, or 175 (75 has been used to make missing 55 (Class 10) row)
fish.2017_2022 <- fish.2017_2022 %>%
  filter(!SizeClass %in% c("125", "175"))

## Cleanup
fish.2017_2022 <- select(fish.2017_2022, - c("a", "b"))

# ---- DATA 2023-2025 ----
# ---2023-2024---
# Get raw data and formats
fishRaw.2023 <- xlsx_cells("Raw data/Fish surveys_DATABASE_2023-2024_0.xlsx") # Includes all sheets and styles
fish.2023 <- subset(fishRaw.2023, sheet == "INPUT Sheet") # Data including both Non & Instantaneous observations)
fish.2023format <- xlsx_formats("Raw data/Fish surveys_DATABASE_2023-2024_0.xlsx") # Formats of all sheets

# Identify non-instantaneous data
## Identify coloured cells
Fish.2023_ColouredCells <- fish.2023 %>% 
  filter(local_format_id %in% which(!is.na(fish.2023format$local$fill$patternFill$fgColor$rgb))) %>%
  select(address, row, col, data_type)
## Label them 12 (instantaneous) or 11 (non-instantaneous)
fish.2023$Coloured <- ifelse(fish.2023$address %in% Fish.2023_ColouredCells$address, 11, 12)

## Tidy data
fish.2023 <- subset(fish.2023, row > 2) # Remove first two rows row (survey number & size classes)
fish.2023 <- select(fish.2023, c("row", "col", "character", "numeric", "Coloured")) # Select relevant columns
Fish.2023_speciesList <- na.omit(fish.2023$character) # Save species list for later use
fish.2023 <- select(fish.2023, -c("character")) # Remove species column
fish.2023 <- subset(fish.2023, col > 1) # Remove species column values
fish.2023$row <- fish.2023$row - 2 # Renumber rows to start at 1
fish.2023$col <- fish.2023$col - 1 # Renumber columns to start at 1

# To wide format
fish.2023 <- as.data.frame(fish.2023) # Go from tibble back to dataframe
fish.2023 <- reshape(fish.2023, idvar = c("row"), timevar = "col", direction = "wide") # To wide format (takes 2 mins)

# Set column names
fish.2023_surveys.tot <- (ncol(fish.2023) - 1)/24
fish.2023_colname <- c("Species", paste0(rep(c("c1_", "Coloured_c1_", "c2_", "Coloured_c2_", "c3_", "Coloured_c3_", "c4_", "Coloured_c4_", "c5_", "Coloured_c5_", "c6_", "Coloured_c6_", "c7_", "Coloured_c7_", "c8_", "Coloured_c8_", "c9_", "Coloured_c9_", "c10_", "Coloured_c10_", "c11num_", "Coloured_c11num_", "c11size_", "Coloured_c11size_"), fish.2023_surveys.tot), rep(1:fish.2023_surveys.tot, each = 24)))
colnames(fish.2023) <- fish.2023_colname

# To long format
fish.2023 <- setDT(fish.2023)
fish.2023 <- melt(fish.2023, 
            id.vars = 'Species', variable.name = 'SurveyNo', 
            measure.vars = patterns('^c1_', "Coloured_c1_", '^c2_', "Coloured_c2_", '^c3_', "Coloured_c3_", '^c4_', "Coloured_c4_", '^c5_', "Coloured_c5_", '^c6_', "Coloured_c6_", '^c7_', "Coloured_c7_", '^c8_', "Coloured_c8_", '^c9_', "Coloured_c9_", '^c10_', "Coloured_c10_", '^c11num_', "Coloured_c11num_", '^c11size_', "Coloured_c11size_"),
            value.name = c('1.25', 'Coloured_1.25', '3.75', 'Coloured_3.75', '6.25', 'Coloured_6.25', '8.75', 'Coloured_8.75', '12.5', 'Coloured_12.5', '17.5',  'Coloured_17.5', '25', 'Coloured_25', '35', 'Coloured_35', '45', 'Coloured_45', '55', 'Coloured_55',  '65',  'Coloured_65', 'SizeClass_11',  'Coloured_SizeClass_11'))

# Check & summarize if any of the size classes had a coloured cell
fish.2023$Coloured <- ifelse(fish.2023$Coloured_1.25 + fish.2023$Coloured_3.75 + fish.2023$Coloured_6.25 + fish.2023$Coloured_8.75 + fish.2023$Coloured_12.5 + fish.2023$Coloured_17.5 + fish.2023$Coloured_25 + fish.2023$Coloured_35 + fish.2023$Coloured_45 + fish.2023$Coloured_55 + fish.2023$Coloured_65 + fish.2023$Coloured_SizeClass_11 == 144, 12, 11)
fish.2023 <- dplyr::select(fish.2023, -c("Coloured_1.25", "Coloured_3.75", "Coloured_6.25", "Coloured_8.75", "Coloured_12.5", "Coloured_17.5", "Coloured_25", "Coloured_35", "Coloured_45", "Coloured_55", "Coloured_65", "Coloured_SizeClass_11"))

# Get Size class from wide to long
fish.2023 <- reshape2::melt(fish.2023, id.vars = c('SurveyNo', 'Species', 'Coloured', 'SizeClass_11'), 
          measure.vars = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5', '25', '35', '45', '55', '65'),
          variable.name = 'SizeClass', value.name = 'Abundance')

#Remove duplicates in SizeClass 65 (Class 11-proxy)
fish.2023$SizeClass_11 <- ifelse(fish.2023$SizeClass == 65, fish.2023$SizeClass_11, 0)

# ==== Add meta data ====
## Re-add species names in data frame
fish.2023$Species <- Fish.2023_speciesList # Added based on original order (!)
fish.2023$Species <- sub("\\.", "", fish.2023$Species) # Remove points from species names

### Update taxonomy for re-named or previously misidentified species
fish.2023$Species <-   ifelse(fish.2023$Species == "Pycnochromis dimidiatus", "Pycnochromis fieldi",
                       ifelse(fish.2023$Species == "Upeneus tragula", "Upeneus heemstra",
                              fish.2023$Species))

## Species metadata
fish.2023 <- merge(fish.2023, specieslist, all.x=T, by='Species') # Combine data and specieslist data frames
fish.2023$SizeClass <- as.numeric(paste(fish.2023$SizeClass)) # Set a numeric Length

## Add survey info
meta.2023 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2023-2024_0.xlsx", sheet = "Data")) 
meta.2023 <- meta.2023[!is.na(meta.2023$Date),] # Remove empty rows
colnames(meta.2023)[1] <- "SurveyNo" 
meta.2023 <- meta.2023[,c("SurveyNo", "Date", "Location", "Transect", "Observer", "Radius", "Area", "Comments")] # Select relevant columns
fish.2023 <- merge(fish.2023, meta.2023, all.x=T, by='SurveyNo')

# ==== Calculate biomass ====
## Size class 65 serves as a proxy for the largest class, the actual size is taken from the SizeClass_11 variable
fish.2023$Biomass_kgha <- ifelse(
  fish.2023$SizeClass == 65,
  ((((fish.2023$a * (fish.2023$SizeClass_11 ^ fish.2023$b)) *
      fish.2023$Abundance) / fish.2023$Area) / 1000) * 10000,
  ((((fish.2023$a * (fish.2023$SizeClass ^ fish.2023$b)) *
      fish.2023$Abundance) / fish.2023$Area) / 1000) * 10000
)

## Standardize abundance
fish.2023$Abundance_m2 <- fish.2023$Abundance/fish.2023$Area

## Cleanup
fish.2023 <- select(fish.2023, - c("a", "b"))
fish.2023 <- fish.2023 %>% drop_na(Abundance_m2) # Drop empty rows for surveys not yet done

# ---2024-2025---
# Change empty cells into zeros (needed to correctly read in the data in consecutive steps)
## Read observation block only (starting from row 3, column 2)
input_file <- "Raw data/Fish surveys_DATABASE_2024-2025 (2025-05).xlsx"   # your original, styled file
raw_obs <- read_excel(input_file, sheet = "INPUT Sheet", col_names = FALSE) # Takes ~2 mins
obs_block <- raw_obs[-c(1, 2), -1, drop = FALSE]  # remove first two rows and first column
obs_block <- as.data.frame(obs_block, stringsAsFactors = FALSE)

# Step 2: Clean observation block (convert to numeric, replace blanks with 0)
obs_block[] <- lapply(obs_block, function(col) {
  col[col == ""] <- NA
  suppressWarnings(as.numeric(replace(col, is.na(col), 0)))
})

# Step 3: Load the workbook with formatting intact
wb <- loadWorkbook(input_file) # Takes a few minutes

# Step 4: Write cleaned values into the same cells (preserving formatting)
writeData(
  wb, 
  sheet = "INPUT Sheet", 
  x = obs_block, 
  startRow = 3, 
  startCol = 2, 
  colNames = FALSE
)

## Step 5: Save updated file
saveWorkbook(wb, "Raw data/Fish surveys_DATABASE_2024-2025 (2025-05)_0.xlsx", overwrite = TRUE)

# Get raw data and formats
fishRaw.2024 <- xlsx_cells("Raw data/Fish surveys_DATABASE_2024-2025 (2025-05)_0.xlsx") # Includes all sheets and styles
fish.2024 <- subset(fishRaw.2024, sheet == "INPUT Sheet") # Data including both Non & Instantaneous observations)
fish.2024format <- xlsx_formats("Raw data/Fish surveys_DATABASE_2024-2025 (2025-05)_0.xlsx") # Formats of all sheets

# Identify non-instantaneous data
## Identify coloured cells
Fish.2024_ColouredCells <- fish.2024 %>% 
  filter(local_format_id %in% which(!is.na(fish.2024format$local$fill$patternFill$fgColor$rgb))) %>%
  select(address, row, col, data_type)
## Label them 12 (instantaneous) or 11 (non-instantaneous)
fish.2024$Coloured <- ifelse(fish.2024$address %in% Fish.2024_ColouredCells$address, 11, 12)

## Tidy data
fish.2024 <- subset(fish.2024, row > 2) # Remove first two rows row (survey number & size classes)
fish.2024 <- select(fish.2024, c("row", "col", "character", "numeric", "Coloured")) # Select relevant columns
Fish.2024_speciesList <- na.omit(fish.2024$character) # Save species list for later use
fish.2024 <- select(fish.2024, -c("character")) # Remove species column
fish.2024 <- subset(fish.2024, col > 1) # Remove species column values
fish.2024$row <- fish.2024$row - 2 # Renumber rows to start at 1
fish.2024$col <- fish.2024$col - 1 # Renumber columns to start at 1

# To wide format
fish.2024 <- as.data.frame(fish.2024) # Go from tibble back to dataframe
fish.2024 <- reshape(fish.2024, idvar = c("row"), timevar = "col", direction = "wide") # To wide format (takes 2 mins)

# Set column names
fish.2024_surveys.tot <- (ncol(fish.2024) - 1)/24
fish.2024_colname <- c("Species", paste0(rep(c("c1_", "Coloured_c1_", "c2_", "Coloured_c2_", "c3_", "Coloured_c3_", "c4_", "Coloured_c4_", "c5_", "Coloured_c5_", "c6_", "Coloured_c6_", "c7_", "Coloured_c7_", "c8_", "Coloured_c8_", "c9_", "Coloured_c9_", "c10_", "Coloured_c10_", "c11num_", "Coloured_c11num_", "c11size_", "Coloured_c11size_"), fish.2024_surveys.tot), rep(1:fish.2024_surveys.tot, each = 24)))
colnames(fish.2024) <- fish.2024_colname

# To long format
fish.2024 <- setDT(fish.2024)
fish.2024 <- melt(fish.2024, 
            id.vars = 'Species', variable.name = 'SurveyNo', 
            measure.vars = patterns('^c1_', "Coloured_c1_", '^c2_', "Coloured_c2_", '^c3_', "Coloured_c3_", '^c4_', "Coloured_c4_", '^c5_', "Coloured_c5_", '^c6_', "Coloured_c6_", '^c7_', "Coloured_c7_", '^c8_', "Coloured_c8_", '^c9_', "Coloured_c9_", '^c10_', "Coloured_c10_", '^c11num_', "Coloured_c11num_", '^c11size_', "Coloured_c11size_"),
            value.name = c('1.25', 'Coloured_1.25', '3.75', 'Coloured_3.75', '6.25', 'Coloured_6.25', '8.75', 'Coloured_8.75', '12.5', 'Coloured_12.5', '17.5',  'Coloured_17.5', '25', 'Coloured_25', '35', 'Coloured_35', '45', 'Coloured_45', '55', 'Coloured_55',  '65',  'Coloured_65', 'SizeClass_11',  'Coloured_SizeClass_11'))

# Check & summarize if any of the size classes had a coloured cell
fish.2024$Coloured <- ifelse(fish.2024$Coloured_1.25 + fish.2024$Coloured_3.75 + fish.2024$Coloured_6.25 + fish.2024$Coloured_8.75 + fish.2024$Coloured_12.5 + fish.2024$Coloured_17.5 + fish.2024$Coloured_25 + fish.2024$Coloured_35 + fish.2024$Coloured_45 + fish.2024$Coloured_55 + fish.2024$Coloured_65 + fish.2024$Coloured_SizeClass_11 == 144, 12, 11)
fish.2024 <- dplyr::select(fish.2024, -c("Coloured_1.25", "Coloured_3.75", "Coloured_6.25", "Coloured_8.75", "Coloured_12.5", "Coloured_17.5", "Coloured_25", "Coloured_35", "Coloured_45", "Coloured_55", "Coloured_65", "Coloured_SizeClass_11"))

# Get Size class from wide to long
fish.2024 <- reshape2::melt(fish.2024, id.vars = c('SurveyNo', 'Species', 'Coloured', 'SizeClass_11'), 
          measure.vars = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5', '25', '35', '45', '55', '65'),
          variable.name = 'SizeClass', value.name = 'Abundance')

#Remove duplicates in SizeClass 65 (Class 11-proxy)
fish.2024$SizeClass_11 <- ifelse(fish.2024$SizeClass == 65, fish.2024$SizeClass_11, 0)

# ==== Add meta data ====
## Re-add species names in data frame
fish.2024$Species <- Fish.2024_speciesList # Added based on original order (!)
fish.2024$Species <- sub("\\.", "", fish.2024$Species) # Remove points from species names

### Update taxonomy for re-named or previously misidentified species
fish.2024$Species <-   ifelse(fish.2024$Species == "Pycnochromis dimidiatus", "Pycnochromis fieldi",
                       ifelse(fish.2024$Species == "Upeneus tragula", "Upeneus heemstra",
                              fish.2024$Species))

## Species metadata
fish.2024 <- merge(fish.2024, specieslist, all.x=T, by='Species') # Combine data and specieslist data frames
fish.2024$SizeClass <- as.numeric(paste(fish.2024$SizeClass)) # Set a numeric Length

## Add survey info
meta.2024 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2024-2025 (2025-05)_0.xlsx", sheet = "Data")) 
meta.2024 <- meta.2024[!is.na(meta.2024$Date),] # Remove empty rows
colnames(meta.2024)[1] <- "SurveyNo" 
meta.2024 <- meta.2024[,c("SurveyNo", "Date", "Location", "Transect", "Observer", "Radius", "Area", "Comments")] # Select relevant columns
fish.2024 <- merge(fish.2024, meta.2024, all.x=T, by='SurveyNo')

# ==== Calculate biomass ====
## Size class 65 serves as a proxy for the largest class, the actual size is taken from the SizeClass_11 variable
fish.2024$Biomass_kgha <- ifelse(
  fish.2024$SizeClass == 65,
  ((((fish.2024$a * (fish.2024$SizeClass_11 ^ fish.2024$b)) *
      fish.2024$Abundance) / fish.2024$Area) / 1000) * 10000,
  ((((fish.2024$a * (fish.2024$SizeClass ^ fish.2024$b)) *
      fish.2024$Abundance) / fish.2024$Area) / 1000) * 10000
)

## Standardize abundance
fish.2024$Abundance_m2 <- fish.2024$Abundance/fish.2024$Area

## Cleanup
fish.2024 <- select(fish.2024, - c("a", "b"))
fish.2024 <- fish.2024 %>% drop_na(Abundance_m2) # Drop empty rows for surveys not yet done

# ---2025-2026---

# Change empty cells into zeros (needed to correctly read in the data in consecutive steps)
## Read observation block only (starting from row 3, column 2)
input_file <- "Raw data/Fish surveys_DATABASE_2025-2026.xlsx"   # your original, styled file
raw_obs <- read_excel(input_file, sheet = "INPUT Sheet", col_names = FALSE) # Takes ~2 mins
obs_block <- raw_obs[-c(1, 2), -1, drop = FALSE]  # remove first two rows and first column
obs_block <- as.data.frame(obs_block, stringsAsFactors = FALSE)

# Step 2: Clean observation block (convert to numeric, replace blanks with 0)
obs_block[] <- lapply(obs_block, function(col) {
  col[col == ""] <- NA
  suppressWarnings(as.numeric(replace(col, is.na(col), 0)))
})

# Step 3: Load the workbook with formatting intact
wb <- loadWorkbook(input_file)

# Step 4: Write cleaned values into the same cells (preserving formatting)
writeData(
  wb, 
  sheet = "INPUT Sheet", 
  x = obs_block, 
  startRow = 3, 
  startCol = 2, 
  colNames = FALSE
)

## Step 5: Save updated file
saveWorkbook(wb, "Raw data/Fish surveys_DATABASE_2025-2026_0.xlsx", overwrite = TRUE)

# Get raw data and formats
fishRaw.2025 <- xlsx_cells("Raw data/Fish surveys_DATABASE_2025-2026_0.xlsx") # Includes all sheets and styles
fish.2025 <- subset(fishRaw.2025, sheet == "INPUT Sheet") # Data including both Non & Instantaneous observations)
fish.2025format <- xlsx_formats("Raw data/Fish surveys_DATABASE_2025-2026_0.xlsx") # Formats of all sheets

# Identify non-instantaneous data
## Identify coloured cells
Fish.2025_ColouredCells <- fish.2025 %>% 
  filter(local_format_id %in% which(!is.na(fish.2025format$local$fill$patternFill$fgColor$rgb))) %>%
  select(address, row, col, data_type)
## Label them 12 (instantaneous) or 11 (non-instantaneous)
fish.2025$Coloured <- ifelse(fish.2025$address %in% Fish.2025_ColouredCells$address, 11, 12)

## Tidy data
fish.2025 <- subset(fish.2025, row > 2) # Remove first two rows row (survey number & size classes)
fish.2025 <- select(fish.2025, c("row", "col", "character", "numeric", "Coloured")) # Select relevant columns
Fish.2025_speciesList <- na.omit(fish.2025$character) # Save species list for later use
fish.2025 <- select(fish.2025, -c("character")) # Remove species column
fish.2025 <- subset(fish.2025, col > 1) # Remove species column values
fish.2025$row <- fish.2025$row - 2 # Renumber rows to start at 1
fish.2025$col <- fish.2025$col - 1 # Renumber columns to start at 1

# To wide format
fish.2025 <- as.data.frame(fish.2025) # Go from tibble back to dataframe
fish.2025 <- reshape(fish.2025, idvar = c("row"), timevar = "col", direction = "wide") # To wide format (takes 2 mins)

# Set column names
fish.2025_surveys.tot <- (ncol(fish.2025) - 1)/24
fish.2025_colname <- c("Species", paste0(rep(c("c1_", "Coloured_c1_", "c2_", "Coloured_c2_", "c3_", "Coloured_c3_", "c4_", "Coloured_c4_", "c5_", "Coloured_c5_", "c6_", "Coloured_c6_", "c7_", "Coloured_c7_", "c8_", "Coloured_c8_", "c9_", "Coloured_c9_", "c10_", "Coloured_c10_", "c11num_", "Coloured_c11num_", "c11size_", "Coloured_c11size_"), fish.2025_surveys.tot), rep(1:fish.2025_surveys.tot, each = 24)))
colnames(fish.2025) <- fish.2025_colname

# To long format
fish.2025 <- setDT(fish.2025)
fish.2025 <- melt(fish.2025, 
            id.vars = 'Species', variable.name = 'SurveyNo', 
            measure.vars = patterns('^c1_', "Coloured_c1_", '^c2_', "Coloured_c2_", '^c3_', "Coloured_c3_", '^c4_', "Coloured_c4_", '^c5_', "Coloured_c5_", '^c6_', "Coloured_c6_", '^c7_', "Coloured_c7_", '^c8_', "Coloured_c8_", '^c9_', "Coloured_c9_", '^c10_', "Coloured_c10_", '^c11num_', "Coloured_c11num_", '^c11size_', "Coloured_c11size_"),
            value.name = c('1.25', 'Coloured_1.25', '3.75', 'Coloured_3.75', '6.25', 'Coloured_6.25', '8.75', 'Coloured_8.75', '12.5', 'Coloured_12.5', '17.5',  'Coloured_17.5', '25', 'Coloured_25', '35', 'Coloured_35', '45', 'Coloured_45', '55', 'Coloured_55',  '65',  'Coloured_65', 'SizeClass_11',  'Coloured_SizeClass_11'))

# Check & summarize if any of the size classes had a coloured cell
fish.2025$Coloured <- ifelse(fish.2025$Coloured_1.25 + fish.2025$Coloured_3.75 + fish.2025$Coloured_6.25 + fish.2025$Coloured_8.75 + fish.2025$Coloured_12.5 + fish.2025$Coloured_17.5 + fish.2025$Coloured_25 + fish.2025$Coloured_35 + fish.2025$Coloured_45 + fish.2025$Coloured_55 + fish.2025$Coloured_65 + fish.2025$Coloured_SizeClass_11 == 144, 12, 11)
fish.2025 <- dplyr::select(fish.2025, -c("Coloured_1.25", "Coloured_3.75", "Coloured_6.25", "Coloured_8.75", "Coloured_12.5", "Coloured_17.5", "Coloured_25", "Coloured_35", "Coloured_45", "Coloured_55", "Coloured_65", "Coloured_SizeClass_11"))

# Get Size class from wide to long
fish.2025 <- reshape2::melt(fish.2025, id.vars = c('SurveyNo', 'Species', 'Coloured', 'SizeClass_11'), 
          measure.vars = c('1.25', '3.75', '6.25', '8.75', '12.5', '17.5', '25', '35', '45', '55', '65'),
          variable.name = 'SizeClass', value.name = 'Abundance')

#Remove duplicates in SizeClass 65 (Class 11-proxy)
fish.2025$SizeClass_11 <- ifelse(fish.2025$SizeClass == 65, fish.2025$SizeClass_11, 0)

# ==== Add meta data ====
## Re-add species names in data frame
fish.2025$Species <- Fish.2025_speciesList # Added based on original order (!)
fish.2025$Species <- sub("\\.", "", fish.2025$Species) # Remove points from species names

### Update taxonomy for re-named or previously misidentified species
fish.2025$Species <-   ifelse(fish.2025$Species == "Pycnochromis dimidiatus", "Pycnochromis fieldi",
                       ifelse(fish.2025$Species == "Upeneus tragula", "Upeneus heemstra",
                              fish.2025$Species))

## Species metadata
fish.2025 <- merge(fish.2025, specieslist, all.x=T, by='Species') # Combine data and specieslist data frames
fish.2025$SizeClass <- as.numeric(paste(fish.2025$SizeClass)) # Set a numeric Length

## Add survey info
meta.2025 <- as.data.frame(read_excel("Raw data/Fish surveys_DATABASE_2025-2026_0.xlsx", sheet = "Data")) 
meta.2025 <- meta.2025[!is.na(meta.2025$Date),] # Remove empty rows
colnames(meta.2025)[1] <- "SurveyNo" 
meta.2025 <- meta.2025[,c("SurveyNo", "Date", "Location", "Transect", "Observer", "Radius", "Area", "Comments")] # Select relevant columns
fish.2025 <- merge(fish.2025, meta.2025, all.x=T, by='SurveyNo')

# ==== Calculate biomass ====
## Size class 65 serves as a proxy for the largest class, the actual size is taken from the SizeClass_11 variable
fish.2025$Biomass_kgha <- ifelse(
  fish.2025$SizeClass == 65,
  ((((fish.2025$a * (fish.2025$SizeClass_11 ^ fish.2025$b)) *
      fish.2025$Abundance) / fish.2025$Area) / 1000) * 10000,
  ((((fish.2025$a * (fish.2025$SizeClass ^ fish.2025$b)) *
      fish.2025$Abundance) / fish.2025$Area) / 1000) * 10000
)

## Standardize abundance
fish.2025$Abundance_m2 <- fish.2025$Abundance/fish.2025$Area

## Cleanup
fish.2025 <- select(fish.2025, - c("a", "b"))
fish.2025 <- fish.2025 %>% drop_na(Abundance_m2) # Drop empty rows for surveys not yet done

# ---- MERGE DATASETS ----
## Make column order match
### 2017-2022
fish.2017_2022 <- dplyr::select(fish.2017_2022, c("SurveyNo", "Species", "SizeClass_11", "SizeClass", "Abundance", "Abundance_m2", "Biomass_kgha",  "Coloured", "Diet", "DietH", "Date", "Location", "Transect", "Radius", "Area", "Observer", "Comments")) 

### 2023
fish.2023 <- dplyr::select(fish.2023, c("SurveyNo", "Species", "SizeClass_11", "SizeClass", "Abundance", "Abundance_m2", "Biomass_kgha",  "Coloured", "Diet", "DietH", "Date", "Location", "Transect","Radius", "Area", "Observer", "Comments")) 
## Update survey numbers to be continuous
fish.2023$SurveyNo <- as.numeric(fish.2023$SurveyNo)
SurveyNo2023 <- max(fish.2023$SurveyNo)
fish.2023$SurveyNo <- fish.2023$SurveyNo + surveys.tot
surveys.tot <- surveys.tot + SurveyNo2023

### 2024
fish.2024 <- dplyr::select(fish.2024, c("SurveyNo", "Species", "SizeClass_11", "SizeClass", "Abundance", "Abundance_m2", "Biomass_kgha",  "Coloured", "Diet", "DietH", "Date", "Location", "Transect","Radius", "Area", "Observer", "Comments"))
## Update survey numbers to be continuous
fish.2024$SurveyNo <- as.numeric(fish.2024$SurveyNo)
SurveyNo2024 <- max(fish.2024$SurveyNo)
fish.2024$SurveyNo <- fish.2024$SurveyNo + surveys.tot
surveys.tot <- surveys.tot + SurveyNo2024

### 2025
fish.2025 <- dplyr::select(fish.2025, c("SurveyNo", "Species", "SizeClass_11", "SizeClass", "Abundance", "Abundance_m2", "Biomass_kgha",  "Coloured", "Diet", "DietH", "Date", "Location", "Transect","Radius", "Area", "Observer", "Comments"))
## Update survey numbers to be continuous
fish.2025$SurveyNo <- as.numeric(fish.2025$SurveyNo)
SurveyNo2025 <- max(fish.2025$SurveyNo)
fish.2025$SurveyNo <- fish.2025$SurveyNo + surveys.tot
surveys.tot <- surveys.tot + SurveyNo2025

## Merge
fish <- rbind(fish.2017_2022, fish.2023, fish.2024, fish.2025)

# Match species
## Remove cryptic fish and unknown line
fish <- fish[!(fish$Species=='Atherinomorus sp' | fish$Species=='Ablabys binotatus' | fish$Species=='Amblyeleotris sp' |
        fish$Species=='Antennarius sp' | fish$Species=='Exallias brevis' | fish$Species=='Gymnomuraena zebra' |
        fish$Species=='Gymnothorax griseus' | fish$Species=='Gymnothorax javanicus' | fish$Species=='Gymnothorax meleagris' |
        fish$Species=='Gymnothorax sp' | fish$Species=='Inimicus filamentosus' | fish$Species=='Myrichthys colubrinus' |
        fish$Species=='Myrichthys maculosus' | fish$Species=='Paracirrhites arcatus' | fish$Species=='Paracirrhites forsteri' |
        fish$Species=='Parapercis hexophtalma' | fish$Species=='Parapercis sp' | fish$Species=='Scorpaenopsis sp' |
        fish$Species=='Scuticaria tigrina' | fish$Species=='Synodus sp' | fish$Species=='Trachyrhamphus bicoarctatus' |
        fish$Species=='Unknown blenny' | fish$Species=='Valenciennea helsdingenii' | fish$Species=='Valenciennea strigata' | 
        fish$Species=='Tylosurus crocodilus' |  fish$Species=='Plectropomus laevis' | fish$Species=='Unknown'),]

## Fill in missing species on both sides
### Set apart metadata first
meta.all <- dplyr::select(fish, c("SurveyNo", "Date", "Location", "Transect", "Radius", "Area", "Observer", "Comments"))
meta.all <- meta.all[!duplicated(meta.all[,c('SurveyNo')]),]
### Reduce dataframe to values only
fish <- dplyr::select(fish, -c("Diet", "DietH", "Date", "Location", "Transect", "Radius", "Area", "Observer", "Comments"))

### Fill in missing species with 0 values
fish <- fish %>% complete(SurveyNo, Species, SizeClass)

fish$Abundance[is.na(fish$Abundance)] <- 0
fish$Abundance_m2[is.na(fish$Abundance_m2)] <- 0
fish$Biomass_kgha[is.na(fish$Biomass_kgha)] <- 0

### Re-add meta surveys
fish <- left_join(fish, meta.all, by = "SurveyNo")
### Fill in Diet for newly added species
specieslist <- dplyr::select(specieslist, c("Species", "Diet", "DietH"))
fish <- left_join(fish, specieslist, by = "Species")

## Add transect info
transectinfo <- as.data.frame(read_excel("Raw data/Measurements timeline.xlsx", sheet = "Overview (yearly)"))
colnames(transectinfo)[1] <- "Transect"
transectinfo <- dplyr::select(transectinfo, c("Transect", "Type", "Site", "GPS", "Depth.MLLW", "Reef.dist_m", "AR.dist_m", "Date.created", "Area_m2"))
fish$Transect <- tolower(fish$Transect)
transectinfo$Transect <- tolower(transectinfo$Transect)

fish <- left_join(fish, transectinfo, by = "Transect")

## Replace the 65-proxy by the actual size of the largest class, which varies between species / survey. 
# If there is no fish in the largest class, keep 65 as a proxy.
fish <- fish %>%
  mutate(SizeClass = ifelse(SizeClass == 65 & Abundance > 0, SizeClass_11, SizeClass)) %>%
  select(-SizeClass_11)

# Rename SizeClass to Size, considering it is not a class system now
fish <- fish %>% rename(Size = SizeClass)

#Make Size numeric to allow ordering to size
fish$Size <- as.numeric(fish$Size)

# Cleanup
fish <- fish %>% distinct()
fish$Type <- ifelse(fish$Transect == "na", "Reference", fish$Type)
fish$Site <- ifelse(fish$Transect == "na", fish$Location, 
             ifelse(is.na(fish$Site), fish$Location, fish$Site))
fish$Type <- ifelse(is.na(fish$Type), "Other", fish$Type)
colnames(fish)[which(names(fish) == "Type")] <- "Treatment"
fish$Patch.type <- ifelse(grepl("cma-l-", fish$Transect), "AR (L)",
                   ifelse(grepl("cma-xl-", fish$Transect), "AR (XL)",
                   ifelse(grepl("cma-xs-", fish$Transect), "AR (XS)",
                   ifelse(grepl("-bru-", fish$Transect), "BRU",
                   ifelse(grepl("-cage-", fish$Transect), "CAGE",       
                   ifelse(grepl("-cake-", fish$Transect), "CAKE",       
                   ifelse(grepl("-comp-", fish$Transect), "COMP",
                   ifelse(grepl("m-", fish$Transect), "MOSES (- coral)",       
                   ifelse(grepl("m+", fish$Transect), "MOSES (+ coral)",       
                   ifelse(grepl("m-c", fish$Transect), "MOSES (control)",  
                   ifelse(grepl("m-p", fish$Transect), "MOSES (pins)",       
                   ifelse(grepl("r-l-", fish$Transect), "Reference (L)",
                   ifelse(grepl("r-xl-", fish$Transect), "Reference (XL)",
                   ifelse(grepl("r-xs-", fish$Transect), "Reference (XS)",
                   ifelse(grepl("(?<!\\()f-r-", fish$Transect, perl=TRUE), "Control",
                   ifelse(grepl("(?<!\\()nt-r-", fish$Transect, perl=TRUE), "Control",
                   ifelse(grepl("\\(f-r-",fish$Transect),"Reference",
                   ifelse(grepl("\\(nt-r-",fish$Transect),"Reference",
                                "na"))))))))))))))))))    

fish$Date.created <- excel_numeric_to_date(as.numeric(fish$Date.created))
fish$Year.created <- year(fish$Date.created)
fish$Year <- year(fish$Date)

## Re-order dataframe
fish <- dplyr::select(fish, "SurveyNo", "Site", "Treatment", "Patch.type", "Transect", "Year.created", "Date.created", "GPS",
                            "Depth.MLLW", "Reef.dist_m", "AR.dist_m", "Area_m2","Radius", "Area","Observer", "Comments", "Year", "Date",
                            "Species", "Diet", "DietH", "Size", "Abundance", "Abundance_m2", "Biomass_kgha", "Coloured")

## Remove NAs before aggregating
fish <- fish %>%
  mutate_if(is.character, ~replace_na(., "na")) 
fish <- fish %>%
  mutate_if(is.numeric, ~replace_na(., -1)) 
fish <- dplyr::select(fish, -c("Date.created"))

## Write clean parquet file
write_parquet(fish, "Fish_All years.parquet")

## Clean environment
rm(fish, fish.2017_2022, fish.2018, fish.2019, fish.2020, fish.2021, fishRAW.2018, fishRAW.2019, fishRAW.2020, fishRAW.2021, meta.all,
   meta.2018, meta.2019, meta.2020, meta.2021, meta.2017_2022, specieslist, transectinfo, colname, 
   fish.2023, Fish.2023_ColouredCells, fish.2023format, fishRaw.2023, meta.2023, fish.2023_colname, fish.2023_surveys.tot, Fish.2023_speciesList, SurveyNo2023, 
   fish.2024, Fish.2024_ColouredCells, fish.2024format, fishRaw.2024, meta.2024, fish.2024_colname, fish.2024_surveys.tot, Fish.2024_speciesList,
   SurveyNo2024, 
   fish.2025, Fish.2025_ColouredCells, fish.2025format, fishRaw.2025, meta.2025, fish.2025_colname, fish.2025_surveys.tot, Fish.2025_speciesList,
   SurveyNo2025,
   surveys.tot, obs_block, raw_obs,  input_file, wb, fish_sizeclass, co, biomass_sum, col_order, cols, i, idx_12, target_species)

```

# Filtering RAW output to relevant information
```{r}

# Load data sets
fish <- read_parquet("Fish_All years.parquet")

# Remove irrelevant columns
fish <- fish %>%
  select(-GPS, -Year.created, -Area_m2, -Diet)

# Select relevant surveys
fish <- fish[fish$Patch.type %in% c("CAGE", "CAKE","BRU","COMP","Control","Reference") & fish$Year >= 2021,]

# Add a YearGroup variable, to compare between 2021, 2023 and 2025
fish$YearGroup <- ifelse(fish$Year %in% c(2021, 2022), "2021–2022",
                   ifelse(fish$Year %in% c(2023, 2024), "2023–2024",
                   ifelse(fish$Year == 2025, "2025", NA)))
fish <- fish %>% relocate(YearGroup, .after = Year)

# Set data types
fishtofactors <- c('SurveyNo', 'Site', 'Treatment', 'Patch.type', 'Transect', 'Observer', 'Year', 'YearGroup','Species', 'DietH', 'Size') 
fish[fishtofactors] <- lapply(fish[fishtofactors], factor)
rm(fishtofactors)

# Remove unused factors-
fish <- droplevels(fish)

# Exclude /practise surveys
fish <- fish[!grepl("exclude|wrong|exclude", fish$Comments, ignore.case = TRUE), ]

write_parquet(fish, "Fish_Clean.parquet")

# # Get total list of relevant surveys
# surveylist <- as.data.frame(unique(fish$SurveyNo))
# names(surveylist) <- "SurveyNo"
# surveylist <- surveylist %>% arrange(SurveyNo)
# 
# # Total biomass & abundance of all entries
# sum(fish$Biomass_kgha)
# sum(fish$Abundance)
# 
# Check average radius in last couple years, taking out duplicate surveys
fish_unique <- fish[!duplicated(fish[c("Transect", "Date")]), ]
aggregate (Radius ~ YearGroup, data = fish_unique, FUN = mean)

```

# Load in data 
```{r}
fish <- read_parquet("Fish_Clean.parquet")
```
# Species richness
```{r}
# ---- DATA PREP ----
# Remove rows with no abundance or non-herbivorous fish
fishRich <- fish[fish$Abundance != 0 & fish$DietH != "Other",]

#Calculate mean herbivore species richness per survey
Richness <- fishRich %>%
  #Unique species for each raw survey record
  group_by(Patch.type, Transect,Depth.MLLW, YearGroup, Date,  Observer) %>%
  summarise(richness = n_distinct(Species)) %>%
  
  #Average when a survey is done with two observers
  group_by(Patch.type, Transect,Depth.MLLW, YearGroup, Date) %>%
  summarise(richness_mean_observers = mean(richness)) %>% 

  #Average when a transect is surveyed multiple times in the same year group (21-22/23-24/25)
  group_by(Patch.type, Transect,Depth.MLLW, YearGroup) %>% 
  summarise(Mean_Richness_perSurvey = mean(richness_mean_observers))

Richness$Mean_Richness_perSurveyLog10 <- log10(Richness$Mean_Richness_perSurvey)
```
## Plots
```{r}
# Calculate standard deviation per group
Richness_SD <- Richness %>%
   group_by(Patch.type) %>%
   summarise(
     Mean_Richness_perPatch = mean(Mean_Richness_perSurvey),
     SD_Richness_perPatch = sd(Mean_Richness_perSurvey),
     .groups = "drop"
   )

Richness_combined <- Richness %>% left_join(Richness_SD, by = "Patch.type")

# Plot
ggplot(Richness_combined, aes(x = Patch.type, y = Mean_Richness_perSurvey)) +
   geom_point(position = position_jitter(width = 0.2), alpha = 0.6, color="grey") +  # individual points
   geom_point(data = Richness_combined, aes(x = Patch.type, y = Mean_Richness_perPatch),
              color = "black", size = 4, shape = 18) +  # mean points (red diamonds)
   geom_errorbar(data = Richness_combined,
                 aes(x = Patch.type,
                     ymin = Mean_Richness_perPatch - SD_Richness_perPatch,
                     ymax = Mean_Richness_perPatch + SD_Richness_perPatch),
                 width = 0.1, color = "blue") +  # error bars
   labs(title = "Herbivore species richness",
        x = "Patch type",
        y = "Herbivore species richness") +
   ylim(0,NA) +
   theme_minimal()
 
# Checking for normality 
ggplot(Richness, aes(x = Mean_Richness_perSurvey)) +
          geom_histogram(binwidth = 1, center = 0, fill = "grey", color = "black") +
          scale_x_continuous(breaks = min(Richness$Mean_Richness_perSurvey):max(Richness$Mean_Richness_perSurvey))
            # Is right-skewed

# Log10 transformed, using density plot because histogram breaks would look weird in this scale
ggdensity(Richness$Mean_Richness_perSurveyLog10,
          main = "Density plot of  richness",
          xlab = "Species richness (log-transformed)")
            # Normally distributed

ggqqplot(Richness$Mean_Richness_perSurveyLog10)
```
## Statistical models
```{r richness}
# Including Diet group leads to a non-normal distribution, thus left out for these models
model1<- lmer(Mean_Richness_perSurvey ~ Depth.MLLW + YearGroup * Patch.type + (1|Transect), data = Richness) 
model2<- lmer(Mean_Richness_perSurvey ~ Depth.MLLW + YearGroup + Patch.type + (1|Transect), data = Richness) 
model3<- lmer(Mean_Richness_perSurvey ~ YearGroup * Patch.type + (1|Transect), data = Richness) 
model4<- lmer(Mean_Richness_perSurvey ~ Patch.type + (1|Transect), data = Richness) 
model5<- lmer(Mean_Richness_perSurvey ~ YearGroup + (1|Transect), data = Richness)

# Compare models
anova(model1,model2,model3, model4,model5)

##### Interpretation of results:
## Model 2 fits best, so without interaction factor betwteen YearGroup and Patch.type.

# Testing diagnostics for model 2
## Normality
res <- resid(model2)
qqnorm(res) 
qqline(res) # Dots are around line, visual inspection says normal distribution
shapiro.test(resid(model2)) #p>0.05 thus normal distributed

## Homoscedasticity
plot(fitted(model2), resid(model2),
     xlab = "Fitted values", ylab = "Residuals")
abline(h = 0, col = "red")

```

# Biomass
```{r}
# ---- DATA PREP ----
# Remove rows with no abundance, non-herbivorous fish, and non-instantaneous data
fishBio <- fish[fish$Abundance != 0 & fish$DietH != "Other" & fish$Coloured == 12,]

#Calculate mean herbivore species abundance per survey
Biomass <- fishBio %>%
  #Unique species for each raw survey record
  group_by(Patch.type, Transect,Depth.MLLW, YearGroup, Date,  Observer) %>%
  summarise(fishBio = sum(Biomass_kgha)) %>%
  
  #Average when a survey is done with two observers
  group_by(Patch.type, Transect,Depth.MLLW, YearGroup, Date) %>%
  summarise(biomass_mean_observers = mean(fishBio)) %>% 

  #Average when a transect is surveyed multiple times in the same year group (21-22/23-24/25)
  group_by(Patch.type, Transect,Depth.MLLW, YearGroup) %>% 
  summarise(Mean_Biomass_perSurvey = mean(biomass_mean_observers))

Biomass$Mean_Biomass_perSurveyLog10 <- log10(Biomass$Mean_Biomass_perSurvey)
```
## Plots
```{r}
# Calculate standard deviation per group
Biomass_SD <- Biomass %>%
   group_by(Patch.type) %>%
   summarise(
     Mean_Biomass_perPatch = mean(Mean_Biomass_perSurvey),
     SD_Biomass_perPatch = sd(Mean_Biomass_perSurvey),
     .groups = "drop"
   )

Biomass_combined <- Biomass %>% left_join(Biomass_SD, by = "Patch.type")

# Plot
ggplot(Biomass_combined, aes(x = Patch.type, y = Mean_Biomass_perSurvey)) +
   geom_point(position = position_jitter(width = 0.2), alpha = 0.6, color="grey") +  # individual points
   geom_point(data = Biomass_combined, aes(x = Patch.type, y = Mean_Biomass_perPatch),
              color = "black", size = 4, shape = 18) +  # mean points (red diamonds)
   geom_errorbar(data = Biomass_combined,
                 aes(x = Patch.type,
                     ymin = Mean_Biomass_perPatch - SD_Biomass_perPatch,
                     ymax = Mean_Biomass_perPatch + SD_Biomass_perPatch),
                 width = 0.1, color = "blue") +  # error bars
   labs(title = "Herbivore species Biomass",
        x = "Patch type",
        y = "Herbivore species Biomass") +
   ylim(0,NA) +
   theme_minimal()
 
# Checking for normality 
ggdensity(Biomass$Mean_Biomass_perSurvey,
          main = "Density plot of  Biomass",
          xlab = "Species Biomass")
            # Normally distributed

# Log10 transformed, using density plot because histogram breaks would look weird in this scale
ggdensity(Biomass$Mean_Biomass_perSurveyLog10,
          main = "Density plot of  Biomass",
          xlab = "Species Biomass (log-transformed)")
            # Normally distributed

# Calculate standard deviation per group
Biomass_SDLog10 <- Biomass %>%
   group_by(Patch.type) %>%
   summarise(
     Mean_Biomass_perPatchLog10 = mean(Mean_Biomass_perSurveyLog10),
     SD_Biomass_perPatchLog10 = sd(Mean_Biomass_perSurveyLog10),
     .groups = "drop"
   )

Biomass_combined <- Biomass %>% left_join(Biomass_SDLog10, by = "Patch.type")

# Plot
ggplot(Biomass_combined, aes(x = Patch.type, y = Mean_Biomass_perSurveyLog10)) +
   geom_point(position = position_jitter(width = 0.2), alpha = 0.6, color="grey") +  # individual points
   geom_point(data = Biomass_combined, aes(x = Patch.type, y = Mean_Biomass_perPatchLog10),
              color = "black", size = 4, shape = 18) +  # mean points (red diamonds)
   geom_errorbar(data = Biomass_combined,
                 aes(x = Patch.type,
                     ymin = Mean_Biomass_perPatchLog10 - SD_Biomass_perPatchLog10,
                     ymax = Mean_Biomass_perPatchLog10 + SD_Biomass_perPatchLog10),
                 width = 0.1, color = "blue") +  # error bars
   labs(title = "Herbivore species Biomass",
        x = "Patch type",
        y = "Herbivore species Biomass") +
   theme_minimal()

ggqqplot(Biomass$Mean_Biomass_perSurveyLog10)
```
## Statistical models
```{r}
## Summarize per survey - Biomass
biosum <- merge(surveys[ ,c(1:6)], bio, by = "SurveyNo", all.x=T)
biosum <- biosum[,-c(6)]
biosum <- aggregate(Biomass_ha ~ SurveyNo, biosum, sum) # Get the total biomass per survey
biosum <- merge(biosum, totsur, all.y=T) # Re-add surveys without observations
biosum[is.na(biosum)] <- 0
biosum <- merge(surveys, biosum, by = "SurveyNo", all.x=T)

## Summarize per survey - Abundance
abusum <- merge(surveys[ ,c(1:6)], bio, by = "SurveyNo", all.x=T)
abusum <- aggregate(Abundance ~ SurveyNo, abusum, sum) # Get the total biomass per survey
abusum <- merge(abusum, totsur, all.y=T) # Re-add surveys without observations
abusum[is.na(abusum)] <- 0
abusum <- merge(surveys, abusum, by = "SurveyNo", all.x=T)

## Aggregate the simultaneous surveys and means for transects per Year

biosumsubmeans <- biosum
biosumsubmeans <- aggregate(Biomass_ha ~ Transect + Date + Year, biosumsubmeans, mean)

## Average per patch

biosumsubtransmeans <- biosumsubmeans
biosumsubtransmeans <- aggregate(Biomass_ha ~ Transect + Year, biosumsubtransmeans, mean)

# ---- MODELLING ----
# Log-transformed because of heterogeneity residuals
biosumsubmeans$Biomass_ha[biosumsubmeans$Biomass_ha == 0] <- min(biosumsubmeans$Biomass_ha[biosumsubmeans$Biomass_ha>0])/2

### Model
lmerBiomeans <- lmer(log10(Biomass_ha) ~ Year + (1|Transect), data = biosumsubmeans)
car::Anova(lmerBiomeans)
summary(lmerBiomeans)

#### Interpretation of results
#The linear mixed model analyzing log-transformed biomass per hectare revealed some evidence of temporal variation across years. Biomass in 2023 was significantly lower than the baseline year (p = 0.0115), while 2020 also showed a marginally significant decline (p = 0.0500). Other years did not differ significantly from the baseline. The model included transect as a random effect, which accounted for a small amount of variance (SD = 0.095), indicating slight variation in biomass levels between transects. The residual variation remained moderate (SD = 0.411), suggesting most variation was within transects or not explained by year alone. Overall, these results suggest that biomass was relatively stable in most years, but showed notable declines in 2020 and especially 2023.
```
## Comparison of models
```{r}
### Model validation
mod <- lmerBiomeans # set model to be validated
op <- par(mfrow = c(2, 4), mar = c(5, 4, 1, 2)) # set layout of figure frame
plot(resid(mod, type = "pearson") ~ fitted(mod)) # fitted vs residuals
abline(0,0)
hist(resid(mod, type = "pearson"), main = "") # histogram residuals
qqnorm(resid(mod, type = "pearson")) # QQplot residuals
plot(biosumsubmeans$Year, resid(mod, type = "pearson")) # residuals split over Date
abline(0,0)
plot(fitted(mod) ~ log10(biosumsubmeans$Biomass_ha)) # response data vs fitted
par(op)

### Post hoc
emmBiomeans <- emmeans(lmerBiomeans, list(pairwise ~ Year), adjust='tukey', type = "response") 
emmBiosum <- multcomp::cld(emmBiomeans$emmeans, alpha = 0.05, Letters = letters, reversed = FALSE)
emmBiosum <- emmBiosum %>% dplyr::mutate(.group = str_squish(.group)) # remove white spaces

# ---- PLOTS ----

Bioplot <- ggplot(data = biosumsubtransmeans, aes(x = Year, y = Biomass_ha, colour = Year)) +
    geom_jitter(width = 0.2, size = 2) +
    scale_colour_manual(values = co) +
    scale_x_discrete(expand = c(0, 0.7)) +  # Use actual year values in the data
    geom_point(data = emmBiosum, aes(y = response), colour = 'black', size = 4) +
    geom_errorbar(data = emmBiosum, width = 0.1, colour = 'black', size = 0.8,
                  aes(y = response, ymin = response - SE, ymax = response + SE)) +
    geom_text(data = emmBiosum, aes(label = .group, y = response + 3.5 * SE), colour = 'black', size = 7) +
    labs(y = expression(paste("Fish biomass (kg ", ha^-1, ")")), x = "Year") +
    scale_y_continuous(trans = 'log10', breaks = c(10, 100, 1000)) +
    coord_cartesian(ylim = c(4, 1001)) +
    scale_color_manual(values = co) +
    theme_bw() +
    theme(axis.title.y = element_text(size = 14, face = "plain", vjust = 2.7),
          axis.text.y = element_text(size = 14, face = "bold", vjust = 0.4),
          axis.title.x = element_text(size = 14, face = "plain", vjust = -0.5),
          axis.text.x = element_text(size = 12, face = "bold", vjust = 0.5),
          legend.position = "none")

print(Bioplot)

#ggsave("Fish_Biomass.tiff", width = 23, height = 14, units = "cm", dpi=1200, compression = "lzw")
```

# Abundance
## Plots
```{r}
# ---- MODELLING ----

## ==== Model ====
### Prep data
abusumsubmeans <- abusum
abusumsubmeans$Abundance_m2 <- abusumsubmeans$Abundance / abusumsubmeans$Area 
abusumsubmeans <- aggregate(Abundance_m2 ~ Transect + Date + Year, abusumsubmeans, mean) # Mean simul surveys
abusumsubtransmeans <- aggregate(Abundance_m2 ~ Transect + Year, abusumsubmeans, mean) # Mean per Patch

### Modelling
#### Log-transformed because of heterogeneity residuals
abusumsubmeans$Abundance_m2[abusumsubmeans$Abundance_m2 == 0] <- min(abusumsubmeans$Abundance_m2[abusumsubmeans$Abundance_m2>0])/2

### Model
lmerAbumeans <- lmer(log10(Abundance_m2) ~ Year + (1|Transect), data = abusumsubmeans)
car::Anova(lmerAbumeans)
```

## Statistical models
```{r}
```

## Comparison of models
```{r}
### Validation
mod <- lmerAbumeans # set model to be validated
op <- par(mfrow = c(2, 4), mar = c(5, 4, 1, 2)) # set layout of figure frame
plot(resid(mod, type = "pearson") ~ fitted(mod)) # fitted vs residuals
abline(0,0)
hist(resid(mod, type = "pearson"), main = "") # histogram residuals
qqnorm(resid(mod, type = "pearson")) # QQplot residuals
plot(abusumsubmeans$Year, resid(mod, type = "pearson")) # residuals split over Date
abline(0,0)
plot(fitted(mod) ~ log10(abusumsubmeans$Abundance_m2)) # response data vs fitted
par(op)

### Post hoc
emmAbu <- emmeans(lmerAbumeans, list(pairwise ~ Year), adjust='tukey', type = "response")
emmAbusum <- multcomp::cld(emmAbu$emmeans, alpha = 0.05, Letters = letters, reversed = FALSE) # get CLD
emmAbusum <- emmAbusum %>% dplyr::mutate(.group = str_squish(.group)) # remove white spaces

# ---- PLOTS ----

## ==== not adjusted ====
### Abundance- not adjusted
Abuplot <- ggplot(data = abusumsubtransmeans, aes(x = Year, colour = Year, y = Abundance_m2)) + 
    geom_jitter(width = 0.2, size = 2) +
    geom_point(data = emmAbusum, aes(y = response), colour = 'black', size = 4) +
    geom_errorbar(data = emmAbusum, width = 0.1, colour = 'black', size = 0.8,
                  aes(y = response, ymin = response - SE, ymax = response + SE)) +
    geom_text(data = emmAbusum, 
              aes(label = .group, y = response + 3.5 * SE), colour = 'black', size = 7) +
    labs(y = expression(paste("Fish abundance (", m^-2, ")")), x = "Year") +  # Set x-axis title to "Year"
    scale_y_continuous(trans = 'log10', breaks = c(0.1, 1, 10)) +
    coord_cartesian(ylim = c(0.05, 11)) +
    scale_color_manual(values = co) +
    theme_bw() +
    theme(axis.title.y = element_text(size = 14, face = "plain", vjust = 2.7),
          axis.text.y = element_text(size = 14, face = "bold", vjust = 0.4),
          axis.title.x = element_text(size = 14, face = "plain", vjust = -0.5),  # Restore x-axis title formatting
          axis.text.x = element_text(size = 12, face = "bold", vjust = 0.5),     # Restore x-axis labels
          legend.position = "none")


print(Abuplot)

#ggsave("Fish_Abundance_Years.tiff", width = 23, height = 14, units = "cm", dpi=1200, compression = "lzw")
```

### Composition comparisons
```{r biomass composition}
# Composition comparisons done on Biomass level, because more informative than on Abundance level
# ---- DATA PREP ----
## ==== Species ====
### Create data frame
bio.ord <- spread(bio, key = Species, value = Biomass_ha) # Wide to long
bio.ord <- select(bio.ord, -c(2:5))
bio.ord[is.na(bio.ord)] <- 0
bio.ord <- aggregate(. ~ SurveyNo, data = bio.ord, FUN = sum, na.action = na.omit) # Sum each Species per Survey

### Add info and re-add surveys without observations
bio.ord <- left_join(surveys, bio.ord, by = "SurveyNo")
bio.ord <- select(bio.ord, -c(3,5,6))

### Data selection
bio.ord[is.na(bio.ord)] <- 0 # Set all Species to 0 for surveys without observations

## Create replicate
bio.ord.years <- bio.ord 

### average over replicate surveys
bio.ord <- aggregate(.~Transect+Year, bio.ord, mean)
bio.ord.years <- aggregate(.~Transect+Year, bio.ord.years, mean)

## ==== Diet ====
### Create data frame
bioDiet <- bioDiet %>% select(-Year)
bioBrayDiet <- merge(surveys[, c(1:5, 7)], bioDiet, all.x = TRUE)
bioBrayDiet <- bioBrayDiet %>% select(-14)

bioBrayDiet$Transect <- as.factor(bioBrayDiet$Transect)
bioBrayDiet$Year <- as.factor(bioBrayDiet$Year)

bioBrayDiet <- bioBrayDiet %>% select(-c(1:3, 5))


### Average over replicate surveys
subbcDiet.bio <- aggregate(.~Transect+Year, bioBrayDiet, mean)

# ---- STATS ----

## ==== Species ====
#### Create a Bray-Curtis mean distance table 
BCtable.Bio.Specs <- vegdist(bio.ord[,6:ncol(bio.ord)], "bray")
BCtable.Bio.Specs.tab <- as.data.frame(meandist(BCtable.Bio.Specs, bio.ord$Year, cluster=average))

#### Stats
adonis.Bio.Specs <- adonis2(formula = BCtable.Bio.Specs ~ Year, data = bio.ord, permutations = 9999)
pairadonis.Bio.Specs <- pairwise.adonis(BCtable.Bio.Specs, bio.ord$Year, p.adjust='bonferroni', perm = 37000)

#### NMDS
NMDS.Bio.Spec <- metaMDS(bio.ord[,6:ncol(bio.ord)], distance = "bray", k = 2, trymax=3000, autotransform = FALSE) 

### #### Years #### Replicate
BCtable.Bio.Specs.years <- vegdist(bio.ord.years[,6:ncol(bio.ord.years)], "bray")

#### Stats
adonis.Bio.Specs.years <- adonis2(formula = BCtable.Bio.Specs.years ~ Year,
                                  data = bio.ord.years, permutations = 9999)
pairadonis.Bio.Specs.years <- pairwise.adonis(BCtable.Bio.Specs.years, bio.ord.years$Year,
                                              p.adjust='bonferroni', perm = 37000)

#### NMDS
NMDS.Bio.Spec.years <- metaMDS(bio.ord.years[,6:ncol(bio.ord.years)],
                               distance = "bray", k = 2, trymax=3000, autotransform = FALSE) 

## ==== Diet ==== #### 
### Create a bc mean distance table 
BCtable.Bio.Diet <- vegdist(subbcDiet.bio[,3:ncol(subbcDiet.bio)], "bray")
BCtable.Bio.Diet.tab <- as.data.frame(meandist(BCtable.Bio.Diet, subbcDiet.bio$Year, cluster=average))

### Stats
adonis.Bio.Diet <- adonis2(formula = BCtable.Bio.Diet ~ Year, data = subbcDiet.bio, permutations = 9999)
pairadonis.Bio.Diet <- pairwise.adonis(BCtable.Bio.Diet, subbcDiet.bio$Year, p.adjust = 'bonferroni', perm = 37000)

### NMDS
NMDS.Bio.Diet <- metaMDS(subbcDiet.bio[,3:ncol(subbcDiet.bio)], distance = "bray", k = 2, trymax=1000, autotransform = FALSE) 

## ==== Years (Based on Abundance rather than Biomass) ====
### Create a bc mean distance table 

Specs.sum.min <- Specs
BCtable.Abu.Years <- vegdist(Specs.sum.min[,3:ncol(Specs.sum.min)], "bray")
BCtable.Abu.Years.tab <- as.data.frame(meandist(BCtable.Abu.Years, Specs.sum.min$Year, cluster=average))

### Stats
adonis.Abu.Years <- adonis2(formula = BCtable.Abu.Years ~ Year, data = Specs.sum.min, permutations = 9999)
pairadonis.Abu.Years <- pairwise.adonis(BCtable.Abu.Years, Specs.sum.min$Year, p.adjust = 'bonferroni', perm = 37000)

### NMDS
NMDS.Abu.Years <- metaMDS(Specs.sum.min[,3:ncol(Specs.sum.min)], distance = "bray", k = 2, trymax=1000, autotransform = FALSE)


# ---- PLOTS ----

## ==== Species ==== ### 
##### On Year level
NMDS.Bio.Spec.Year <- as.data.frame(scores(NMDS.Bio.Spec, display="site"))
NMDS.Bio.Spec.Year$Treatment <- subbcDiet.bio$Year
NMDS.Bio.Spec.Year$Interaction <- subbcDiet.bio$Interaction

Ordi.Sp.Patch <- ggplot(data = NMDS.Bio.Spec.Year)+
    stat_ellipse(geom = "polygon", alpha = 0.1, aes(x = NMDS1, y = NMDS2, fill = Treatment),
                level = 0.5, size = 12)+
    scale_fill_manual(values=co)+
    geom_point(aes(x = NMDS1,y = NMDS2, colour = Treatment), size= 2)+
    scale_color_manual(values=co)+
    scale_y_continuous(limits = c(-2, 2), breaks = c(-2, 0, 2))+
    theme_bw()+
    theme(legend.position = "none",
          legend.text = element_text(size = 12),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.title.y = element_text(size = 14, face = "plain", vjust = 3),
          axis.text.y = element_text(size = 14, face = "bold", vjust = 0.4),
          axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          plot.margin = margin(0, 0, 0.2, 0.5, "cm"),
          axis.ticks.length.x = unit(0, "cm"))
#ggsave("Fish_Ordination species_Patch_Biomass.tiff", width = 18, height = 14, units = "cm", dpi=1200, compression = "lzw")

#### On Species level
##### Adjust font size based on % of surveys in which a species is seen
specsizes.bio <- bio.ord[,6:ncol(bio.ord)]
specsizes.bio <- colSums(specsizes.bio)
specsizes.bio.min <- min(specsizes.bio)
specsizes.bio.max <- max(specsizes.bio)
cex.bio.min <- 0.05
cex.bio.max <- 2
specsizes.bio <- ((specsizes.bio - specsizes.bio.min)/(specsizes.bio.max-specsizes.bio.min)) * (cex.bio.max - cex.bio.min) + cex.bio.min

##### Plot on Species level
##### For composite
cox <- c(co, "#0673B0", "#0673B0", "#0673B0") 

pdf(NULL)
dev.control(displaylist="enable")
par(bg = 'white',   las=1, tck=-0.007, cex.axis=1.1, cex.lab = 1.1, font.axis = 2, mar=c(6.5, 4.2, 0.1, 0.2), 
    col.axis = "#464646")
ordiplot(NMDS.Bio.Spec, type="none",  cex = 0.3, ylim = c(-1.1, 1.1), xlim = c(-0.1, 0.9))
ordiellipse(NMDS.Bio.Spec, groups = bio.ord$Year, kind = "se", conf = 0.99, draw  ="polygon", 
            col = cox, alpha = 50, label = F, lty = 'blank', border = "white")
ordipointlabel(NMDS.Bio.Spec, display = "species", scaling = "symmetric", add = TRUE,
               cex = specsizes.bio, font = 3)
Ordi.Sp.Sp <- recordPlot()
invisible(dev.off())
#Ordi.Sp.Sp <- plot_grid(Ordi.Sp.Sp) + theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))

#png("Ordi_Sp_Sp.png", width = 1200, height = 1000, res = 150)
replayPlot(Ordi.Sp.Sp)
dev.off()

tiff("Ordi_Sp_Sp.tiff", width = 8, height = 6.5, units = "in", res = 300, compression = "lzw")
replayPlot(Ordi.Sp.Sp)
dev.off()

#### Years ####
##### Adjust font size based on % of surveys in which a species is seen
specsizes.bio.years <- bio.ord.years[,6:ncol(bio.ord.years)]
specsizes.bio.years <- colSums(specsizes.bio.years)
specsizes.bio.years.min <- min(specsizes.bio.years)
specsizes.bio.years.max <- max(specsizes.bio.years)
cex.bio.years.min <- 0.03
cex.bio.years.max <- 2
specsizes.bio.years <- ((specsizes.bio.years - specsizes.bio.years.min)/(specsizes.bio.years.max-specsizes.bio.years.min)) * (cex.bio.years.max - cex.bio.years.min) + cex.bio.years.min

##### Plot on Species*Year level # everything looks too crowded. Solution: get the first 3 letters of every species
tiff("Fish_Ordination_species_Species_Years_Biomass.tiff",
     width = 18, height = 14, units = "cm", res = 300, compression = "lzw")

Ordi.Sp.Sp.years <- ordiplot(NMDS.Bio.Spec.years, type="none",
                             cex = 0.3, ylim = c(-0.3, 0.2), xlim = c(-1.8, 2.1))
ordiellipse(NMDS.Bio.Spec.years, groups = bio.ord.years$Year, kind = "se", conf = 0.99, draw  ="polygon", 
            col = c("#B0E54D", "#6FDCD9", "#F0C862", "#EC86BF", "#D04E08", "#0673B0", "#FF5733"), alpha = 50, label = T, lty = 'blank', border = "white")
ordipointlabel(NMDS.Bio.Spec.years, display = "species", scaling = 9, add = TRUE, cex = specsizes.bio.years)
dev.off()

#### Based on Abundance
##### Adjust font size based on % of surveys in which a species is seen
specsizes.abu.years <- Specs.sum.min[,3:ncol(Specs.sum.min)]
specsizes.abu.years <- colSums(specsizes.abu.years)
Specs.sum.min.min <- min(specsizes.abu.years)
Specs.sum.min.max <- max(specsizes.abu.years)
cex.abu.years.min <- 0.03
cex.abu.years.max <- 2
specsizes.abu.years <- ((specsizes.abu.years - cex.abu.years.min)/(Specs.sum.min.max-Specs.sum.min.min)) * (cex.abu.years.max - cex.abu.years.min) + cex.abu.years.min

##### Plot on Species*Study level
tiff("Fish_Ordination species_Species_Years_Abundance.tiff", width = 18, height = 14, units = "cm", res = 1500, compression = "lzw")
Ordi.Sp.Sp.years.abu <- ordiplot(NMDS.Abu.Years, type="none",
                             cex = 0.3, ylim = c(-0.3, 0.2), xlim = c(-1.8, 2.1))
ordiellipse(NMDS.Abu.Years, groups = Specs.sum.min$Year, kind = "se", conf = 0.99, draw  ="polygon", 
            col = c("#B0E54D", "#6FDCD9", "#F0C862", "#EC86BF", "#D04E08", "#0673B0", "#FF5733"), alpha = 50, label = T, lty = 'blank', border = "white")
ordipointlabel(NMDS.Abu.Years, display = "species", scaling = 9, add = TRUE, cex = specsizes.abu.years)
dev.off()

## ==== Diet ====
### On Patch level
NMDS.Bio.Diet.Patch <- as.data.frame(scores(NMDS.Bio.Diet, display="site"))
NMDS.Bio.Diet.Patch$Treatment <- ifelse(subbcDiet.bio$Year == 2018, "2018",
                                 ifelse(subbcDiet.bio$Year == 2019, "2019",       
                                 ifelse(subbcDiet.bio$Year == 2020, "2020",       
                                 ifelse(subbcDiet.bio$Year == 2021, "2021",       
                                 ifelse(subbcDiet.bio$Year == 2022, "2022",      
                                 ifelse(subbcDiet.bio$Year == 2023, "2023",
                                 ifelse(subbcDiet.bio$Year == 2024, "2024", "Other")))))))


Ordi.Diet.Patch <- ggplot(data = NMDS.Bio.Diet.Patch)+
    stat_ellipse(geom = "polygon", alpha = 0.1, aes(x = NMDS1, y = NMDS2, fill = Treatment),
                level = 0.6, size = 10)+ # Not an actual confidence ellipse, but matches that of ordiplot
    scale_fill_manual(values=co)+
    geom_point(aes(x = NMDS1,y = NMDS2, colour = Treatment), size= 2)+
    scale_color_manual(values=co)+
    scale_y_continuous(breaks = c(-1, 0, 1), limits = c(-1, 1))+
    scale_x_continuous(limits = c(-2, 2))+
    theme_bw()+
    theme(legend.text = element_text(size = 12),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.title.y = element_text(size = 14, face = "plain", vjust = 3),
          axis.text.y = element_text(size = 14, face = "bold", vjust = 0.4),
          axis.title.x = element_text(size = 14, face = "plain", vjust = -0.5),
          axis.text.x = element_text(size = 14, face = "bold", vjust = 0.5),
          legend.position="bottom",
          legend.title = element_blank(),
          plot.margin = margin(0, 0, 0.1, 0.5, "cm"))+
     guides(fill = guide_legend(nrow = 1))
leg <- get_legend(Ordi.Diet.Patch)
ggsave("Fish_Ordination diet_Patch_Biomass.tiff", width = 18, height = 10, units = "cm", dpi=1200, compression = "lzw")

#### On Species level
##### Adjust font size based on % of surveys in which a species is seen
specsizes.bio.diet <- subbcDiet.bio[,3:ncol(subbcDiet.bio)]
specsizes.bio.diet <- colSums(specsizes.bio.diet)
specsizes.bio.diet.min <- min(specsizes.bio.diet)
specsizes.bio.diet.max <- max(specsizes.bio.diet)
cex.bio.diet.min <- 1
cex.bio.diet.max <- 2
specsizes.bio.diet <- ((specsizes.bio.diet - specsizes.bio.diet.min)/(specsizes.bio.diet.max-specsizes.bio.diet.min)) * (cex.bio.diet.max - cex.bio.diet.min) + cex.bio.diet.min

##### Plot on Species level
##### For composite
cox.diet <- c(co, "#0673B0", "#0673B0", "#0673B0") 
pdf(NULL)
dev.control(displaylist="enable")
par(bg = 'white',   las=1, tck=-0.007, cex.axis=1.1, cex.lab = 1.1, font.axis = 2, mar=c(4.5, 4.2, 0.1, 0.2), 
    col.axis = "#464646")
ordiplot(NMDS.Bio.Diet, type="none",  cex = 0.3, ylim = c(-0.5, 0.5), xlim = c(-1.9, 2.2))
ordiellipse(NMDS.Bio.Diet, groups = subbcDiet.bio$Year, kind = "se", conf = 0.99, draw  ="polygon", 
            col = cox.diet, alpha = 50, label = F, lty = 'blank', border = "white")
ordipointlabel(NMDS.Bio.Diet, display = "species", scaling = "symmetric", add = TRUE,
               cex = specsizes.bio.diet, font = 3)
Ordi.Diet.Sp <- recordPlot()
invisible(dev.off())
Ordi.Diet.Sp <- plot_grid(Ordi.Diet.Sp) + theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))
ggsave("Fish_Ordination_Diet by group.tiff", width = 18, height = 12, units = "cm", dpi=1200, compression = "lzw", Ordi.Diet.Sp)

## ==== Composite ====
ORDI <- plot_grid(Ordi.Sp.Sp, Ordi.Diet.Patch,  nrow = 3, align = "v", rel_heights = c(1,1,1.3),
                  labels = c("A: Species", "B: Diet"),
                  hjust = c(-0.8, -1, -1.25), vjust = 1.6)
ggsave("Fish_Ordination_Compilation.tiff", width = 18, height = 24, units = "cm", dpi=1200, compression = "lzw", ORDI)

# TODO: remove large white space in between?!?
ORDI2 <- plot_grid(Ordi.Sp.Sp, Ordi.Diet.Sp,  leg,  nrow = 3,  rel_heights = c(1.2,0.8,0.1),
                  labels = c("A: Species", "B: Diet", ""), align = "hv", greedy = F,
                  hjust = c(-1, -1.6, 0), vjust = c(2, 2, 0))
ggsave("Fish_Ordination_Compilation2.tiff", width = 18, height = 24, units = "cm", dpi=1200, compression = "lzw", ORDI2)



##### High res Species plot
#tiff("Fish_Ordination species_Species_Biomass_Highres.tiff", width = 18, height = 14, units = "cm", res = 3500, compression = "lzw")
#Ordi.Sp.Sp
#dev.off()

```

### BC tables
```{r table}
# ---- TABLE WORD CODE ----
# create new word document
new.word.doc=function(){
  my.doc=read_docx()
  return(my.doc)
}

# add an empty line
add.empty.line=function(doc){
  body_add_par(doc, " ")
  return("empty line added")
}

# add a data frame as a table
add.table=function(doc, tbl, col.keys=NULL, col.digits=NULL){
  # create basic flextable
  f.table=qflextable(tbl)
  
  # set table borders
  f.table=border_inner_h(f.table, part="header", border=fp_border(color="black", width = 1))
  #f.table=border_inner_v(f.table, part="all", border=fp_border(color="black", width = 1))
  
  # set fonts
  f.table=flextable::font(f.table,  fontname = "Times", part = "all")
  # also set the table's header font as bold
  f.table=bold(f.table, part = "header")
  
  # add the table to the document
  flextable::body_add_flextable(doc, 
                                value = f.table, 
                                align = "left" )
  return("table added")
}

# SPECIES
doc=new.word.doc()
add.empty.line(doc)
add.table(doc, BCtable.Bio.Specs.tab)

# generate the Word document using the print function
base::print(doc, target="Fish_BC Table Species x Treatment.docx")

# DIET
doc=new.word.doc()
add.empty.line(doc)
add.table(doc, BCtable.Bio.Diet.tab)

# generate the Word document using the print function
base::print(doc, target="Fish_BC Table Diet x Treatment.docx")

```

# Ordination plots
```{r}

# ---- DATA PREP ----
## Make already a grouping, for Ordination analysis on Diet level
bioDiet <- spread(bio, key = Diet, value = Biomass_ha) # Make Diet section from long to wide
bioDiet <- bioDiet[,-c(3:5)] #Remove unnecessary columns
bioDiet[is.na(bioDiet)] <- 0
bioDiet <- merge(bioDiet, totsur, all.y=T) # Re-add surveys without observations
bioDiet[is.na(bioDiet)] <- 0
bioDiet <- aggregate(. ~ SurveyNo, data = bioDiet, FUN = sum) # Sum each Diet per Survey

```


# Figure compilation
```{r compilation}

# S, Abu and Bio
RAB <- plot_grid(Divplot, Bioplot,Abuplot, nrow = 3, align = "v", rel_heights = c(1,1,1.2),
                 labels = c("A", "B", "C"), label_size = 18)
ggsave("Fish_Richness and Abundance and Biomass.tiff", width = 18, height = 24, units = "cm", dpi=1200, compression = "lzw", RAB)


```

# Export for correlations
```{r export}

COR <- select(divsumsubtransmeans, c("Transect", "Year", "S"))
COR$Abundance <- abusumsubtransmeans$Abundance_m2
COR$Biomass <- biosumsubtransmeans$Biomass_ha

write_xlsx(COR, "Structural complexity_Fish surveys_2022-08_Averages per year.xlsx")

```